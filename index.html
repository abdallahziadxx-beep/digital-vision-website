<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>النظام المحاسبي لشركات الأدوية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        :root {
            --primary: #3b82f6; /* blue-500 */
            --secondary: #64748b; /* slate-500 */
            --success: #22c55e; /* green-500 */
            --danger: #ef4444; /* red-500 */
            --warning: #f97316; /* orange-500 */
            --info: #06b6d4; /* cyan-500 */
        --purple: #8b5cf6; /* violet-500 */
        }
        body { font-family: 'Tajawal', sans-serif; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); min-height: 100vh; }
        .card { @apply bg-white rounded-xl shadow-lg p-4 sm:p-6 border border-gray-200; transition: all 0.3s ease; }
        .btn { @apply px-4 py-2 sm:px-5 sm:py-2.5 rounded-xl font-bold transition-all duration-300 flex items-center justify-center gap-2; }
        .btn-primary { background-color: var(--primary); @apply text-white shadow-md hover:bg-blue-600; }
        .btn-secondary { background-color: var(--secondary); @apply text-white shadow-md hover:bg-slate-600; }
        .btn-success { background-color: var(--success); @apply text-white shadow-md hover:bg-green-600; }
        .btn-danger { background-color: var(--danger); @apply text-white shadow-md hover:bg-red-600; }
        .btn-warning { background-color: var(--warning); @apply text-white shadow-md hover:bg-orange-600; }
        .btn-info { background-color: var(--info); @apply text-white shadow-md hover:bg-cyan-600; }
        .btn-purchase { background-color: var(--purple); @apply text-white shadow-md hover:bg-violet-600; }
        .input, .select { @apply w-full border border-gray-300 rounded-xl px-4 py-3 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all; }
        .label { @apply text-sm text-gray-700 font-medium block mb-2 flex items-center gap-2; }
        .chip { @apply inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold; }
        .chip-success { @apply bg-green-100 text-green-800; }
        .chip-warning { @apply bg-yellow-100 text-yellow-800; }
        .chip-danger { @apply bg-red-100 text-red-800; }
        .chip-info { @apply bg-blue-100 text-blue-800; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 6px; }
        th, td { @apply px-3 py-3 text-sm; }
        th { @apply text-gray-700 font-bold bg-blue-50; }
        tbody tr { @apply bg-white rounded-lg shadow-sm transition-all hover:shadow-md; border-left: 4px solid transparent; }
        tbody tr:hover { border-left-color: var(--primary); transform: translateY(-2px); }
        .scroll { overflow-y: auto; }
        .summary-card { @apply bg-white rounded-xl shadow p-4 text-center border-t-4; transition: all 0.3s ease; }
        .summary-card:hover { transform: translateY(-5px); }
        .alert { @apply fixed bottom-5 right-5 z-50 p-4 rounded-xl shadow-lg text-white font-medium transition-all duration-300 transform; opacity: 0; transform: translateY(20px); max-width: 90vw; width: 350px; }
        .alert.show { opacity: 1; transform: translateY(0); }
        .alert.success { background-color: var(--success); }
        .alert.error { background-color: var(--danger); }
        .alert.warning { background-color: var(--warning); }
        .alert.info { background-color: var(--info); }
        .nav-tab { @apply flex items-center justify-center gap-2 py-3 px-4 rounded-xl font-medium transition-all duration-300; }
        .nav-tab.active { background-color: var(--primary); @apply text-white shadow-md; }
        .nav-tab:not(.active) { @apply bg-gray-100 text-gray-700 hover:bg-gray-200; }
        .tutorial-box { @apply bg-blue-50 border-l-4 border-blue-500 rounded-r-xl p-4 mb-6; }
        .tutorial-title { @apply text-blue-800 font-bold mb-2 flex items-center gap-2 text-lg; }
        .sub-nav { @apply flex flex-wrap items-center justify-center gap-2 bg-gray-100 p-2 rounded-xl; }
        .sub-nav-tab { @apply flex items-center justify-center gap-2 py-2 px-3 rounded-lg font-medium text-sm transition-all duration-300 text-gray-600 hover:bg-gray-200; }
        .sub-nav-tab.active { @apply bg-white text-blue-600 shadow; }
        .report-link { @apply block p-2 rounded-lg text-sm text-gray-700 hover:bg-blue-100 transition-colors duration-200; }
        .report-link.active { @apply bg-blue-500 text-white font-bold hover:bg-blue-500; }
        .report-link i { @apply mr-2 text-gray-500; }
        .report-link.active i { @apply text-white; }
        /* Report-specific table styles */
        #report-output table, #report-print-area table {
            border-spacing: 0;
            border-collapse: collapse;
        }
        #report-output tbody tr, #report-print-area tbody tr {
            background-color: transparent !important;
            box-shadow: none !important;
            border-radius: 0 !important;
            border-left-width: 0 !important;
            transition: none !important;
            transform: none !important;
        }
        #report-output tbody tr:hover, #report-print-area tbody tr:hover {
            border-left-width: 0 !important;
            transform: none !important;
            background-color: #f1f5f9 !important; /* slate-200 */
        }
        #report-output .table-bordered, #report-print-area .table-bordered { width: 100%; }
        #report-output .table-bordered th, #report-output .table-bordered td,
        #report-print-area .table-bordered th, #report-print-area .table-bordered td {
            border: 1px solid #cbd5e1; /* slate-300 */
            padding: 0.5rem;
        }
        #report-output .table-bordered th, #report-print-area .table-bordered th {
            background-color: #f1f5f9; /* slate-100 */
            font-weight: 700;
            color: #334155; /* slate-700 */
            text-align: right;
        }
        #report-output .table-bordered td, #report-print-area .table-bordered td { text-align: right; }
        #report-output .table-bordered td.font-mono, #report-output .table-bordered th.font-mono,
        #report-print-area .table-bordered td.font-mono, #report-print-area .table-bordered th.font-mono { text-align: left; }
        #report-output .table-bordered tbody tr:nth-child(even), #report-print-area .table-bordered tbody tr:nth-child(even) { background-color: #f8fafc !important; }
        #report-output .table-bordered tfoot, #report-print-area .table-bordered tfoot { background-color: #e2e8f0; font-weight: 700; }
        html, body {
            height: 100vh;
            overflow: hidden;
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        main {
            flex-grow: 1;
            overflow-y: auto;
        }
        @media print {
            body.is-printing > * {
                display: none !important;
            }
            body { background: #fff !important; }
            /* Only the active print area will be shown */
            .print-area { display: none !important; }
            .print-area.active-print { display: block !important; box-shadow: none !important; border: none !important; }
            .print-header { text-align: center; margin-bottom: 2rem; }
            .print-header h1 { font-size: 22pt; }
            .print-header p { font-size: 10pt; color: #555; }
            @page { size: A4; margin: 1cm; }
            html, body {
                height: auto !important;
                overflow: visible !important;
            }
            .scroll {
                overflow: visible !important;
                max-height: none !important;
            }
        }
        @media (max-width: 640px) { /* sm breakpoint */
            .hidden-mobile {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="app-container" class="max-w-7xl mx-auto p-3 sm:p-6">
        <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6 bg-white p-4 rounded-2xl shadow-lg">
            <div class="flex items-center gap-3">
                <div class="bg-blue-100 p-3 rounded-xl"><i class="fas fa-pills text-3xl text-blue-600"></i></div>
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">النظام المحاسبي لشركات الأدوية</h1>
                    <p class="text-gray-600 text-sm">محاسبة مبسطة لإدارة العملاء والعمليات المالية</p>
                </div>
            </div>
            <div class="flex flex-wrap gap-2">
                <button id="btnBackup" class="btn btn-info"><i class="fas fa-download"></i><span class="hidden-mobile">نسخ احتياطي</span></button>
                <label class="btn btn-warning cursor-pointer"><i class="fas fa-upload"></i><span class="hidden-mobile">استعادة</span><input id="restoreFile" type="file" class="hidden" /></label>
                <button id="btnReset" class="btn btn-danger"><i class="fas fa-trash"></i><span class="hidden-mobile">تهيئة</span></button>
            </div>
        </header>

        <div class="mb-6">
            <nav id="main-nav" class="flex flex-wrap items-center justify-center gap-2 mb-2 bg-white p-3 rounded-2xl shadow-md">
                <button data-group="dashboard" class="nav-tab active"><i class="fas fa-tachometer-alt"></i><span>الرئيسية</span></button>
                <button data-group="definitions" class="nav-tab"><i class="fas fa-book-open"></i><span>التعريفات</span></button>
                <button data-group="invoicing" class="nav-tab"><i class="fas fa-file-invoice"></i><span>الفواتير والقوائم</span></button>
                <button data-group="returns" class="nav-tab"><i class="fas fa-undo"></i><span>المرتجعات</span></button>
                <button data-group="financials" class="nav-tab"><i class="fas fa-money-check-alt"></i><span>الحركات المالية</span></button>
                <button data-group="inventory" class="nav-tab"><i class="fas fa-warehouse"></i><span>المخزون</span></button>
                <button data-group="inventory-management" class="nav-tab"><i class="fas fa-cogs"></i><span>إدارة المخزون</span></button>
                <button data-group="journal" class="nav-tab"><i class="fas fa-file-invoice-dollar"></i><span>اليومية</span></button>
                <button data-group="reports" class="nav-tab"><i class="fas fa-chart-bar"></i><span>التقارير</span></button>
                <button data-group="settings" class="nav-tab"><i class="fas fa-cog"></i><span>الإعدادات</span></button>
            </nav>
            <div id="sub-nav-container" class="mt-2">
                <div data-sub-nav-for="definitions" class="sub-nav hidden">
                    <button data-tab="customers" class="sub-nav-tab"><i class="fas fa-users fa-fw"></i><span>العملاء</span></button>
                    <button data-tab="suppliers" class="sub-nav-tab"><i class="fas fa-truck-loading fa-fw"></i><span>الموردين</span></button>
                    <button data-tab="items" class="sub-nav-tab"><i class="fas fa-capsules fa-fw"></i><span>الأصناف</span></button>
                    <button data-tab="chart" class="sub-nav-tab"><i class="fas fa-book fa-fw"></i><span>الدليل المحاسبي</span></button>
                </div>
                <div data-sub-nav-for="invoicing" class="sub-nav hidden">
                    <button data-tab="invoices" class="sub-nav-tab"><i class="fas fa-file-invoice fa-fw"></i><span>فاتورة بيع</span></button>
                    <button data-tab="purchases" class="sub-nav-tab"><i class="fas fa-receipt fa-fw"></i><span>فاتورة شراء</span></button>
                    <button data-tab="invoice-list" class="sub-nav-tab"><i class="fas fa-list-ul fa-fw"></i><span>قائمة المبيعات</span></button>
                    <button data-tab="purchase-list" class="sub-nav-tab"><i class="fas fa-list-alt fa-fw"></i><span>قائمة المشتريات</span></button>
                </div>
                <div data-sub-nav-for="returns" class="sub-nav hidden">
                    <button data-tab="sales-returns" class="sub-nav-tab"><i class="fas fa-undo"></i><span>مرتجع مبيعات</span></button>
                    <button data-tab="purchase-returns" class="sub-nav-tab"><i class="fas fa-truck-moving"></i><span>مرتجع مشتريات</span></button>
                </div>
                <div data-sub-nav-for="financials" class="sub-nav hidden">
                    <button data-tab="receipts" class="sub-nav-tab"><i class="fas fa-hand-holding-usd"></i><span>المقبوضات</span></button>
                    <button data-tab="payments" class="sub-nav-tab"><i class="fas fa-money-bill-wave"></i><span>المدفوعات</span></button>
                </div>
                <div data-sub-nav-for="inventory-management" class="sub-nav hidden">
                    <button data-tab="inventory-disbursement" class="sub-nav-tab"><i class="fas fa-dolly-flatbed fa-fw"></i><span>أمر صرف مخزني</span></button>
                    <button data-tab="bonus-invoice" class="sub-nav-tab"><i class="fas fa-gift fa-fw"></i><span>فاتورة بونص/تعويض</span></button>
                    <button data-tab="disbursement-list" class="sub-nav-tab"><i class="fas fa-list-alt fa-fw"></i><span>قائمة أوامر الصرف</span></button>
                </div>
            </div>
        </div>

        <main>
            <!-- Dashboard Panel -->
            <section id="panel-dashboard" class="card">
                <h2 class="text-xl font-bold text-gray-800 mb-6"><i class="fas fa-chart-line text-blue-500 mr-2"></i>نظرة عامة</h2>
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                    <div class="summary-card border-blue-500"><p class="text-sm text-gray-500 mb-1">صافي الربح</p><span id="kpi-net-profit" class="text-2xl font-bold text-blue-600">0.00</span></div>
                    <div class="summary-card border-green-500"><p class="text-sm text-gray-500 mb-1">إجمالي الإيرادات</p><span id="kpi-total-revenue" class="text-2xl font-bold text-green-600">0.00</span></div>
                    <div class="summary-card border-purple-500"><p class="text-sm text-gray-500 mb-1">إجمالي الأصول</p><span id="kpi-total-assets" class="text-2xl font-bold text-purple-600">0.00</span></div>
                    <div class="summary-card border-red-500"><p class="text-sm text-gray-500 mb-1">ديون العملاء</p><span id="kpi-total-due" class="text-2xl font-bold text-red-600">0.00</span></div>
                    <div class="summary-card border-yellow-500"><p class="text-sm text-gray-500 mb-1">صافي النقدية</p><span id="kpi-total-cash" class="text-2xl font-bold text-yellow-600">0.00</span></div>
                </div>
                <div class="grid lg:grid-cols-2 gap-6">
                    <div class="card p-4"><h3 class="font-bold mb-3 text-center text-gray-700">الإيرادات مقابل المصروفات</h3><canvas id="dashboardChart"></canvas></div>
                    <div class="card p-4"><h3 class="font-bold mb-4 text-gray-800"><i class="fas fa-history text-blue-500 mr-2"></i>أحدث القيود</h3><div id="dashboard-recent-journal" class="space-y-3 text-sm"></div></div>
                </div>
            </section>

            <!-- Customers Panel -->
            <section id="panel-customers" class="card hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-users text-blue-500 mr-2"></i>إدارة العملاء</h2>
                    <button id="btnShowAddCustomer" class="btn btn-primary"><i class="fas fa-plus"></i> إضافة عميل جديد</button>
                </div>
                <div class="tutorial-box">
                    <div class="tutorial-title"><i class="fas fa-info-circle text-yellow-500"></i> ملاحظة</div>
                    <p class="text-sm text-gray-700">عند إضافة عميل، يمكنك تركه ينشئ حساباً جديداً تلقائياً، أو يمكنك ربطه بحساب "مدينون" موجود مسبقاً من الدليل المحاسبي.</p>
                </div>
                <div id="formAddCustomer" class="card bg-gray-50 mb-6 hidden">
                    <h3 class="text-lg font-bold mb-3 text-gray-700">بيانات العميل الجديد</h3>
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <input id="customerName" class="input" placeholder="اسم العميل">
                        <input id="customerPhone" class="input" placeholder="رقم الهاتف">
                        <input id="customerAddress" class="input" placeholder="العنوان">
                    </div>
                    <div class="mb-4">
                        <label class="label">ربط بحساب محاسبي</label>
                        <select id="customerAccountLink" class="select"></select>
                        <p class="text-xs text-gray-500 mt-1">يمكنك ربط العميل بحساب موجود مسبقاً من نوع "مدينون" أو ترك الخيار لإنشاء حساب جديد له.</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="btnAddCustomer" class="btn btn-success hotkey-save"><i class="fas fa-check"></i> حفظ العميل (F9)</button>
                        <button id="btnCancelAddCustomer" type="button" class="btn btn-secondary hotkey-clear"><i class="fas fa-times"></i> إلغاء (F7)</button>
                    </div>
                </div>
                <div class="mb-4">
                    <input id="searchCustomers" class="input" placeholder="بحث بالاسم أو الهاتف أو العنوان...">
                </div>
                <div class="scroll"><table id="tblCustomers"><thead><tr><th>الاسم</th><th>الهاتف</th><th>العنوان</th><th>رقم الحساب</th><th class="w-24">الإجراءات</th></tr></thead><tbody></tbody></table></div>
            </section>

            <!-- Suppliers Panel -->
            <section id="panel-suppliers" class="card hidden">
                <div class="flex justify-between items-center mb-4 ">
                    <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-truck-loading text-blue-500 mr-2"></i>إدارة الموردين</h2>
                    <button id="btnShowAddSupplier" class="btn btn-primary"><i class="fas fa-plus"></i> إضافة مورد جديد</button>
                </div>
                <div class="tutorial-box">
                    <div class="tutorial-title"><i class="fas fa-info-circle text-yellow-500"></i> ملاحظة</div>
                    <p class="text-sm text-gray-700">عند إضافة مورد، يمكنك ربطه بحساب "دائنون" موجود مسبقاً أو ترك النظام ينشئ له حساباً جديداً.</p>
                </div>
                <div id="formAddSupplier" class="card bg-gray-50 mb-6 hidden">
                    <h3 class="text-lg font-bold mb-3 text-gray-700">بيانات المورد الجديد</h3>
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <input id="supplierName" class="input" placeholder="اسم المورد">
                        <input id="supplierPhone" class="input" placeholder="رقم الهاتف">
                        <input id="supplierAddress" class="input" placeholder="العنوان">
                    </div>
                    <div class="mb-4">
                        <label class="label">ربط بحساب محاسبي</label>
                        <select id="supplierAccountLink" class="select"></select>
                    </div>
                    <div class="flex gap-2">
                        <button id="btnAddSupplier" class="btn btn-success hotkey-save"><i class="fas fa-check"></i> حفظ المورد (F9)</button>
                        <button id="btnCancelAddSupplier" type="button" class="btn btn-secondary hotkey-clear"><i class="fas fa-times"></i> إلغاء (F7)</button>
                    </div>
                </div>
                <div class="mb-4">
                    <input id="searchSuppliers" class="input" placeholder="بحث بالاسم أو الهاتف أو العنوان...">
                </div>
                <div class="scroll"><table id="tblSuppliers"><thead><tr><th>الاسم</th><th>الهاتف</th><th>العنوان</th><th>رقم الحساب</th><th class="w-24">الإجراءات</th></tr></thead><tbody></tbody></table></div>
            </section>

            <!-- Items Panel -->
            <section id="panel-items" class="card hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-capsules text-blue-500 mr-2"></i>إدارة الأصناف الدوائية</h2>
                    <button id="btnShowAddItem" class="btn btn-primary"><i class="fas fa-plus"></i> إضافة صنف جديد</button>
                </div>
                <div id="formAddItem" class="card bg-gray-50 mb-6 hidden">
                    <h3 class="text-lg font-bold mb-3 text-gray-700">بيانات الصنف الجديد</h3>
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <input id="itemName" class="input" placeholder="اسم الصنف التجاري">
                        <input id="itemScientificName" class="input" placeholder="الاسم العلمي (اختياري)">
                        <input id="itemUnit" class="input" placeholder="وحدة القياس (علبة، شريط)">
                    </div>
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <input id="itemPurchasePrice" type="number" class="input" placeholder="سعر الشراء الافتراضي">
                        <input id="itemSellPrice" type="number" class="input" placeholder="سعر البيع">
                        <div>
                            <label class="label">تاريخ الانتهاء (اختياري)</label>
                            <input id="itemExpiryDate" type="date" class="input">
                        </div>
                    </div>
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="label">نسبة البونص (آجل)</label>
                            <input id="itemBonusRatioCredit" type="number" class="input" placeholder="مثال: 10">
                            <p class="text-xs text-gray-500 mt-1">أدخل 10 للحصول على 1 مجاناً لكل 10 مباعة.</p>
                        </div>
                        <div>
                            <label class="label">نسبة البونص (نقدي)</label>
                            <input id="itemBonusRatioCash" type="number" class="input" placeholder="مثال: 7">
                            <p class="text-xs text-gray-500 mt-1">أدخل 7 للحصول على 1 مجاناً لكل 7 مباعة.</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="btnAddItem" class="btn btn-success hotkey-save"><i class="fas fa-check"></i> حفظ الصنف (F9)</button>
                        <button id="btnCancelAddItem" type="button" class="btn btn-secondary hotkey-clear"><i class="fas fa-times"></i> إلغاء (F7)</button>
                    </div>
                </div>
                <div class="mb-4">
                    <input id="searchItems" class="input" placeholder="بحث بالاسم التجاري أو العلمي...">
                </div>
                <div class="scroll"><table id="tblItems"><thead><tr><th>الاسم التجاري</th><th>سعر البيع</th><th>الكمية</th><th>بونص آجل</th><th>بونص نقدي</th><th>تاريخ الانتهاء</th><th class="w-32">الإجراءات</th></tr></thead><tbody></tbody></table></div>
            </section>

            <!-- Invoices Panel -->
            <section id="panel-invoices" class="card hidden">
                <h2 class="text-xl font-bold text-green-600 mb-4"><i class="fas fa-file-invoice mr-2"></i>فاتورة بيع جديدة</h2>
                <div class="card bg-gray-50 p-4">
                    <div class="grid md:grid-cols-4 gap-4 mb-4">
                        <div><label class="label">العميل</label><select id="invoiceCustomer" class="select"></select></div>
                        <div><label class="label">نوع الفاتورة</label>
                            <select id="invoiceType" class="select">
                                <option value="credit">آجل</option>
                                <option value="cash-pending">نقدي معلق</option>
                                <option value="cash">نقدي</option>
                            </select>
                        </div>
                        <div><label class="label">التاريخ</label><input id="invoiceDate" type="date" class="input" /></div>
                        <div><label class="label">ملاحظات</label><input id="invoiceNotes" class="input" placeholder="اختياري" /></div>
                    </div>
                    <hr class="my-4">
                    <h3 class="font-bold mb-2">أصناف الفاتورة</h3>
                    <div class="grid grid-cols-12 gap-2 items-end mb-3">
                        <div class="col-span-5"><label class="label" for="invoiceItem">الصنف</label><select id="invoiceItem" class="select"></select></div>
                        <div class="col-span-2">
                            <div class="flex justify-between items-center"><label for="invoiceQty" class="label mb-0">الكمية</label><small id="invoiceItemAvailableQty" class="text-xs text-gray-500"></small></div>
                            <input id="invoiceQty" type="number" value="1" class="input mt-1">
                        </div>
                        <div class="col-span-2"><label class="label">السعر</label><input id="invoicePrice" type="number" class="input" readonly></div>
                        <div class="col-span-3"><button id="btnAddInvoiceItem" class="btn btn-info w-full hotkey-action"><i class="fas fa-plus"></i> إضافة (F8)</button></div>
                    </div>
                    <div class="scroll max-h-48 mb-4">
                        <table id="tblInvoiceItems">
                            <thead><tr><th>الصنف</th><th>الكمية</th><th>السعر</th><th>الإجمالي</th><th class="w-16"></th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="label">الخصم النقدي</label>
                            <input id="invoiceDiscount" type="number" class="input" placeholder="0.00">
                        </div>
                        <div class="text-right">
                            <p class="text-gray-600">الإجمالي قبل الخصم: <span id="invoiceSubtotal" class="font-bold">0.00</span></p>
                            <p class="text-red-600">الخصم: <span id="invoiceDiscountDisplay" class="font-bold">0.00</span></p>
                            <p class="text-blue-600 text-lg font-bold">الإجمالي النهائي: <span id="invoiceTotal" class="font-bold">0.00</span></p>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button id="btnSaveInvoice" class="btn btn-success hotkey-save"><i class="fas fa-save"></i> حفظ الفاتورة (F9)</button>
                        <button id="btnClearInvoice" class="btn btn-secondary hotkey-clear"><i class="fas fa-eraser"></i> فاتورة جديدة (F7)</button>
                    </div>
                </div>
            </section>

            <!-- Purchases Panel -->
            <section id="panel-purchases" class="card hidden">
                <h2 class="text-xl font-bold text-violet-600 mb-4"><i class="fas fa-receipt mr-2"></i>فاتورة شراء جديدة</h2>
                <div class="card bg-gray-50 p-4">
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div><label class="label">المورد</label><select id="purchaseSupplier" class="select"></select></div>
                        <div><label class="label">التاريخ</label><input id="purchaseDate" type="date" class="input" /></div>
                        <div><label class="label">ملاحظات</label><input id="purchaseNotes" class="input" placeholder="اختياري" /></div>
                    </div>
                    <hr class="my-4">
                    <h3 class="font-bold mb-2">أصناف الفاتورة</h3>
                    <div class="grid grid-cols-12 gap-2 items-end mb-3">
                        <div class="col-span-4"><label class="label">الصنف</label><select id="purchaseItem" class="select"></select></div>
                        <div class="col-span-2"><label class="label">الكمية</label><input id="purchaseQty" type="number" value="1" class="input"></div>
                        <div class="col-span-2"><label class="label">سعر الشراء</label><input id="purchasePrice" type="number" class="input"></div>
                        <div class="col-span-2"><label class="label">تاريخ الإنتاج</label><input id="purchaseProdDate" type="date" class="input"></div>
                        <div class="col-span-2"><label class="label">تاريخ الانتهاء</label><input id="purchaseExpDate" type="date" class="input"></div>
                    </div>
                    <div class="flex justify-end mb-3">
                        <button id="btnAddPurchaseItem" class="btn btn-info w-full md:w-1/4 hotkey-action"><i class="fas fa-plus"></i> إضافة (F8)</button>
                    </div>
                    <div class="scroll max-h-48 mb-4">
                        <table id="tblPurchaseItems">
                            <thead><tr><th>الصنف</th><th>الكمية</th><th>السعر</th><th>ت. الإنتاج</th><th>ت. الانتهاء</th><th>الإجمالي</th><th class="w-16"></th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="flex justify-end items-center gap-4 text-lg font-bold">
                        <span>الإجمالي:</span>
                        <span id="purchaseTotal" class="text-violet-600">0.00</span>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button id="btnSavePurchase" class="btn btn-success hotkey-save"><i class="fas fa-save"></i> حفظ (F9)</button>
                        <button id="btnClearPurchase" class="btn btn-secondary hotkey-clear"><i class="fas fa-eraser"></i> جديد (F7)</button>
                    </div>
                </div>
            </section>

            <!-- Inventory Panel -->
            <section id="panel-inventory" class="card hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-warehouse text-blue-500 mr-2"></i>إدارة المخزون</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="summary-card border-blue-500"><p class="text-sm text-gray-500 mb-1">عدد الأصناف</p><span id="kpi-item-count" class="text-2xl font-bold text-blue-600">0</span></div>
                    <div class="summary-card border-green-500"><p class="text-sm text-gray-500 mb-1">قيمة المخزون (بسعر البيع)</p><span id="kpi-inventory-value" class="text-2xl font-bold text-green-600">0.00</span></div>
                    <div class="summary-card border-yellow-500"><p class="text-sm text-gray-500 mb-1">أصناف على وشك النفاذ</p><span id="kpi-low-stock" class="text-2xl font-bold text-yellow-600">0</span></div>
                    <div class="summary-card border-red-500"><p class="text-sm text-gray-500 mb-1">أصناف منتهية/قريبة الانتهاء</p><span id="kpi-expired-stock" class="text-2xl font-bold text-red-600">0</span></div>
                </div>
                <div class="scroll"><table id="tblInventory"><thead><tr><th>الصنف</th><th>الكمية الحالية</th><th>تاريخ الانتهاء</th><th>سعر البيع</th></tr></thead><tbody></tbody></table></div>
            </section>

            <!-- Inventory Disbursement Panel -->
            <section id="panel-inventory-disbursement" class="card hidden">
                <h2 class="text-xl font-bold text-purple-600 mb-4"><i class="fas fa-dolly-flatbed mr-2"></i>أمر صرف مخزني (عينات، تالف، ...)</h2>
                <div class="card bg-gray-50 p-4">
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div><label class="label">التاريخ</label><input id="disbursementDate" type="date" class="input" /></div>
                        <div class="md:col-span-2"><label class="label">البيان / الغرض من الصرف</label><input id="disbursementNotes" class="input" placeholder="مثال: عينات مجانية للمندوب..." /></div>
                    </div>
                    <hr class="my-4">
                    <h3 class="font-bold mb-2">الأصناف المصروفة</h3>
                    <div class="grid grid-cols-12 gap-2 items-end mb-3">
                        <div class="col-span-6"><label class="label">الصنف</label><select id="disbursementItem" class="select"></select></div>
                        <div class="col-span-3"><label class="label">الكمية</label><input id="disbursementQty" type="number" value="1" class="input"></div>
                        <div class="col-span-3"><button id="btnAddDisbursementItem" class="btn btn-info w-full hotkey-action"><i class="fas fa-plus"></i> إضافة (F8)</button></div>
                    </div>
                    <div class="scroll max-h-48 mb-4">
                        <table id="tblDisbursementItems">
                            <thead><tr><th>الصنف</th><th>الكمية</th><th class="w-16"></th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="flex gap-2 mt-6"><button id="btnSaveDisbursement" class="btn btn-success hotkey-save"><i class="fas fa-save"></i> حفظ الأمر (F9)</button><button id="btnClearDisbursement" class="btn btn-secondary hotkey-clear"><i class="fas fa-eraser"></i> جديد (F7)</button></div>
                </div>
            </section>

            <!-- Disbursement List Panel -->
            <section id="panel-disbursement-list" class="card hidden">
                <h2 class="text-xl font-bold text-purple-600 mb-4"><i class="fas fa-list-alt mr-2"></i>قائمة أوامر الصرف المخزني</h2>
                <div class="mb-4">
                    <input id="searchDisbursements" class="input" placeholder="بحث بالبيان أو رقم الأمر...">
                </div>
                <div class="scroll"><table id="tblDisbursementList">
                    <thead><tr>
                        <th>رقم الأمر</th>
                        <th>التاريخ</th>
                        <th>البيان / الغرض</th>
                        <th class="w-24">الإجراءات</th>
                    </tr></thead>
                    <tbody></tbody>
                </table></div>
            </section>

            <!-- Invoice List Panel -->
            <section id="panel-invoice-list" class="card hidden">
                <h2 class="text-xl font-bold text-green-600 mb-4"><i class="fas fa-list-ul mr-2"></i>قائمة المبيعات</h2>
                <div class="mb-4">
                    <input id="searchInvoices" class="input" placeholder="بحث برقم الفاتورة أو اسم العميل...">
                </div>
                <div class="scroll"><table id="tblInvoices">
                    <thead><tr>
                        <th>رقم الفاتورة</th>
                        <th>التاريخ</th>
                        <th>العميل</th>
                        <th>النوع</th>
                        <th class="font-mono">الإجمالي قبل الخصم</th>
                        <th class="font-mono">الخصم</th>
                        <th class="font-mono">الإجمالي النهائي</th>
                        <th>المدفوع</th>
                        <th>المتبقي</th>
                        <th class="w-48">الإجراءات</th>
                    </tr></thead>
                    <tbody></tbody>
                    <tfoot></tfoot>
                </table></div>
            </section>

            <!-- Sales Returns Panel -->
            <section id="panel-sales-returns" class="card hidden">
                <h2 class="text-xl font-bold text-orange-500 mb-4"><i class="fas fa-undo mr-2"></i>مرتجع مبيعات</h2>
                <div class="card bg-gray-50 p-4 mb-6">
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div><label class="label">العميل</label><select id="returnCustomer" class="select"></select></div>
                        <div><label class="label">فاتورة البيع الأصلية</label><select id="returnInvoice" class="select"></select></div>
                        <div><label class="label">تاريخ الإرجاع</label><input id="returnDate" type="date" class="input" /></div>
                    </div>
                    <hr class="my-4">
                    <h3 class="font-bold mb-2">الأصناف المرتجعة</h3>
                    <div class="scroll max-h-48 mb-4">
                        <table id="tblReturnItems">
                            <thead><tr><th>الصنف</th><th>الكمية المباعة</th><th>الكمية المرتجعة</th><th>السعر</th><th>الإجمالي</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="flex justify-between items-center">
                        <button id="btnSaveSalesReturn" class="btn btn-success hotkey-save"><i class="fas fa-save"></i> حفظ المرتجع (F9)</button>
                        <div class="flex items-center gap-4 text-lg font-bold">
                            <span>إجمالي المرتجع:</span>
                            <span id="salesReturnTotal" class="text-red-600">0.00</span>
                        </div>
                    </div>
                </div>
                <h2 class="text-xl font-bold text-orange-500 my-4"><i class="fas fa-history mr-2"></i>سجل مرتجعات المبيعات</h2>
                <div class="scroll"><table id="tblSalesReturnsList">
                    <thead><tr><th>التاريخ</th><th>العميل</th><th>الفاتورة الأصلية</th><th>الإجمالي</th><th class="w-24">الإجراءات</th></tr></thead>
                    <tbody></tbody>
                </table></div>
            </section>

            <!-- Purchase List Panel -->
            <section id="panel-purchase-list" class="card hidden">
                <h2 class="text-xl font-bold text-violet-600 mb-4"><i class="fas fa-list-alt mr-2"></i>قائمة فواتير الشراء</h2>
                <div class="mb-4">
                    <input id="searchPurchases" class="input" placeholder="بحث برقم الفاتورة أو اسم المورد...">
                </div>
                <div class="scroll"><table id="tblPurchaseList">
                    <thead><tr>
                        <th>رقم الفاتورة</th>
                        <th>التاريخ</th>
                        <th>المورد</th>
                        <th>الإجمالي</th>
                        <th>المتبقي</th>
                        <th class="w-48">الإجراءات</th>
                    </tr></thead>
                    <tbody></tbody>
                </table></div>
            </section>

            <!-- Purchase Returns Panel -->
            <section id="panel-purchase-returns" class="card hidden">
                <h2 class="text-xl font-bold text-orange-500 mb-4"><i class="fas fa-truck-moving mr-2"></i>مرتجع مشتريات</h2>
                <div class="card bg-gray-50 p-4 mb-6">
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div><label class="label">المورد</label><select id="purchaseReturnSupplier" class="select"></select></div>
                        <div><label class="label">فاتورة الشراء الأصلية</label><select id="purchaseReturnInvoice" class="select"></select></div>
                        <div><label class="label">تاريخ الإرجاع</label><input id="purchaseReturnDate" type="date" class="input" /></div>
                    </div>
                    <hr class="my-4">
                    <h3 class="font-bold mb-2">الأصناف المرتجعة</h3>
                    <div class="scroll max-h-48 mb-4"><table id="tblPurchaseReturnItems"><thead><tr><th>الصنف</th><th>الكمية المشتراة</th><th>كمية الإرجاع</th><th>السعر</th><th>الإجمالي</th></tr></thead><tbody></tbody></table></div>
                    <div class="flex justify-between items-center">
                        <button id="btnSavePurchaseReturn" class="btn btn-success hotkey-save"><i class="fas fa-save"></i> حفظ المرتجع (F9)</button>
                        <div class="flex items-center gap-4 text-lg font-bold"><span>إجمالي المرتجع:</span><span id="purchaseReturnTotal" class="text-red-600">0.00</span></div>
                    </div>
                </div>
                <h2 class="text-xl font-bold text-orange-500 my-4"><i class="fas fa-history mr-2"></i>سجل مرتجعات المشتريات</h2>
                <div class="scroll"><table id="tblPurchaseReturnsList"><thead><tr><th>التاريخ</th><th>المورد</th><th>الفاتورة الأصلية</th><th>الإجمالي</th><th class="w-24">الإجراءات</th></tr></thead><tbody></tbody></table></div>
            </section>

            <!-- Payments Panel -->
            <section id="panel-payments" class="card hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-red-600"><i class="fas fa-money-bill-wave mr-2"></i>إضافة مدفوعات (سند صرف)</h2>
                    <button id="btnShowAddPayment" class="btn btn-primary"><i class="fas fa-plus"></i> إضافة صرف جديد</button>
                </div>
                <div id="formAddPayment" class="card bg-gray-50 mb-6 hidden">
                    <h3 class="text-lg font-bold mb-3 text-gray-700">بيانات سند الصرف</h3>
                    <div class="grid md:grid-cols-4 gap-4 items-end">
                        <div><label class="label">التاريخ</label><input id="paymentDate" type="date" class="input"></div>
                        <div><label class="label">المورد</label><select id="paymentSupplier" class="select"></select></div>
                        <div><label class="label">فاتورة الشراء المستحقة</label><select id="paymentPurchaseInvoice" class="select"></select></div>
                        <div><label class="label">المبلغ المدفوع</label><input id="paymentAmount" type="number" class="input" placeholder="0.00"></div>
                    </div>
                    <div class="mt-4">
                        <label class="label">البيان / ملاحظات</label>
                        <input id="paymentDesc" class="input" placeholder="مثال: سداد دفعة من فاتورة شراء...">
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button id="btnAddPayment" class="btn btn-success hotkey-save"><i class="fas fa-save"></i> حفظ السند (F9)</button>
                        <button id="btnCancelAddPayment" type="button" class="btn btn-secondary hotkey-clear"><i class="fas fa-times"></i> إلغاء (F7)</button>
                    </div>
                </div>
                <h2 class="text-xl font-bold text-red-600 my-4"><i class="fas fa-list-alt mr-2"></i>سجل المدفوعات</h2>
                <div class="scroll"><table id="tblPayments">
                    <thead><tr>
                        <th>التاريخ</th>
                        <th>المورد</th>
                        <th>المبلغ</th>
                        <th>الفاتورة المرتبطة</th>
                        <th>البيان</th>
                        <th class="w-24">الإجراءات</th>
                    </tr></thead>
                    <tbody></tbody>
                </table></div>
            </section>

            <!-- Receipts Panel -->
            <section id="panel-receipts" class="card hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-green-600"><i class="fas fa-hand-holding-usd mr-2"></i>إضافة مقبوضات</h2>
                    <button id="btnShowAddReceipt" class="btn btn-primary"><i class="fas fa-plus"></i> إضافة قبض جديد</button>
                </div>
                <div id="formAddReceipt" class="card bg-gray-50 mb-6 hidden">
                    <h3 class="text-lg font-bold mb-3 text-gray-700">بيانات القبض</h3>
                    <div class="grid md:grid-cols-4 gap-4 items-end">
                        <div><label class="label">التاريخ</label><input id="receiptDate" type="date" class="input"></div>
                        <div><label class="label">العميل</label><select id="receiptCustomer" class="select"></select></div>
                        <div><label class="label">الفاتورة المستحقة</label><select id="receiptInvoice" class="select"></select></div>
                        <div><label class="label">المبلغ المقبوض</label><input id="receiptAmount" type="number" class="input" placeholder="0.00"></div>
                    </div>
                    <div class="mt-4">
                        <label class="label">البيان / ملاحظات</label>
                        <input id="receiptDesc" class="input" placeholder="مثال: تحصيل دفعة من فاتورة...">
                    </div>
                    <div class="mt-4">
                        <label for="addToCollector" class="flex items-center cursor-pointer">
                            <input type="checkbox" id="addToCollector" class="rounded border-gray-300 text-blue-600 shadow-sm focus:ring-blue-500">
                            <span class="mr-2 text-gray-700">إضافة هذا القبض إلى نسبة المحصل</span>
                        </label>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button id="btnAddReceipt" class="btn btn-success hotkey-save"><i class="fas fa-save"></i> حفظ القبض (F9)</button>
                        <button id="btnCancelAddReceipt" type="button" class="btn btn-secondary hotkey-clear"><i class="fas fa-times"></i> إلغاء (F7)</button>
                    </div>
                </div>
                <h2 class="text-xl font-bold text-green-600 my-4"><i class="fas fa-list-alt mr-2"></i>سجل المقبوضات</h2>
                <div class="scroll"><table id="tblReceipts">
                    <thead><tr>
                        <th>التاريخ</th>
                        <th>العميل</th>
                        <th>المبلغ</th>
                        <th>الفاتورة المرتبطة</th>
                        <th>البيان</th>
                        <th class="w-24">الإجراءات</th>
                    </tr></thead>
                    <tbody></tbody>
                </table></div>
            </section>

            <!-- Journal Panel -->
            <section id="panel-journal" class="card hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-file-invoice-dollar text-blue-500 mr-2"></i>إدخال قيد يومية</h2>
                <div class="grid md:grid-cols-4 gap-4">
                    <div><label class="label">التاريخ</label><input id="jDate" type="date" class="input" /></div>
                    <div class="md:col-span-2"><label class="label">البيان</label><input id="jDesc" class="input" placeholder="مثال: فاتورة مبيعات للعميل..." /></div>
                    <div><label class="label">العملة</label><select id="jCurr" class="select"><option value="YER">YER</option></select></div>
                </div>
                <div class="grid md:grid-cols-2 gap-4 mt-4">
                    <div><label class="label text-red-600">مدين (Debit)</label><select id="jDebit" class="select"></select></div>
                    <div><label class="label text-green-600">دائن (Credit)</label><select id="jCredit" class="select"></select></div>
                </div>
                <div class="grid md:grid-cols-2 gap-4 mt-4">
                    <div><label class="label">المبلغ</label><input id="jAmount" type="number" step="0.01" class="input" placeholder="0.00" /></div>
                    <div><label class="label">العميل (اختياري)</label><select id="jCustomer" class="select"><option value="">-- لا يوجد --</option></select></div>
                </div>
                <div class="flex flex-wrap gap-2 mt-6">
                    <button id="btnAddEntry" class="btn btn-success hotkey-save"><i class="fas fa-save"></i> إضافة القيد (F9)</button>
                    <button id="btnQuickInvoice" class="btn btn-primary"><i class="fas fa-file-invoice"></i> فاتورة مبيعات سريعة</button>
                    <button id="btnQuickPayment" class="btn btn-info"><i class="fas fa-hand-holding-usd"></i> تحصيل دفعة سريعة</button>
                </div>
                <hr class="my-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-list-alt text-blue-500 mr-2"></i>دفتر اليومية</h2>
                <div class="scroll">
                    <table id="tblJournal">
                        <thead><tr><th>التاريخ</th><th class="w-1/3">البيان</th><th>مدين</th><th>دائن</th><th>المبلغ</th><th class="w-24">الإجراءات</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Chart of Accounts Panel -->
            <section id="panel-chart" class="card hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-book text-blue-500 mr-2"></i>الدليل المحاسبي</h2>
                    <button id="btnShowAddAcc" class="btn btn-primary"><i class="fas fa-plus"></i> إضافة حساب جديد</button>
                </div>
                <div id="formAddAcc" class="card bg-gray-50 mb-6 hidden">
                    <h3 class="text-lg font-bold mb-3 text-gray-700">بيانات الحساب الجديد</h3>
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="label"><i class="fas fa-hashtag text-gray-500"></i> رقم الحساب</label>
                            <input id="accNo" class="input" placeholder="مثال: 1101" />
                        </div>
                        <div>
                            <label class="label"><i class="fas fa-signature text-gray-500"></i> اسم الحساب</label>
                            <input id="accName" class="input" placeholder="مثال: الصندوق الرئيسي" />
                        </div>
                        <div>
                            <label class="label"><i class="fas fa-tag text-gray-500"></i> التصنيف</label>
                            <select id="accType" class="select">
                                <option value="asset">أصل</option><option value="liability">التزام</option>
                                <option value="equity">حقوق ملكية</option><option value="income">إيراد</option>
                                <option value="expense">مصروف</option><option value="cash">صندوق/نقدية</option>
                                <option value="receivable">مدينون (أصل)</option><option value="payable">دائنون (التزام)</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="btnAddAcc" class="btn btn-success hotkey-save"><i class="fas fa-check"></i> حفظ الحساب (F9)</button>
                        <button id="btnCancelAddAcc" type="button" class="btn btn-secondary hotkey-clear"><i class="fas fa-times"></i> إلغاء (F7)</button>
                    </div>
                </div>
                <div class="scroll">
                    <table id="tblChart">
                        <thead><tr><th>الرقم</th><th>الاسم</th><th>التصنيف</th><th class="w-24">الإجراءات</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Reports Panel -->
            <section id="panel-reports" class="card hidden">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-chart-pie text-blue-500 mr-2"></i>مركز التقارير</h2>
                    <button id="btnPrintReport" class="btn btn-info"><i class="fas fa-print"></i> طباعة التقرير</button>
                </div>
            
                <div class="grid grid-cols-12 gap-6">
                    <!-- Report List (Sidebar) -->
                    <nav id="reports-nav" class="col-span-12 md:col-span-3 bg-gray-50 p-4 rounded-xl border">
                        <div class="space-y-4">
                            <div>
                                <label class="label">من تاريخ</label>
                                <input type="date" id="report-from-date" class="input">
                            </div>
                            <div>
                                <label class="label">إلى تاريخ</label>
                                <input type="date" id="report-to-date" class="input">
                            </div>
                        </div>
                        <hr class="my-4">
                        <div id="report-item-selector-container" class="space-y-4 hidden">
                            <div>
                                <label class="label">اختر الصنف</label>
                                <select id="report-item-selector" class="input"></select>
                            </div>
                        </div>
                        <div id="report-commission-rate-container" class="space-y-4 hidden">
                            <div>
                                <label class="label">نسبة المحصل (%)</label>
                                <input type="number" id="report-commission-rate" class="input" value="1">
                            </div>
                        </div>
                        <hr class="my-4">
                        <div class="space-y-4">
                            <div>
                                <h3 class="font-bold text-gray-600 mb-2 text-sm uppercase tracking-wider">تحليل المبيعات</h3>
                                <ul class="space-y-1">
                                    <li><a href="#" class="report-link" data-report="sales_summary">ملخص المبيعات</a></li>
                                    <li><a href="#" class="report-link" data-report="sales_detailed">المبيعات التفصيلي</a></li>
                                    <li><a href="#" class="report-link" data-report="sales_by_type">المبيعات حسب النوع</a></li>
                                    <li><a href="#" class="report-link" data-report="best_selling_items">الأصناف الأكثر مبيعاً</a></li>
                                    <li><a href="#" class="report-link" data-report="least_selling_items">الأصناف الأقل مبيعاً</a></li>
                                    <li><a href="#" class="report-link" data-report="item_profitability">تقرير ربحية الأصناف</a></li>
                                    <li><a href="#" class="report-link" data-report="discounts_bonus_analysis">تحليل الخصومات والبونص</a></li>
                                    <li><a href="#" class="report-link" data-report="returns_summary">ملخص المرتجعات</a></li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-600 mt-4 mb-2 text-sm uppercase tracking-wider">تحليل العملاء</h3>
                                <ul class="space-y-1">
                                    <li><a href="#" class="report-link" data-report="customer_balances">أرصدة العملاء</a></li>
                                    <li><a href="#" class="report-link" data-report="aging_receivables">أعمار ديون العملاء</a></li>
                                    <li><a href="#" class="report-link" data-report="customer_value_analysis">تحليل قيمة العملاء</a></li>
                                    <li><a href="#" class="report-link" data-report="collector_commission">تقرير نسبة المحصلين (إجمالي)</a></li>
                                    <li><a href="#" class="report-link" data-report="collector_receipts_detail">تقرير مقبوضات المحصل (تفصيلي)</a></li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-600 mt-4 mb-2 text-sm uppercase tracking-wider">التقارير المالية</h3>
                                <ul class="space-y-1">
                                    <li><a href="#" class="report-link" data-report="invoice_status">حالة الفواتير وسدادها</a></li>
                                    <li><a href="#" class="report-link" data-report="cash_flow">حركة الصندوق</a></li>
                                    <li><a href="#" class="report-link" data-report="income_statement">قائمة الدخل (أرباح وخسائر)</a></li>
                                    <li><a href="#" class="report-link" data-report="balance_sheet">الميزانية العمومية</a></li>
                                    <li><a href="#" class="report-link" data-report="statement_of_cash_flows">قائمة التدفقات النقدية</a></li>
                                    <li><a href="#" class="report-link" data-report="receipts_payments_summary">ملخص المقبوضات والمدفوعات</a></li>
                                    <li><a href="#" class="report-link" data-report="supplier_balances">أرصدة الموردين</a></li>
                                    <li><a href="#" class="report-link" data-report="purchases_summary">ملخص المشتريات</a></li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-600 mt-4 mb-2 text-sm uppercase tracking-wider">تقارير المخزون</h3>
                                <ul class="space-y-1">
                                    <li><a href="#" class="report-link" data-report="inventory_status">حالة المخزون الحالية</a></li>
                                    <li><a href="#" class="report-link" data-report="inventory_expiry">تقرير صلاحية الأصناف</a></li>
                                    <li><a href="#" class="report-link" data-report="item_movement">حركة صنف</a></li>
                                    <li><a href="#" class="report-link" data-report="samples_report">تقرير العينات والصرف المخزني</a></li>
                                </ul>
                            </div>
                        </div>
                    </nav>
            
                    <!-- Report Content -->
                    <div id="report-output" class="col-span-12 md:col-span-9 bg-white p-4 rounded-xl border scroll" style="max-height: 75vh;">
                        <div class="text-center text-gray-500 py-16 h-full flex flex-col justify-center items-center">
                            <i class="fas fa-file-alt text-5xl mb-4 text-gray-300"></i>
                            <h3 class="text-lg font-bold text-gray-600">مرحباً بك في مركز التقارير</h3>
                            <p>الرجاء اختيار تقرير من القائمة الجانبية لعرضه هنا.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Panel -->
            <section id="panel-settings" class="card hidden">
                <h2 class="text-xl font-bold mb-4 text-gray-800"><i class="fas fa-cog text-blue-500 mr-2"></i>الإعدادات</h2>
                <div class="grid lg:grid-cols-2 gap-6">
                    <!-- Column 1 -->
                    <div class="space-y-6">
                        <div class="card p-4">
                            <h3 class="text-lg font-bold mb-4">بيانات الشركة</h3>
                            <div class="space-y-4">
                                <div><label class="label">اسم الشركة</label><input id="settingCompanyName" class="input"></div>
                                <div><label class="label">عنوان الشركة</label><input id="settingCompanyAddress" class="input"></div>
                                <div><label class="label">الرقم الضريبي</label><input id="settingCompanyTaxId" class="input"></div>
                                <div><label class="label">رقم الهاتف</label><input id="settingCompanyPhone" class="input"></div>
                                <div><label class="label">شعار الشركة</label><input id="settingCompanyLogo" type="file" class="input" accept="image/*"></div>
                                <img id="logoPreview" src="" alt="معاينة الشعار" class="max-h-24 rounded-lg bg-gray-200 p-1 hidden">
                            </div>
                        </div>
                        <div class="card p-4">
                            <h3 class="text-lg font-bold mb-4">إعدادات المخزون والبونص</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="label">حد المخزون المنخفض</label>
                                    <input id="settingLowStock" type="number" class="input">
                                </div>
                                <div><label class="label">تنبيه الصلاحية (أيام)</label>
                                    <input id="settingExpiryWarning" type="number" class="input">
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    <!-- Column 2 -->
                    <div class="space-y-6">
                        <div class="card p-4">
                            <h3 class="text-lg font-bold mb-4">إعدادات التقارير</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="label">لون رأس التقرير</label>
                                    <input id="settingReportColor" type="color" class="input h-12 p-1">
                                </div>
                                <div>
                                    <label class="label">موضع الشعار في التقرير</label>
                                    <select id="settingLogoPosition" class="select">
                                        <option value="right">يمين</option>
                                        <option value="left">يسار</option>
                                    </select>
                                </div>
                                <h4 class="font-semibold mt-4 pt-4 border-t mb-2">حقول إضافية في رأس التقرير</h4>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <input id="settingCustomField1Label" class="input" placeholder="اسم الحقل 1 (مثال: السجل التجاري)">
                                    <input id="settingCustomField1Value" class="input" placeholder="قيمة الحقل 1">
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <input id="settingCustomField2Label" class="input" placeholder="اسم الحقل 2 (مثال: الرقم الضريبي)">
                                    <input id="settingCustomField2Value" class="input" placeholder="قيمة الحقل 2">
                                </div>
                            </div>
                        </div>
                        <div class="card p-4 bg-blue-50 border-blue-200">
                            <h3 class="text-lg font-bold mb-4 text-blue-800"><i class="fas fa-link mr-2"></i>حسابات الربط المحاسبي</h3>
                            <p class="text-sm text-gray-600 mb-4">حدد الحسابات الافتراضية لتسهيل إنشاء القيود السريعة.</p>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div><label class="label">حساب المبيعات الافتراضي</label><select id="linkSales" class="select"></select></div>
                                <div><label class="label">حساب الصندوق الافتراضي</label><select id="linkCash" class="select"></select></div>
                                <div class="md:col-span-2"><label class="label">الحساب الأب للعملاء (المدينون)</label><select id="linkReceivablesParent" class="select"></select></div>
                                <div><label class="label">حساب تكلفة المبيعات</label><select id="linkCogs" class="select"></select></div>
                                <div><label class="label">حساب المخزون</label><select id="linkInventory" class="select"></select></div>
                                <div><label class="label">حساب الموردين (الدائنون)</label><select id="linkAccountsPayable" class="select"></select></div>
                                <div><label class="label">حساب الخصم المسموح به</label><select id="linkSalesDiscount" class="select"></select></div>
                                <div><label class="label">حساب مصروفات العينات</label><select id="linkSamplesExpense" class="select"></select></div>
                                <div><label class="label">حساب مصروفات البونص</label><select id="linkBonusExpense" class="select"></select></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="invoice-print-area" class="hidden print-area">
        <div class="print-header">
            <img id="print-logo-invoice" src="" alt="Company Logo" class="mx-auto max-h-24 mb-4 hidden">
            <h1 id="print-company-name" class="font-bold text-3xl"></h1>
            <p id="print-company-address"></p>
                <p id="print-company-tax-id" class="hidden"></p>
            <p id="print-company-phone"></p>
        </div>
        <h2 class="text-2xl font-bold text-center my-6 border-y-2 py-2">فاتورة مبيعات</h2>
        <div class="grid grid-cols-2 gap-4 text-sm mb-4">
            <div><strong>العميل:</strong> <span id="print-customer-name"></span></div>
            <div class="text-left"><strong>رقم الفاتورة:</strong> <span id="print-invoice-id"></span></div>
            <div><strong>ملاحظات:</strong> <span id="print-invoice-notes"></span></div>
            <div class="text-left"><strong>التاريخ:</strong> <span id="print-invoice-date"></span></div>
        </div>
        <table class="w-full text-sm">
            <thead class="bg-gray-100">
                <tr class="border-b-2 border-gray-300">
                    <th class="text-right p-2">الصنف</th>
                    <th class="text-center p-2">الكمية</th>
                    <th class="text-center p-2">السعر</th>
                    <th class="text-left p-2">الإجمالي</th>
                </tr>
            </thead>
            <tbody id="print-invoice-items"></tbody>
            <tfoot>
                    <tr class="font-bold"><td colspan="3" class="text-left p-2 border-t-2 border-gray-400">الإجمالي قبل الخصم</td><td id="print-invoice-subtotal" class="text-left p-2 border-t-2 border-gray-400 font-mono"></td></tr>
                    <tr class="font-bold"><td colspan="3" class="text-left p-2">الخصم</td><td id="print-invoice-discount" class="text-left p-2 text-red-600 font-mono"></td></tr>
                    <tr class="font-bold text-lg"><td colspan="3" class="text-left p-2 border-t">الإجمالي النهائي</td><td id="print-invoice-total" class="text-left p-2 border-t font-mono"></td></tr>
                    <tr class="font-bold"><td colspan="3" class="text-left p-2">المدفوع</td><td id="print-invoice-paid" class="text-left p-2 font-mono"></td></tr>
                    <tr class="font-bold text-lg"><td colspan="3" class="text-left p-2">المتبقي</td><td id="print-invoice-remaining" class="text-left p-2 font-mono"></td></tr>
            </tfoot>
        </table>
        <div class="grid grid-cols-2 gap-8 mt-16 text-sm">
            <div class="text-center">...........................<br><strong>توقيع المستلم</strong></div>
            <div class="text-center">...........................<br><strong>توقيع أمين المخازن</strong></div>
        </div>
        <div class="text-center text-xs text-gray-500 mt-8">
            <!-- <p>شكراً لتعاملكم معنا!</p> -->
            <p>هذا المستند تم إنشاؤه بواسطة النظام المحاسبي.</p>
        </div>
    </div>

    <div id="purchase-print-area" class="hidden print-area">
        <div class="print-header">
            <img id="print-logo-purchase" src="" alt="Company Logo" class="mx-auto max-h-24 mb-4 hidden">
            <h1 id="print-purchase-company-name" class="font-bold text-3xl"></h1>
            <p id="print-purchase-company-address"></p>
                <p id="print-purchase-tax-id" class="hidden"></p>
            <p id="print-purchase-company-phone"></p>
        </div>
        <h2 class="text-2xl font-bold text-center my-6 border-y-2 py-2">فاتورة شراء</h2>
        <div class="grid grid-cols-2 gap-4 text-sm mb-4">
            <div><strong>المورد:</strong> <span id="print-purchase-supplier-name"></span></div>
            <div class="text-left"><strong>رقم الفاتورة:</strong> <span id="print-purchase-id"></span></div>
            <div><strong>ملاحظات:</strong> <span id="print-purchase-notes"></span></div>
            <div class="text-left"><strong>التاريخ:</strong> <span id="print-purchase-date"></span></div>
        </div>
        <table class="w-full text-sm">
            <thead class="bg-gray-100">
                <tr class="border-b-2 border-gray-300">
                    <th class="text-right p-2">الصنف</th>
                    <th class="text-center p-2">الكمية</th>
                    <th class="text-center p-2">سعر الشراء</th>
                    <th class="text-left p-2">الإجمالي</th>
                </tr>
            </thead>
            <tbody id="print-purchase-items"></tbody>
            <tfoot>
                <tr class="font-bold text-lg"><td colspan="3" class="text-left p-2 border-t-2 border-gray-400">الإجمالي</td><td id="print-purchase-total" class="text-left p-2 border-t-2 border-gray-400"></td></tr>
            </tfoot>
        </table>
        <div class="grid grid-cols-2 gap-8 mt-16 text-sm">
            <div class="text-center">...........................<br><strong>توقيع المستلم</strong></div>
            <div class="text-center">...........................<br><strong>توقيع أمين المخازن</strong></div>
        </div>
        <div class="text-center text-xs text-gray-500 mt-8">
            <p>هذا المستند تم إنشاؤه بواسطة النظام المحاسبي.</p>
        </div>
    </div>

    <div id="report-print-area" class="hidden print-area"></div>
    <div id="sales-return-print-area" class="hidden print-area"></div>
    <div id="purchase-return-print-area" class="hidden print-area"></div>
    <div id="bonus-invoice-print-area" class="hidden print-area"></div>
    <div id="receipt-print-area" class="hidden print-area"></div>
    <div id="payment-print-area" class="hidden print-area"></div>
    <div id="disbursement-print-area" class="hidden print-area"></div>

    <div id="alertContainer"></div>

    <script>
        const $ = s => document.querySelector(s);
        const $$ = s => Array.from(document.querySelectorAll(s));
        const DB_KEY = 'pharmaAccounting.v2';

       const presetChart = [
            // 1000: الأصول
            { yes: '1000', name: 'الأصول', type: 'asset' },
            { no: '1000', name: 'الأصول', type: 'asset' },
            { no: '1100', name: 'الأصول المتداولة', type: 'asset' },
            { no: '1110', name: 'الصندوق', type: 'cash' },
            { no: '1120', name: 'البنك', type: 'cash' },
            { no: '1130', name: 'المدينون (العملاء)', type: 'receivable' },
            { no: '1200', name: 'المخزون', type: 'asset' },
            { no: '1500', name: 'الأصول الثابتة', type: 'asset' },
            { no: '1510', name: 'أثاث ومعدات', type: 'asset' },
            { no: '1515', name: 'مجمع إهلاك الأثاث', type: 'asset' }, // حساب عكسي للأصول
            { no: '1520', name: 'سيارات', type: 'asset' },
            { no: '1525', name: 'مجمع إهلاك السيارات', type: 'asset' }, // حساب عكسي للأصول

            // 2000: الالتزامات
            { no: '2000', name: 'الالتزامات', type: 'liability' },
            { no: '2100', name: 'الالتزامات المتداولة', type: 'liability' },
            { no: '2110', name: 'الموردون (الدائنون)', type: 'payable' },
            { no: '2120', name: 'مصروفات مستحقة', type: 'liability' },
            { no: '2210', name: 'قروض طويلة الأجل', type: 'liability' },

            // 3000: حقوق الملكية
            { no: '3000', name: 'حقوق الملكية', type: 'equity' },
            { no: '3110', name: 'رأس المال', type: 'equity' },
            { no: '3120', name: 'المسحوبات الشخصية', type: 'equity' }, // حساب عكسي
            { no: '3130', name: 'الأرباح المحتجزة', type: 'equity' },

            // 4000: الإيرادات
            { no: '4000', name: 'الإيرادات', type: 'income' },
            { no: '4100', name: 'إيرادات المبيعات', type: 'income' },
            { no: '4110', name: 'مردودات ومسموحات المبيعات', type: 'income' }, // حساب عكسي
            { no: '4120', name: 'خصم مسموح به', type: 'income' }, // حساب عكسي

            // 5000: المصروفات
            { no: '5000', name: 'المصروفات', type: 'expense' },
            { no: '5100', name: 'تكلفة البضاعة المباعة', type: 'expense' },
            { no: '5200', name: 'مصروفات بيعية وتسويقية', type: 'expense' },
            { no: '5210', name: 'مصروفات بونص وتعويضات', type: 'expense' },
            { no: '5220', name: 'مصروفات عينات وهدايا', type: 'expense' },
            { no: '5300', name: 'مصروفات عمومية وإدارية', type: 'expense' },
            { no: '5310', name: 'رواتب وأجور', type: 'expense' },
            { no: '5320', name: 'إيجار', type: 'expense' },
            { no: '5330', name: 'كهرباء ومياه وهاتف', type: 'expense' },
            { no: '5340', name: 'مصروف الإهلاك', type: 'expense' },
            { no: '5390', name: 'مصروفات عمومية أخرى', type: 'expense' },
        ];

        const presetLinks = {
            sales: '4100', cash: '1110', cogs: '5100',
            receivablesParent: '1130', inventory: '1200', accountsPayable: '2110',
            salesDiscount: '4120', samplesExpense: '5220', bonusExpense: '5210'
        };

        const emptyDB = {
            customers: [],
            suppliers: [],
            items: [],
            invoices: [],
            purchases: [],
            salesReturns: [],
            purchaseReturns: [],
            inventoryDisbursements: [],
            bonusInvoices: [],
            chart: [],
            journal: [],
            settings: {
                companyName: 'شركة الأدوية الحديثة',
                companyAddress: 'صنعاء، شارع تعز',
                companyPhone: '01-234567',
                companyTaxId: '',
                companyLogo: '',
                accountingLinks: { sales: '', cash: '', receivablesParent: '', inventory: '', accountsPayable: '', cogs: '', salesDiscount: '', samplesExpense: '', bonusExpense: '' },
                inventory: {
                    lowStockThreshold: 10,
                    expiryWarningDays: 90,
                },
                report: {
                    headerColor: '#3b82f6', // Default blue
                    logoPosition: 'right', // 'left' or 'right'
                    customField1Label: '',
                    customField1Value: '',
                    customField2Label: '',
                    customField2Value: ''
                }
            }
        };
        let db = JSON.parse(JSON.stringify(emptyDB));
        let editingInvoiceId = null;
        let editingPurchaseId = null;
        let editingItemId = null;


        // --- Core Functions ---
        const saveDB = () => {
            try {
                localStorage.setItem(DB_KEY, JSON.stringify(db));
                console.log('DB saved successfully to localStorage.');
            } catch (e) {
                console.error('Error saving DB to localStorage:', e);
                showAlert('خطأ في حفظ البيانات: ' + e.message, 'error');
            }
        };
        const loadDB = () => {
            const data = localStorage.getItem(DB_KEY);
            if (data) {
                try {
                    db = JSON.parse(data);
                } catch (e) {
                    console.error('Error parsing DB from localStorage:', e);
                    showAlert('خطأ في تحميل البيانات: ' + e.message + '. سيتم تهيئة النظام.', 'error');
                    db = JSON.parse(JSON.stringify(emptyDB)); // Reset to empty if corrupted
                }
                if (db.settings.companyLogo === undefined) db.settings.companyLogo = '';
                if (db.settings.companyTaxId === undefined) db.settings.companyTaxId = '';
                // Ensure top-level objects exist for backward compatibility
                if (!db.settings) db.settings = JSON.parse(JSON.stringify(emptyDB.settings));
                if (!db.customers) db.customers = [];
                if (!db.suppliers) db.suppliers = [];
                if (!db.items) db.items = [];
                if (!db.invoices) db.invoices = [];
                if (!db.purchases) db.purchases = [];
                if (!db.salesReturns) db.salesReturns = [];
                if (!db.purchaseReturns) db.purchaseReturns = [];
                if (!db.inventoryDisbursements) db.inventoryDisbursements = [];
                if (!db.bonusInvoices) db.bonusInvoices = [];
                if (!db.chart) db.chart = [];
                if (!db.journal) db.journal = [];

                // Ensure nested settings objects exist before accessing properties
                if (!db.settings.accountingLinks) db.settings.accountingLinks = JSON.parse(JSON.stringify(emptyDB.settings.accountingLinks));
                if (!db.settings.inventory) db.settings.inventory = JSON.parse(JSON.stringify(emptyDB.settings.inventory));
                if (!db.settings.report) db.settings.report = JSON.parse(JSON.stringify(emptyDB.settings.report));

                // Ensure specific properties exist for backward compatibility
                if (db.settings.accountingLinks.inventory === undefined) db.settings.accountingLinks.inventory = '';
                if (db.settings.accountingLinks.accountsPayable === undefined) db.settings.accountingLinks.accountsPayable = '';
                if (db.settings.accountingLinks.cogs === undefined) db.settings.accountingLinks.cogs = '';
                if (db.settings.accountingLinks.salesDiscount === undefined) db.settings.accountingLinks.salesDiscount = '';
                if (db.settings.accountingLinks.samplesExpense === undefined) db.settings.accountingLinks.samplesExpense = '';
                if (db.settings.accountingLinks.salesReturns === undefined) db.settings.accountingLinks.salesReturns = '';
                if (db.settings.accountingLinks.salesReturns === undefined) db.settings.accountingLinks.salesReturns = '';
                if (db.settings.accountingLinks.bonusExpense === undefined) db.settings.accountingLinks.bonusExpense = '';
                if (db.settings.inventory.expiryWarningDays === undefined) db.settings.inventory.expiryWarningDays = 90;

                // Migrate global bonus ratio to per-item settings
                if (db.settings.inventory.bonusRatio !== undefined) {
                    const globalBonusRatio = db.settings.inventory.bonusRatio;
                    db.items.forEach(item => {
                        if (item.bonusRatioCredit === undefined) item.bonusRatioCredit = globalBonusRatio;
                        if (item.bonusRatioCash === undefined) item.bonusRatioCash = globalBonusRatio;
                    });
                    delete db.settings.inventory.bonusRatio;
                    showAlert('تم ترحيل إعداد البونص العام إلى كل صنف على حدة.', 'info');
                    saveDB(); // Save immediately after migration
                }

                // Fix data structures in arrays
                db.purchases.forEach(p => {
                    if (p.paidAmount === undefined) p.paidAmount = 0;
                    if (!p.payments) p.payments = [];
                });
            }
        };
        const showAlert = (message, type = 'success') => {
            const container = $('#alertContainer');
            const alert = document.createElement('div');
            const iconClass = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            }[type] || 'fa-check-circle';

            alert.className = `alert ${type}`;
            alert.innerHTML = `<i class="fas ${iconClass} mr-2"></i> ${message}`;
            container.appendChild(alert);
            setTimeout(() => alert.classList.add('show'), 10);
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 300);
            }, 4000);
        };
        const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount || 0);
        const sanitizeHTML = (str) => {
            if (!str) return '';
            return str.toString().replace(/</g, "&lt;").replace(/>/g, "&gt;");
        };
        const tafqeet = (number, currency = 'ريال', subCurrency = 'فلس') => {
            if (number === null || number === undefined || isNaN(number)) {
                return "فقط صفر " + currency + " لا غير.";
            }
            const num = parseFloat(number).toFixed(2);
            const [integerPart, fractionalPart] = num.split('.').map(p => parseInt(p));

            if (integerPart === 0 && fractionalPart === 0) {
                return "فقط صفر " + currency + " لا غير.";
            }

            const ones = ['', 'واحد', 'اثنان', 'ثلاثة', 'أربعة', 'خمسة', 'ستة', 'سبعة', 'ثمانية', 'تسعة'];
            const onesFeminine = ['', 'إحدى', 'اثنتان', 'ثلاث', 'أربع', 'خمس', 'ست', 'سبع', 'ثمان', 'تسع'];
            const teens = ['عشرة', 'أحد عشر', 'اثنا عشر', 'ثلاثة عشر', 'أربعة عشر', 'خمسة عشر', 'ستة عشر', 'سبعة عشر', 'ثمانية عشر', 'تسعة عشر'];
            const tens = ['', 'عشرة', 'عشرون', 'ثلاثون', 'أربعون', 'خمسون', 'ستون', 'سبعون', 'ثمانون', 'تسعون'];
            const hundreds = ['', 'مئة', 'مئتان', 'ثلاثمائة', 'أربعمائة', 'خمسمائة', 'ستمائة', 'سبعمائة', 'ثمانمائة', 'تسعمائة'];
            const thousands = { s: 'ألف', d: 'ألفان', p: 'آلاف' };
            const millions = { s: 'مليون', d: 'مليونان', p: 'ملايين' };
            const billions = { s: 'مليار', d: 'ملياران', p: 'مليارات' };

            function convertThreeDigits(n, isFeminine = false) {
                if (n === 0) return '';
                let result = '';
                const h = Math.floor(n / 100);
                const t = Math.floor((n % 100) / 10);
                const o = n % 10;

                if (h > 0) {
                    result += hundreds[h];
                    if (t > 0 || o > 0) result += ' و';
                }

                if (t === 1 && o > 0) {
                    result += teens[o];
                } else {
                    const useFeminine = isFeminine && (o === 1 || o === 2);
                    if (o > 0) {
                        result += useFeminine ? onesFeminine[o] : ones[o];
                    }
                    if (t > 1) {
                        if (o > 0) result += ' و';
                        result += tens[t];
                    }
                }
                return result;
            }

            function convertChunk(n, unit) {
                if (n === 0) return ''; if (n === 1) return unit.s; if (n === 2) return unit.d;
                if (n >= 3 && n <= 10) return convertThreeDigits(n, true) + ' ' + unit.p;
                return convertThreeDigits(n) + ' ' + unit.s;
            }

            function convert(num) {
                if (num === 0) return ''; let result = '';
                const billionsPart = Math.floor(num / 1000000000); if (billionsPart > 0) { result += convertChunk(billionsPart, billions); }
                const millionsPart = Math.floor((num % 1000000000) / 1000000); if (millionsPart > 0) { if (result) result += ' و'; result += convertChunk(millionsPart, millions); }
                const thousandsPart = Math.floor((num % 1000000) / 1000); if (thousandsPart > 0) { if (result) result += ' و'; result += convertChunk(thousandsPart, thousands); }
                const hundredsPart = num % 1000; if (hundredsPart > 0) { if (result) result += ' و'; result += convertThreeDigits(hundredsPart); }
                return result;
            }
            let integerText = convert(integerPart); let fractionalText = convert(fractionalPart); let finalResult = 'فقط ';
            if (integerPart > 0) { finalResult += integerText + ' ' + currency; }
            if (fractionalPart > 0) { if (integerPart > 0) finalResult += ' و'; finalResult += fractionalText + ' ' + subCurrency; }
            finalResult += ' لا غير.'; return finalResult.trim();
        };
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 9);

        // --- Render Functions ---
        function renderAll() {
            renderDashboard();
            renderCustomers();
            renderSuppliers();
            renderJournal();
            renderItems();
            renderInvoices();
            renderPurchases();
            renderSalesReturns();
            renderPurchaseReturns();
            renderPayments();
            renderDisbursementList();
            renderReceipts();
            renderInventoryDisbursement();
            renderInvoiceList();
            renderPurchaseList();
            renderInventory();
            renderChart();
            renderSettings();
        }

        function renderEmptyRow(tbody, colSpan, message) {
            tbody.innerHTML = `<tr><td colspan="${colSpan}" class="text-center text-gray-500 py-8">${message}</td></tr>`;
        }

        function renderDashboard() {
            const balances = getBalances();
            let totalRevenue = 0, totalAssets = 0, totalReceivables = 0, totalCash = 0, totalExpenses = 0;
            for (const accNo in balances) {
                const item = balances[accNo];
                if (item.acc.type === 'income') totalRevenue += item.balance;
                if (item.acc.type === 'expense') totalExpenses += item.balance;
                if (['asset', 'cash', 'receivable'].includes(item.acc.type)) totalAssets += item.balance;
                if (item.acc.type === 'receivable') totalReceivables += item.balance;
                if (item.acc.type === 'cash') totalCash += item.balance;
            }
            const netProfit = totalRevenue - totalExpenses;

            $('#kpi-net-profit').textContent = formatCurrency(netProfit);
            $('#kpi-total-revenue').textContent = formatCurrency(totalRevenue); // This is Gross Revenue
            $('#kpi-total-assets').textContent = formatCurrency(totalAssets);
            $('#kpi-total-due').textContent = formatCurrency(totalReceivables);

            const kpiCashEl = $('#kpi-total-cash');
            kpiCashEl.textContent = formatCurrency(totalCash);
            const kpiCashCard = kpiCashEl.parentElement;
            kpiCashCard.classList.remove('border-red-500', 'border-yellow-500');
            kpiCashEl.classList.remove('text-red-600', 'text-yellow-600');
            if (totalCash < 0) {
                kpiCashCard.classList.add('border-red-500');
                kpiCashEl.classList.add('text-red-600');
            } else {
                kpiCashCard.classList.add('border-yellow-500');
                kpiCashEl.classList.add('text-yellow-600');
            }

            const ctx = $('#dashboardChart').getContext('2d');
            if (window.dashboardChartInstance) window.dashboardChartInstance.destroy();
            window.dashboardChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['المبالغ'],
                    datasets: [
                        { label: 'الإيرادات', data: [totalRevenue], backgroundColor: 'rgba(59, 130, 246, 0.7)' },
                        { label: 'المصروفات', data: [totalExpenses], backgroundColor: 'rgba(239, 68, 68, 0.7)' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });

            const journalContainer = $('#dashboard-recent-journal');
            journalContainer.innerHTML = '';
            [...db.journal].reverse().slice(0, 5).forEach(entry => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center border-b border-gray-100 pb-2';
                item.innerHTML = `<div><p class="font-semibold">${entry.desc}</p><p class="text-xs text-gray-500">${entry.date}</p></div><p class="font-mono font-bold">${formatCurrency(entry.amount)}</p>`;
                journalContainer.appendChild(item);
            });
        }

        function renderCustomers() {
            const searchTerm = ($('#searchCustomers')?.value || '').toLowerCase();
            const tbody = $('#tblCustomers tbody');
            const filteredData = db.customers
                .filter(c => 
                    (c.name && c.name.toLowerCase().includes(searchTerm)) ||
                    (c.phone && c.phone.toLowerCase().includes(searchTerm)) ||
                    (c.address && c.address.toLowerCase().includes(searchTerm))
                );
            
            tbody.innerHTML = '';
            if (filteredData.length === 0) {
                renderEmptyRow(tbody, 5, 'لا يوجد عملاء. قم بإضافة عميل جديد من الزر أعلاه.');
                return;
            }
            filteredData
                .forEach(c => {
                    const row = tbody.insertRow();
                    row.innerHTML = `<td>${sanitizeHTML(c.name)}</td><td>${sanitizeHTML(c.phone)}</td><td>${sanitizeHTML(c.address)}</td><td>${c.accountNo || 'N/A'}</td>
                        <td class="flex gap-1"><button class="btn btn-danger btn-sm" onclick="deleteCustomer('${c.id}')"><i class="fas fa-trash"></i></button></td>`;
                });
        }

        function renderSuppliers() {
            const searchTerm = ($('#searchSuppliers')?.value || '').toLowerCase();
            const tbody = $('#tblSuppliers tbody');
            const filteredData = db.suppliers
                .filter(s => 
                    (s.name && s.name.toLowerCase().includes(searchTerm)) ||
                    (s.phone && s.phone.toLowerCase().includes(searchTerm)) ||
                    (s.address && s.address.toLowerCase().includes(searchTerm))
                );

            tbody.innerHTML = '';
            if (filteredData.length === 0) {
                renderEmptyRow(tbody, 5, 'لا يوجد موردين. قم بإضافة مورد جديد من الزر أعلاه.');
                return;
            }
            filteredData
                .forEach(s => {
                    const row = tbody.insertRow();
                    row.innerHTML = `<td>${sanitizeHTML(s.name)}</td><td>${sanitizeHTML(s.phone)}</td><td>${sanitizeHTML(s.address)}</td><td>${s.accountNo || 'N/A'}</td>
                        <td class="flex gap-1"><button class="btn btn-danger btn-sm" onclick="deleteSupplier('${s.id}')"><i class="fas fa-trash"></i></button></td>`;
                });
        }

        function renderItems() {
            const searchTerm = ($('#searchItems')?.value || '').toLowerCase();
            const tbody = $('#tblItems tbody');
            const filteredData = db.items
                .filter(item => 
                    (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                    (item.scientificName && item.scientificName.toLowerCase().includes(searchTerm))
                );

            tbody.innerHTML = '';
            if (filteredData.length === 0) {
                renderEmptyRow(tbody, 7, 'لا توجد أصناف. قم بإضافة صنف جديد من الزر أعلاه.');
                return;
            }
            filteredData
                .forEach(item => {
                    const row = tbody.insertRow();
                    row.innerHTML = `<td><b>${sanitizeHTML(item.name)}</b><br><small class="text-gray-500">${sanitizeHTML(item.scientificName)}</small></td>
                        <td>${formatCurrency(item.sellPrice)}</td>
                        <td>${item.qty} ${sanitizeHTML(item.unit)}</td>
                        <td>${item.bonusRatioCredit || 0}</td>
                        <td>${item.bonusRatioCash || 0}</td>
                        <td>${item.expiryDate || '-'}</td>
                        <td class="flex gap-1">
                            <button class="btn btn-info btn-sm" title="تعديل" onclick="editItem('${item.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger btn-sm" title="حذف" onclick="deleteItem('${item.id}')"><i class="fas fa-trash"></i></button>
                        </td>`;
                });
        }

        // --- Helper Functions for Rendering ---
        function populateSelect(selectEl, data, config) {
            const { valueKey, textKey, placeholder, filterFn = () => true, textFn } = config;
            const currentValue = selectEl.value;
            
            const optionsHtml = data
                .filter(filterFn)
                .map(item => {
                    const text = textFn ? textFn(item) : item[textKey];
                    return `<option value="${item[valueKey]}">${sanitizeHTML(text)}</option>`;
                })
                .join('');

            selectEl.innerHTML = `<option value="">${placeholder}</option>${optionsHtml}`;

            if (Array.from(selectEl.options).some(opt => opt.value === currentValue)) {
                selectEl.value = currentValue;
            }
        }

        function renderInvoiceItemsTable() {
            const invoiceTbody = $('#tblInvoiceItems tbody');
            invoiceTbody.innerHTML = '';
            let total = 0;
            currentInvoiceItems.forEach((item, index) => {
                const row = invoiceTbody.insertRow();
                const itemTotal = item.qty * item.price;
                total += itemTotal;
                row.innerHTML = `<td>${sanitizeHTML(item.name)} ${item.isBonus ? '<span class="chip chip-success">بونص</span>' : ''}</td><td>${item.qty}</td><td>${formatCurrency(item.price)}</td><td>${formatCurrency(itemTotal)}</td>
                    <td class="flex gap-1">
                        <button class="btn btn-info btn-sm" title="تعديل"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-sm" title="حذف"><i class="fas fa-times"></i></button>
                    </td>`;
                row.querySelector('.btn-info').addEventListener('click', () => editInvoiceItem(index));
                row.querySelector('.btn-danger').addEventListener('click', () => removeInvoiceItem(index));
            });
            const discount = parseFloat($('#invoiceDiscount').value) || 0;
            const finalTotal = total - discount;
            $('#invoiceSubtotal').textContent = formatCurrency(total);
            $('#invoiceDiscountDisplay').textContent = formatCurrency(discount);
            $('#invoiceTotal').textContent = formatCurrency(finalTotal);
        }

        function renderPurchaseItemsTable() {
            const purchaseTbody = $('#tblPurchaseItems tbody');
            purchaseTbody.innerHTML = '';
            let total = 0;
            currentPurchaseItems.forEach((item, index) => {
                const row = purchaseTbody.insertRow();
                const itemTotal = item.qty * item.price;
                total += itemTotal;
                row.innerHTML = `<td>${sanitizeHTML(item.name)}</td>
                    <td>${item.qty}</td>
                    <td>${formatCurrency(item.price)}</td>
                    <td>${item.prodDate || '-'}</td>
                    <td>${item.expDate || '-'}</td>
                    <td>${formatCurrency(itemTotal)}</td>
                    <td class="flex gap-1">
                        <button class="btn btn-info btn-sm" title="تعديل"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-sm" title="حذف"><i class="fas fa-times"></i></button>
                    </td>`;
                row.querySelector('.btn-info').addEventListener('click', () => editPurchaseItem(index));
                row.querySelector('.btn-danger').addEventListener('click', () => removePurchaseItem(index, true));
            });
            $('#purchaseTotal').textContent = formatCurrency(total);
        }

        let currentInvoiceItems = [];
        function renderInvoices() {
            $('#invoiceDate').valueAsDate = new Date();

            populateSelect($('#invoiceCustomer'), db.customers, { valueKey: 'id', textKey: 'name', placeholder: '-- اختر عميل --' });
            populateSelect($('#invoiceItem'), db.items, { 
                valueKey: 'id', 
                textFn: i => `${i.name} (متوفر: ${i.qty})`, 
                placeholder: '-- اختر صنف --',
                filterFn: i => i.qty > 0
            });

            renderInvoiceItemsTable();
            validateInvoiceQty();
        }

        let currentDisbursementItems = [];
        function renderInventoryDisbursement() {
            $('#disbursementDate').valueAsDate = new Date();
            populateSelect($('#disbursementItem'), db.items, { 
                valueKey: 'id', 
                textFn: i => `${i.name} (متوفر: ${i.qty})`, 
                placeholder: '-- اختر صنف --',
                filterFn: i => i.qty > 0
            });
            renderDisbursementItemsTable();
        }

        function renderDisbursementItemsTable() {
            const tbody = $('#tblDisbursementItems tbody');
            tbody.innerHTML = '';
            currentDisbursementItems.forEach((item, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${sanitizeHTML(item.name)}</td><td>${item.qty}</td>
                    <td class="flex gap-1">
                        <button class="btn btn-danger btn-sm" title="حذف"><i class="fas fa-times"></i></button>
                    </td>`;
                row.querySelector('.btn-danger').addEventListener('click', () => removeDisbursementItem(index));
            });
        }


        let currentPurchaseItems = [];
        function renderPurchases() {
            $('#purchaseDate').valueAsDate = new Date();
            
            populateSelect($('#purchaseSupplier'), db.suppliers, { valueKey: 'id', textKey: 'name', placeholder: '-- اختر مورد --' });
            populateSelect($('#purchaseItem'), db.items, { valueKey: 'id', textKey: 'name', placeholder: '-- اختر صنف --' });

            renderPurchaseItemsTable();
            validatePurchaseQty();
        }

        function renderInventory() {
            const tbody = $('#tblInventory tbody');
            const items = db.items.sort((a, b) => a.name.localeCompare(b.name));
            
            tbody.innerHTML = '';
            if (items.length === 0) {
                renderEmptyRow(tbody, 4, 'لا توجد أصناف في المخزون. قم بإضافتها من قسم الأصناف ثم قم بعمل فاتورة شراء.');
                return;
            }

            let totalValue = 0;
            let lowStockCount = 0;
            let expiredCount = 0;
            items.forEach(item => {
                let expiryStatusClass = '';
                let expiryText = item.expiryDate || '-';
                if (item.expiryDate) {
                    const daysRemaining = (new Date(item.expiryDate) - new Date()) / (1000 * 60 * 60 * 24);
                    if (daysRemaining < 0) {
                        expiryStatusClass = 'text-red-600 font-bold';
                        expiryText = `منتهي منذ ${Math.abs(Math.round(daysRemaining))} يوم`;
                        expiredCount++;
                    } else if (daysRemaining <= db.settings.inventory.expiryWarningDays) {
                        expiryStatusClass = 'text-yellow-600 font-bold';
                        expiryText = `ينتهي خلال ${Math.round(daysRemaining)} يوم`;
                        expiredCount++;
                    }
                }
                const row = tbody.insertRow();
                row.innerHTML = `<td>${item.name}</td>
                    <td class="${item.qty <= db.settings.inventory.lowStockThreshold ? 'text-red-600 font-bold' : ''}">${item.qty} ${item.unit}</td>
                    <td class="${expiryStatusClass}">${expiryText}</td>
                    <td>${formatCurrency(item.sellPrice)}</td>`;
                totalValue += item.qty * item.sellPrice;
                if (item.qty <= db.settings.inventory.lowStockThreshold) lowStockCount++;
            });
            $('#kpi-item-count').textContent = db.items.length;
            $('#kpi-inventory-value').textContent = formatCurrency(totalValue);
            $('#kpi-low-stock').textContent = lowStockCount;
            $('#kpi-expired-stock').textContent = expiredCount;
        }

        function renderInvoiceList() {
            const searchTerm = ($('#searchInvoices')?.value || '').toLowerCase();
            const tbody = $('#tblInvoices tbody');
            const tfoot = $('#tblInvoices tfoot');
            const filteredData = [...db.invoices].reverse().filter(inv =>
                (inv.id && inv.id.toLowerCase().includes(searchTerm)) ||
                (inv.customerName && inv.customerName.toLowerCase().includes(searchTerm))
            );

            tbody.innerHTML = '';
            if (tfoot) tfoot.innerHTML = '';

            if (filteredData.length === 0) {
                renderEmptyRow(tbody, 10, 'لا توجد فواتير مبيعات. قم بإنشاء فاتورة جديدة من قسم الفواتير.');
                return;
            }

            let totalSubtotal = 0;
            let totalDiscount = 0;
            let grandTotal = 0;
            let totalPaid = 0;
            let totalRemaining = 0;

            const getInvoiceTypeText = (type) => {
                switch(type) {
                    case 'cash': return 'نقدي';
                    case 'credit': return 'آجل';
                    case 'cash-pending': return 'نقدي معلق';
                    default: return type;
                }
            };

            filteredData.forEach(inv => {
                const remaining = inv.total - inv.paidAmount;
                const subtotal = inv.total + (inv.discount || 0);

                totalSubtotal += subtotal;
                totalDiscount += (inv.discount || 0);
                grandTotal += inv.total;
                totalPaid += inv.paidAmount;
                totalRemaining += remaining;

                const row = tbody.insertRow();
                row.className = remaining <= 0.01 ? 'bg-green-50' : (inv.type === 'cash-pending' ? 'bg-yellow-50' : '');
                row.innerHTML = `
                    <td>#${inv.id.slice(-6)}</td>
                    <td>${inv.date}</td>
                    <td>${sanitizeHTML(inv.customerName)}</td>
                    <td><span class="chip ${inv.type === 'cash' ? 'chip-success' : 'chip-warning'}">${getInvoiceTypeText(inv.type)}</span></td>
                    <td class="font-mono">${formatCurrency(subtotal)}</td>
                    <td class="font-mono text-orange-600">${formatCurrency(inv.discount || 0)}</td>
                    <td class="font-mono font-bold">${formatCurrency(inv.total)}</td>
                    <td class="font-mono text-green-600">${formatCurrency(inv.paidAmount)}</td>
                    <td class="font-mono font-bold ${remaining > 0 ? 'text-red-600' : ''}">${formatCurrency(remaining)}</td>
                    <td class="flex gap-1 flex-wrap">
                        <button class="btn btn-info btn-sm" title="طباعة" onclick="printInvoice('${inv.id}')"><i class="fas fa-print"></i></button>
                        <button class="btn btn-secondary btn-sm" title="تعديل" onclick="editInvoice('${inv.id}')"><i class="fas fa-edit"></i></button>
                        ${remaining > 0 && inv.type === 'credit' ? `<button class="btn btn-success btn-sm" title="تسجيل دفعة" onclick="makePayment('${inv.id}')"><i class="fas fa-dollar-sign"></i></button>` : ''}
                        <button class="btn btn-warning btn-sm" title="إرجاع" onclick="initiateSalesReturn('${inv.id}')"><i class="fas fa-undo"></i></button>
                        <button class="btn btn-danger btn-sm" title="حذف نهائي" onclick="deleteInvoice('${inv.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            });

            if (tfoot) {
                tfoot.innerHTML = `
                    <tr class="bg-blue-50 font-bold">
                        <td colspan="4" class="text-center">الإجماليات</td>
                        <td class="font-mono">${formatCurrency(totalSubtotal)}</td>
                        <td class="font-mono text-orange-600">${formatCurrency(totalDiscount)}</td>
                        <td class="font-mono">${formatCurrency(grandTotal)}</td>
                        <td class="font-mono text-green-600">${formatCurrency(totalPaid)}</td>
                        <td class="font-mono text-red-600">${formatCurrency(totalRemaining)}</td>
                        <td></td>
                    </tr>
                `;
            }
        }

        function renderDisbursementList() {
            const searchTerm = ($('#searchDisbursements')?.value || '').toLowerCase();
            const tbody = $('#tblDisbursementList tbody');
            const filteredData = [...db.inventoryDisbursements].reverse().filter(d => 
                (d.id && d.id.toLowerCase().includes(searchTerm)) ||
                (d.notes && d.notes.toLowerCase().includes(searchTerm))
            );

            tbody.innerHTML = '';
            if (filteredData.length === 0) {
                renderEmptyRow(tbody, 4, 'لا توجد أوامر صرف. قم بإنشاء أمر جديد من قسم إدارة المخزون.');
                return;
            }

            filteredData.forEach(d => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>#${d.id.slice(-6)}</td>
                    <td>${d.date}</td>
                    <td>${sanitizeHTML(d.notes)}</td>
                    <td class="flex gap-1 flex-wrap">
                        <button class="btn btn-info btn-sm" title="طباعة" onclick="printDisbursement('${d.id}')"><i class="fas fa-print"></i></button>
                        <button class="btn btn-danger btn-sm" title="حذف" onclick="deleteDisbursement('${d.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            });
        }


        function renderPurchaseList() {
            const searchTerm = ($('#searchPurchases')?.value || '').toLowerCase();
            const tbody = $('#tblPurchaseList tbody');
            const filteredData = [...db.purchases].reverse().filter(p => 
                (p.id && p.id.toLowerCase().includes(searchTerm)) ||
                (p.supplierName && p.supplierName.toLowerCase().includes(searchTerm))
            );

            tbody.innerHTML = '';
            if (filteredData.length === 0) {
                renderEmptyRow(tbody, 6, 'لا توجد فواتير شراء. قم بإنشاء فاتورة جديدة من قسم الفواتير.');
                return;
            }

            filteredData.forEach(p => {
                const remaining = p.total - (p.paidAmount || 0);
                const row = tbody.insertRow();
                row.className = remaining > 0 ? '' : 'bg-green-50';
                row.innerHTML = `
                    <td>#${p.id.slice(-6)}</td>
                    <td>${p.date}</td>
                    <td>${sanitizeHTML(p.supplierName)}</td>
                    <td class="font-mono">${formatCurrency(p.total)}</td>
                    <td class="font-mono text-red-600">${formatCurrency(remaining)}</td>
                    <td class="flex gap-1 flex-wrap">
                        <button class="btn btn-info btn-sm" title="طباعة" onclick="printPurchaseInvoice('${p.id}')"><i class="fas fa-print"></i></button>
                        <button class="btn btn-secondary btn-sm" title="تعديل" onclick="editPurchaseInvoice('${p.id}')"><i class="fas fa-edit"></i></button>
                        ${remaining > 0 ? `<button class="btn btn-success btn-sm" title="تسجيل دفعة" onclick="makeOutgoingPayment('${p.id}')"><i class="fas fa-dollar-sign"></i></button>` : ''}
                        <button class="btn btn-warning btn-sm" title="إرجاع" onclick="initiatePurchaseReturn('${p.id}')"><i class="fas fa-undo"></i></button>
                        <button class="btn btn-danger btn-sm" title="حذف نهائي" onclick="deletePurchaseInvoice('${p.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            });
        }

        function renderReceipts() {
            const tbody = $('#tblReceipts tbody');
            const allReceipts = [];
            db.invoices.forEach(inv => {
                inv.payments.forEach(p => {
                    if (!p.journalId) return; // Skip payments without a journal entry (like initial cash payments)
                    allReceipts.push({
                        date: p.date,
                        customerName: inv.customerName,
                        amount: p.amount,
                        invoiceId: inv.id,
                        desc: p.desc,
                        journalId: p.journalId
                    });
                });
            });

            tbody.innerHTML = '';
            if (allReceipts.length === 0) {
                renderEmptyRow(tbody, 5, 'لا توجد مقبوضات مسجلة.');
                return;
            }

            allReceipts.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(r => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${r.date}</td>
                    <td>${sanitizeHTML(r.customerName)}</td>
                    <td class="font-mono">${formatCurrency(r.amount)}</td>
                    <td><a href="#" onclick="viewInvoiceFromReceipts('${r.invoiceId}')" class="text-blue-600 hover:underline">#${r.invoiceId.slice(-6)}</a></td>
                    <td>${sanitizeHTML(r.desc) || ''}</td>
                    <td class="flex gap-1">
                        <button class="btn btn-info btn-sm" title="طباعة" onclick="printReceipt('${r.invoiceId}', '${r.journalId}')"><i class="fas fa-print"></i></button>
                        <button class="btn btn-danger btn-sm" title="حذف" ${!r.journalId ? 'disabled' : ''} onclick="deleteReceipt('${r.invoiceId}', '${r.journalId}')"><i class="fas fa-trash"></i></button>
                    </td>`;
            });
        }

        function renderSalesReturns() {
            $('#returnDate').valueAsDate = new Date();
            const customerSelect = $('#returnCustomer');
            customerSelect.innerHTML = '<option value="">-- اختر عميل --</option>';
            db.customers.forEach(c => customerSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`);
            $('#returnInvoice').innerHTML = '<option value="">-- اختر فاتورة --</option>';
            $('#tblReturnItems tbody').innerHTML = '';
            $('#salesReturnTotal').textContent = formatCurrency(0);

            const listTbody = $('#tblSalesReturnsList tbody');
            const returns = [...db.salesReturns].reverse();

            listTbody.innerHTML = '';
            if (returns.length === 0) {
                renderEmptyRow(listTbody, 5, 'لا توجد مرتجعات مبيعات مسجلة.');
                return;
            }
            returns.forEach(sr => {
                listTbody.innerHTML += `<tr>
                    <td>${sr.date}</td><td>${sr.customerName}</td>
                    <td>#${sr.originalInvoiceId.slice(-6)}</td>
                    <td class="font-mono">${formatCurrency(sr.total)}</td>
                    <td class="flex gap-1">
                        <button class="btn btn-info btn-sm" title="طباعة" onclick="printSalesReturn('${sr.id}')"><i class="fas fa-print"></i></button>
                        <button class="btn btn-danger btn-sm" title="حذف" onclick="deleteSalesReturn('${sr.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        function renderPurchaseReturns() {
            $('#purchaseReturnDate').valueAsDate = new Date();
            const supplierSelect = $('#purchaseReturnSupplier');
            supplierSelect.innerHTML = '<option value="">-- اختر مورد --</option>';
            db.suppliers.forEach(s => supplierSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`);
            $('#purchaseReturnInvoice').innerHTML = '<option value="">-- اختر فاتورة --</option>';
            $('#tblPurchaseReturnItems tbody').innerHTML = '';
            $('#purchaseReturnTotal').textContent = formatCurrency(0);

            const listTbody = $('#tblPurchaseReturnsList tbody');
            const returns = [...db.purchaseReturns].reverse();

            listTbody.innerHTML = '';
            if (returns.length === 0) {
                renderEmptyRow(listTbody, 5, 'لا توجد مرتجعات مشتريات مسجلة.');
                return;
            }
            returns.forEach(pr => {
                listTbody.innerHTML += `<tr>
                    <td>${pr.date}</td><td>${pr.supplierName}</td>
                    <td>#${pr.originalPurchaseId.slice(-6)}</td>
                    <td class="font-mono">${formatCurrency(pr.total)}</td>
                    <td class="flex gap-1">
                        <button class="btn btn-info btn-sm" title="طباعة" onclick="printPurchaseReturn('${pr.id}')"><i class="fas fa-print"></i></button>
                        <button class="btn btn-danger btn-sm" title="حذف" onclick="deletePurchaseReturn('${pr.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        function renderPayments() {
            // Render Form
            $('#paymentDate').valueAsDate = new Date();
            const supplierSelect = $('#paymentSupplier');
            supplierSelect.innerHTML = '<option value="">-- اختر مورد --</option>';
            db.suppliers.forEach(s => {
                const hasDue = db.purchases.some(p => p.supplierId === s.id && (p.total - (p.paidAmount || 0) > 0));
                if (hasDue) {
                    supplierSelect.innerHTML += `<option value="${s.id}">${sanitizeHTML(s.name)}</option>`;
                }
            });
            $('#paymentPurchaseInvoice').innerHTML = '<option value="">-- اختر فاتورة --</option>';
            $('#paymentAmount').value = '';
            $('#paymentDesc').value = '';

            // Render List
            const tbody = $('#tblPayments tbody');
            const allPayments = [];
            db.purchases.forEach(p => {
                if (p.payments) {
                    p.payments.forEach(payment => {
                        if (!payment.journalId) return;
                        allPayments.push({
                            date: payment.date,
                            supplierName: p.supplierName,
                            amount: payment.amount,
                            purchaseId: p.id,
                            desc: payment.desc,
                            journalId: payment.journalId
                        });
                    });
                }
            });

            tbody.innerHTML = '';
            if (allPayments.length === 0) {
                renderEmptyRow(tbody, 5, 'لا توجد مدفوعات مسجلة.');
                return;
            }

            allPayments.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(p => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${p.date}</td>
                    <td>${sanitizeHTML(p.supplierName)}</td>
                    <td class="font-mono">${formatCurrency(p.amount)}</td>
                    <td><a href="#" onclick="viewPurchaseFromPayments('${p.purchaseId}')" class="text-blue-600 hover:underline">#${p.purchaseId.slice(-6)}</a></td>
                    <td>${sanitizeHTML(p.desc) || ''}</td>
                    <td class="flex gap-1">
                        <button class="btn btn-info btn-sm" title="طباعة" onclick="printPayment('${p.purchaseId}', '${p.journalId}')"><i class="fas fa-print"></i></button>
                        <button class="btn btn-danger btn-sm" title="حذف" ${!p.journalId ? 'disabled' : ''} onclick="deleteOutgoingPayment('${p.purchaseId}', '${p.journalId}')"><i class="fas fa-trash"></i></button>
                    </td>`;
            });
        }

        function renderJournal() {
            $('#jDate').valueAsDate = new Date();
            const debitSelect = $('#jDebit');
            const creditSelect = $('#jCredit');
            const customerSelect = $('#jCustomer');
            debitSelect.innerHTML = creditSelect.innerHTML = '<option value="">-- اختر حساب --</option>';
            customerSelect.innerHTML = '<option value="">-- لا يوجد --</option>';

            db.chart.sort((a,b) => a.no.localeCompare(b.no)).forEach(acc => {
                const option = `<option value="${acc.no}">${acc.name} (${acc.no})</option>`;
                debitSelect.innerHTML += option;
                creditSelect.innerHTML += option;
            });
            db.customers.forEach(c => {
                customerSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });

            const journalTbody = $('#tblJournal tbody');
            const entries = [...db.journal].reverse();

            journalTbody.innerHTML = '';
            if (entries.length === 0) {
                renderEmptyRow(journalTbody, 6, 'لا توجد قيود يومية. يتم إنشاؤها تلقائياً مع الفواتير أو يمكن إضافتها يدوياً.');
                return;
            }
            entries.forEach(entry => {
                const row = journalTbody.insertRow();
                row.innerHTML = `
                    <td>${entry.date}</td><td>${entry.desc}</td>
                    <td class="text-red-600">${sanitizeHTML(getAccountName(entry.debit))}</td>
                    <td class="text-green-600">${sanitizeHTML(getAccountName(entry.credit))}</td>
                    <td class="font-mono">${formatCurrency(entry.amount)}</td>
                    <td><button class="btn ${entry.source ? 'btn-secondary' : 'btn-warning'} btn-sm" ${entry.source ? 'disabled' : ''} title="${entry.source ? 'لا يمكن عكس قيد تلقائي' : 'عكس القيد'}" onclick="reverseJournalEntry('${entry.id}')"><i class="fas fa-undo"></i></button></td>`;
            });
        }

        function renderChart() {
            const chartTbody = $('#tblChart tbody');
            const accounts = db.chart.sort((a, b) => a.no.localeCompare(b.no));

            chartTbody.innerHTML = '';
            if (accounts.length === 0) {
                renderEmptyRow(chartTbody, 4, 'الدليل المحاسبي فارغ. قم بتهيئة النظام لإضافة الدليل الافتراضي.');
                return;
            }
            accounts.forEach(acc => {
                const row = chartTbody.insertRow();
                row.innerHTML = `
                    <td>${acc.no}</td><td class="font-bold">${acc.name}</td>
                    <td><span class="chip chip-info">${acc.type}</span></td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteAccount('${acc.no}')"><i class="fas fa-trash"></i></button></td>`;
            });
        }

        function renderSettings() {
            $('#settingCompanyName').value = db.settings.companyName;
            $('#settingCompanyAddress').value = db.settings.companyAddress;
            $('#settingCompanyTaxId').value = db.settings.companyTaxId;
            $('#settingCompanyPhone').value = db.settings.companyPhone;
            
            const logoPreview = $('#logoPreview');
            if (db.settings.companyLogo) {
                logoPreview.src = db.settings.companyLogo;
                logoPreview.classList.remove('hidden');
            } else {
                logoPreview.classList.add('hidden');
            }

            $('#settingLowStock').value = db.settings.inventory.lowStockThreshold;
            $('#settingExpiryWarning').value = db.settings.inventory.expiryWarningDays;

            // Report Settings
            const reportSettings = db.settings.report || emptyDB.settings.report;
            $('#settingReportColor').value = reportSettings.headerColor;
            $('#settingLogoPosition').value = reportSettings.logoPosition;
            $('#settingCustomField1Label').value = reportSettings.customField1Label;
            $('#settingCustomField1Value').value = reportSettings.customField1Value;
            $('#settingCustomField2Label').value = reportSettings.customField2Label;
            $('#settingCustomField2Value').value = reportSettings.customField2Value;

            // Accounting Links
            const links = db.settings.accountingLinks;
            const setupLinkSelect = (selector, type, value) => {
                const el = $(selector);
                if (!el) return;
                el.innerHTML = '<option value="">-- حدد الحساب --</option>';
                db.chart.filter(a => a.type === type).forEach(acc => {
                    el.innerHTML += `<option value="${acc.no}">${sanitizeHTML(acc.name)} (${acc.no})</option>`;
                });
                el.value = value;
                el.classList.toggle('border-red-500', !value);
                el.classList.toggle('focus:ring-red-500', !value);
            };

            setupLinkSelect('#linkSales', 'income', links.sales);
            setupLinkSelect('#linkCash', 'cash', links.cash);
            setupLinkSelect('#linkCogs', 'expense', links.cogs);
            setupLinkSelect('#linkReceivablesParent', 'receivable', links.receivablesParent);
            setupLinkSelect('#linkInventory', 'asset', links.inventory);
            setupLinkSelect('#linkAccountsPayable', 'payable', links.accountsPayable);
            setupLinkSelect('#linkSalesDiscount', 'expense', links.salesDiscount);
            setupLinkSelect('#linkSalesReturns', 'income', links.salesReturns);
            setupLinkSelect('#linkSamplesExpense', 'expense', links.samplesExpense);
            setupLinkSelect('#linkBonusExpense', 'expense', links.bonusExpense);
        }

        function renderCustomerAccountLinkOptions() {
            const select = $('#customerAccountLink');
            select.innerHTML = '<option value="auto">-- إنشاء حساب جديد تلقائياً --</option>';
            
            const linkedAccounts = db.customers.map(c => c.accountNo);
            const availableAccounts = db.chart.filter(acc => acc.type === 'receivable' && !linkedAccounts.includes(acc.no));

            availableAccounts.forEach(acc => {
                select.innerHTML += `<option value="${acc.no}">${sanitizeHTML(acc.name)} (${acc.no})</option>`;
            });
        }

        function renderSupplierAccountLinkOptions() {
            const select = $('#supplierAccountLink');
            select.innerHTML = '<option value="auto">-- إنشاء حساب جديد تلقائياً --</option>';
            
            const linkedAccounts = db.suppliers.map(s => s.accountNo);
            const availableAccounts = db.chart.filter(acc => acc.type === 'payable' && !linkedAccounts.includes(acc.no));

            availableAccounts.forEach(acc => {
                select.innerHTML += `<option value="${acc.no}">${sanitizeHTML(acc.name)} (${acc.no})</option>`;
            });
        }

        function renderReceiptsForm() {
            $('#receiptDate').valueAsDate = new Date();
            const customerSelect = $('#receiptCustomer');
            customerSelect.innerHTML = '<option value="">-- اختر عميل --</option>';
            db.customers.forEach(c => {
                // Check if customer has any outstanding balance
                const hasDue = db.invoices.some(inv => inv.customerId === c.id && (inv.total - inv.paidAmount > 0));
                if (hasDue) {
                    customerSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                }
            });
            $('#receiptInvoice').innerHTML = '<option value="">-- اختر فاتورة --</option>';
            $('#receiptAmount').value = '';
            $('#receiptDesc').value = '';
            $('#addToCollector').checked = false;
        }

        // --- Action Functions ---
        function autoCreateAccount(parentAccNo, entityName, accountType, accountPrefix) {
            if (!parentAccNo) {
                showAlert(`الرجاء تحديد الحساب الأب لـ ${accountPrefix} في الإعدادات أولاً`, 'error');
                return null;
            }

            const childAccounts = db.chart.filter(a => a.no.startsWith(parentAccNo) && a.no !== parentAccNo);
            const lastAccNo = childAccounts.length > 0 
                ? Math.max(...childAccounts.map(a => parseInt(a.no))) 
                : parseInt(parentAccNo + '000');
            
            const newAccNo = (lastAccNo + 1).toString();
            
            db.chart.push({ no: newAccNo, name: `${accountPrefix} - ${entityName}`, type: accountType });
            return newAccNo;
        }

        function addCustomer() {
            const name = $('#customerName').value.trim();
            if (!name) return showAlert('اسم العميل مطلوب', 'error');
            
            const accountSelection = $('#customerAccountLink').value;
            let newAccNo;

            if (accountSelection === 'auto') {
                newAccNo = autoCreateAccount(db.settings.accountingLinks.receivablesParent, name, 'receivable', 'ذمم');
                if (!newAccNo) return; // Stop if account creation failed
            } else {
                newAccNo = accountSelection;
                if (db.customers.some(c => c.accountNo === newAccNo)) return showAlert('هذا الحساب مربوط بالفعل بعميل آخر.', 'error');
            }

            db.customers.push({ id: generateId(), name, phone: $('#customerPhone').value, address: $('#customerAddress').value, accountNo: newAccNo });
            saveDB();
            renderAll(); // Render all to reflect changes in customers, chart, etc.
            $('#customerName').value = $('#customerPhone').value = $('#customerAddress').value = '';
            $('#formAddCustomer').classList.add('hidden');
            showAlert('تم إضافة العميل وربطه بالحساب بنجاح.');
        }

        function addSupplier() {
            const name = $('#supplierName').value.trim();
            if (!name) return showAlert('اسم المورد مطلوب', 'error');
            
            const accountSelection = $('#supplierAccountLink').value;
            let newAccNo;

            if (accountSelection === 'auto') {
                newAccNo = autoCreateAccount(db.settings.accountingLinks.accountsPayable, name, 'payable', 'ذمم');
                if (!newAccNo) return; // Stop if account creation failed
            } else {
                newAccNo = accountSelection;
                if (db.suppliers.some(s => s.accountNo === newAccNo)) return showAlert('هذا الحساب مربوط بالفعل بمورد آخر.', 'error');
            }

            db.suppliers.push({ id: generateId(), name, phone: $('#supplierPhone').value, address: $('#supplierAddress').value, accountNo: newAccNo });
            saveDB();
            renderAll(); // Render all to reflect changes in suppliers, chart, etc.
            $('#supplierName').value = $('#supplierPhone').value = $('#supplierAddress').value = '';
            $('#formAddSupplier').classList.add('hidden');
            showAlert('تم إضافة المورد وربطه بالحساب بنجاح.');
        }

        function populateReturnInvoicesForCustomer(customerId) {
            const invoiceSelect = $('#returnInvoice');
            invoiceSelect.innerHTML = '<option value="">-- اختر فاتورة --</option>';
            if (customerId) {
                db.invoices.filter(inv => inv.customerId === customerId).forEach(inv => {
                    invoiceSelect.innerHTML += `<option value="${inv.id}">#${inv.id.slice(-6)} - ${inv.date}</option>`;
                });
            }
            $('#tblReturnItems tbody').innerHTML = '';
            $('#salesReturnTotal').textContent = formatCurrency(0);
        }

        function initiateSalesReturn(invoiceId) {
            const inv = db.invoices.find(i => i.id === invoiceId);
            if (!inv) return;
            showTab('sales-returns');
            
            // Set the customer and trigger change to load invoices
            const customerSelect = $('#returnCustomer');
            customerSelect.value = inv.customerId;
            
            // Directly populate the invoices for the selected customer
            populateReturnInvoicesForCustomer(inv.customerId);

            // Now that the options are populated, we can select the correct one
            // and trigger its change event to load the items.
            const invoiceSelect = $('#returnInvoice');
            invoiceSelect.value = invoiceId;
            invoiceSelect.dispatchEvent(new Event('change'));
        }

        function populateReturnPurchasesForSupplier(supplierId) {
            const invoiceSelect = $('#purchaseReturnInvoice');
            invoiceSelect.innerHTML = '<option value="">-- اختر فاتورة --</option>';
            if (supplierId) {
                db.purchases.filter(p => p.supplierId === supplierId).forEach(p => {
                    invoiceSelect.innerHTML += `<option value="${p.id}">#${p.id.slice(-6)} - ${p.date}</option>`;
                });
            }
            $('#tblPurchaseReturnItems tbody').innerHTML = '';
            $('#purchaseReturnTotal').textContent = formatCurrency(0);
        }

        function initiatePurchaseReturn(purchaseId) {
            const p = db.purchases.find(p => p.id === purchaseId);
            if (!p) return;
            showTab('purchase-returns');

            const supplierSelect = $('#purchaseReturnSupplier');
            supplierSelect.value = p.supplierId;
            populateReturnPurchasesForSupplier(p.supplierId);

            const purchaseSelect = $('#purchaseReturnInvoice');
            purchaseSelect.value = purchaseId;
            purchaseSelect.dispatchEvent(new Event('change'));
        }

        function addItem() {
            const name = $('#itemName').value.trim();
            const sellPrice = parseFloat($('#itemSellPrice').value);
            if (!name || isNaN(sellPrice)) return showAlert('الرجاء تعبئة اسم الصنف وسعر البيع', 'error');

            db.items.push({
                id: generateId(), name,
                scientificName: $('#itemScientificName').value.trim(),
                unit: $('#itemUnit').value.trim() || 'قطعة',
                purchasePrice: parseFloat($('#itemPurchasePrice').value) || 0,
                sellPrice, qty: 0, expiryDate: $('#itemExpiryDate').value,
                bonusRatioCredit: parseInt($('#itemBonusRatioCredit').value) || 0,
                bonusRatioCash: parseInt($('#itemBonusRatioCash').value) || 0
            });
            saveDB();
            renderAll();
            resetItemForm();
            showAlert('تم إضافة الصنف بنجاح. أضف كمية عبر فاتورة شراء.');
        }

        function editItem(itemId) {
            const item = db.items.find(i => i.id === itemId);
            if (!item) return;

            editingItemId = itemId;

            $('#itemName').value = item.name;
            $('#itemScientificName').value = item.scientificName;
            $('#itemUnit').value = item.unit;
            $('#itemPurchasePrice').value = item.purchasePrice;
            $('#itemSellPrice').value = item.sellPrice;
            $('#itemExpiryDate').value = item.expiryDate || '';
            $('#itemBonusRatioCredit').value = item.bonusRatioCredit || 0;
            $('#itemBonusRatioCash').value = item.bonusRatioCash || 0;

            $('#formAddItem h3').textContent = 'تعديل بيانات الصنف';
            $('#btnAddItem').innerHTML = '<i class="fas fa-check"></i> تحديث الصنف (F9)';
            $('#formAddItem').classList.remove('hidden');
            $('#itemName').focus();
        }

        function updateItem() {
            if (!editingItemId) return;

            const itemIndex = db.items.findIndex(i => i.id === editingItemId);
            if (itemIndex === -1) {
                showAlert('خطأ: الصنف المراد تعديله غير موجود.', 'error');
                return resetItemForm();
            }

            const name = $('#itemName').value.trim();
            const sellPrice = parseFloat($('#itemSellPrice').value);
            if (!name || isNaN(sellPrice)) return showAlert('الرجاء تعبئة اسم الصنف وسعر البيع', 'error');

            const item = db.items[itemIndex];
            Object.assign(item, { name, scientificName: $('#itemScientificName').value.trim(), unit: $('#itemUnit').value.trim() || 'قطعة', purchasePrice: parseFloat($('#itemPurchasePrice').value) || 0, sellPrice, expiryDate: $('#itemExpiryDate').value, bonusRatioCredit: parseInt($('#itemBonusRatioCredit').value) || 0, bonusRatioCash: parseInt($('#itemBonusRatioCash').value) || 0 });

            saveDB();
            showAlert('تم تحديث الصنف بنجاح.');
            resetItemForm();
            renderAll();
        }

        function addAccount() {
            const accNo = $('#accNo').value.trim();
            const accName = $('#accName').value.trim();
            const accType = $('#accType').value;
            if (!accNo || !accName) return showAlert('رقم واسم الحساب مطلوبان', 'error');
            if (db.chart.some(a => a.no === accNo)) return showAlert('رقم الحساب موجود بالفعل', 'error');
            db.chart.push({ no: accNo, name: accName, type: accType });
            saveDB();
            renderChart();
            renderJournal();
            renderSettings();
            $('#accNo').value = $('#accName').value = '';
            $('#formAddAcc').classList.add('hidden');
            showAlert('تم إضافة الحساب بنجاح');
        }

        function addEntry() {
            const date = $('#jDate').value;
            const desc = $('#jDesc').value.trim();
            const debit = $('#jDebit').value;
            const credit = $('#jCredit').value;
            const amount = parseFloat($('#jAmount').value);

            if (!date || !desc || !debit || !credit || isNaN(amount) || amount <= 0) {
                return showAlert('الرجاء تعبئة جميع حقول القيد بشكل صحيح.', 'error');
            }
            db.journal.push({ id: generateId(), date, desc, debit, credit, amount, curr: 'YER' });
            saveDB();
            renderJournal();
            renderDashboard();
            $('#jDesc').value = $('#jAmount').value = '';
            showAlert('تم إضافة القيد بنجاح');
        }

        function editInvoiceItem(index) {
            const itemToEdit = currentInvoiceItems[index];
            if (!itemToEdit) return;

            // Load data into input fields
            $('#invoiceItem').value = itemToEdit.id;
            $('#invoiceQty').value = itemToEdit.qty;
            $('#invoicePrice').value = itemToEdit.price;

            // Trigger change on item select to update available qty display
            $('#invoiceItem').dispatchEvent(new Event('change')); // Remove from array
            removeInvoiceItem(index, false); // Don't ask for confirmation
            $('#invoiceQty').focus();
        }

        function resetItemForm() {
            editingItemId = null;
            const form = $('#formAddItem');
            form.classList.add('hidden');
            form.querySelectorAll('input').forEach(i => i.value = '');
            $('#formAddItem h3').textContent = 'بيانات الصنف الجديد';
            $('#btnAddItem').innerHTML = '<i class="fas fa-check"></i> حفظ الصنف (F9)';
        }

        function editPurchaseItem(index) {
            const itemToEdit = currentPurchaseItems[index];
            if (!itemToEdit) return;

            // Load data into input fields
            $('#purchaseItem').value = itemToEdit.id;
            $('#purchaseQty').value = itemToEdit.qty;
            $('#purchasePrice').value = itemToEdit.price;
            $('#purchaseProdDate').value = itemToEdit.prodDate || '';
            $('#purchaseExpDate').value = itemToEdit.expDate || '';

            // Remove from array
            removePurchaseItem(index, false); // Don't ask for confirmation
            $('#purchaseQty').focus();
        }


        function validateInvoiceQty() {
            const qtyInput = $('#invoiceQty');
            const addButton = $('#btnAddInvoiceItem');
            const itemId = $('#invoiceItem').value;
            
            if (!itemId) { // No item selected
                qtyInput.classList.remove('border-red-500', 'focus:ring-red-500');
                addButton.disabled = true;
                return;
            }

            const item = db.items.find(i => i.id === itemId);
            const qty = parseInt(qtyInput.value);

            if (isNaN(qty) || qty <= 0 || qty > item.qty) {
                qtyInput.classList.add('border-red-500', 'focus:ring-red-500');
                addButton.disabled = true;
            } else {
                qtyInput.classList.remove('border-red-500', 'focus:ring-red-500');
                addButton.disabled = false;
            }
        }

        function validatePurchaseQty() {
            const qtyInput = $('#purchaseQty');
            const addButton = $('#btnAddPurchaseItem');
            const qty = parseInt(qtyInput.value);
            addButton.disabled = (isNaN(qty) || qty <= 0);
        }

        function addInvoiceItem() {
            const itemId = $('#invoiceItem').value;
            const qty = parseInt($('#invoiceQty').value);
            if (!itemId || isNaN(qty) || qty <= 0) return showAlert('اختر صنف وكمية صحيحة', 'error');

            const item = db.items.find(i => i.id === itemId);
            const qtyAlreadyInCart = currentInvoiceItems.filter(ci => ci.id === item.id).reduce((sum, ci) => sum + ci.qty, 0);

            // Bonus logic
            const invoiceType = $('#invoiceType').value;
            const bonusRatio = (invoiceType === 'credit') ? item.bonusRatioCredit : item.bonusRatioCash;
            let bonusQty = 0;
            if (bonusRatio > 0 && qty >= bonusRatio) {
                bonusQty = Math.floor(qty / bonusRatio);
            }

            // Check stock for main quantity + bonus quantity
            if (qty + bonusQty > item.qty - qtyAlreadyInCart) {
                return showAlert(`الكمية المطلوبة (مع البونص) غير متوفرة. المتوفر: ${item.qty - qtyAlreadyInCart}`, 'error');
            }

            currentInvoiceItems.push({ id: item.id, name: item.name, qty, price: item.sellPrice, isBonus: false });

            if (bonusQty > 0) {
                currentInvoiceItems.push({ id: item.id, name: `${item.name} (بونص)`, qty: bonusQty, price: 0, isBonus: true, bonusFor: item.id });
                showAlert(`تمت إضافة ${bonusQty} كبونص`, 'info');
            }
            renderInvoices();
            $('#invoiceItem').value = '';
            $('#invoiceQty').value = 1;
            $('#invoiceDiscount').value = '';
            $('#invoicePrice').value = '';
            $('#invoiceItem').focus();
        }

        function removeInvoiceItem(index) {
            const doRemove = arguments.length > 1 && !arguments[1] ? true : confirm('هل أنت متأكد من حذف هذا الصنف من الفاتورة؟');
            if (doRemove) {
                currentInvoiceItems.splice(index, 1);
                renderInvoiceItemsTable();
                validateInvoiceQty();
            }
        }

        function addDisbursementItem() {
            const itemId = $('#disbursementItem').value;
            const qty = parseInt($('#disbursementQty').value);
            if (!itemId || isNaN(qty) || qty <= 0) return showAlert('اختر صنف وكمية صحيحة', 'error');

            const item = db.items.find(i => i.id === itemId);
            if (qty > item.qty) return showAlert(`الكمية المطلوبة غير متوفرة. المتوفر: ${item.qty}`, 'error');

            currentDisbursementItems.push({ id: item.id, name: item.name, qty, purchasePrice: item.purchasePrice || 0 });
            renderInventoryDisbursement();
            $('#disbursementItem').value = '';
            $('#disbursementQty').value = 1;
            $('#disbursementItem').focus();
        }

        function removeDisbursementItem(index) {
            currentDisbursementItems.splice(index, 1);
            renderDisbursementItemsTable();
        }

        function clearDisbursement() {
            currentDisbursementItems = [];
            renderInventoryDisbursement();
        }

        function saveInvoice() {
            // If we are in edit mode, call the update function instead
            if (editingInvoiceId) {
                updateInvoice();
                return;
            }

            const invoiceType = $('#invoiceType').value;
            const customerId = $('#invoiceCustomer').value;
            if (!customerId) return showAlert('الرجاء اختيار العميل لجميع أنواع الفواتير', 'error');
            if (currentInvoiceItems.length === 0) return showAlert('الفاتورة فارغة!', 'error');
            if (!db.settings.accountingLinks.sales || !db.settings.accountingLinks.inventory || !db.settings.accountingLinks.cogs || !db.settings.accountingLinks.cash || !db.settings.accountingLinks.salesDiscount || !db.settings.accountingLinks.bonusExpense) {
                return showAlert('الرجاء تحديد حسابات الربط (المبيعات، الصندوق، المخزون، تكلفة المبيعات، الخصم، البونص) في الإعدادات أولاً.', 'error');
            }

            const customer = db.customers.find(c => c.id === customerId);
            const subtotal = currentInvoiceItems.filter(i => !i.isBonus).reduce((sum, item) => sum + (item.qty * item.price), 0);
            const discount = parseFloat($('#invoiceDiscount').value) || 0;
            const total = subtotal - discount;
            const invoiceId = generateId();
            const date = $('#invoiceDate').value;

            const invoice = {
                id: invoiceId,
                customerId: customerId,
                customerName: customer.name,
                notes: $('#invoiceNotes').value.trim(),
                items: currentInvoiceItems, // Includes bonus items
                discount: discount,
                total: total, type: invoiceType,
                paidAmount: 0, // All invoices start with 0 paid
                payments: []
            };

            let debitAccount;
            if (invoiceType === 'cash') {
                debitAccount = customer.accountNo; // Always debit customer first
                invoice.paidAmount = total;
                // Add a payment record for consistency in reports, even though the journal entry is direct
                invoice.payments.push({
                    date: date,
                    amount: total,
                    journalId: null, // No separate journal entry for this payment
                    desc: 'سداد نقدي عند البيع'
                });
            } else { // credit or cash-pending
                debitAccount = customer.accountNo;
            }
            if (!debitAccount) {
                return showAlert('خطأ: لم يتم تحديد حساب المدين. تأكد من ربط العميل بحساب أو تحديد حساب الصندوق في الإعدادات.', 'error');
            }
            db.invoices.push(invoice);

            currentInvoiceItems.forEach(invoiceItem => {
                const stockItem = db.items.find(i => i.id === invoiceItem.id);
                if (stockItem) stockItem.qty -= invoiceItem.qty;
            });

            // Journal Entry for Revenue & Discount
            const salesAccount = db.settings.accountingLinks.sales;
            const discountAccount = db.settings.accountingLinks.salesDiscount;

            // 1. Record the gross sale: Dr Customer (A/R), Cr Sales
            db.journal.push({ id: generateId(), date, desc: `فاتورة مبيعات للعميل ${customer.name}`, debit: debitAccount, credit: salesAccount, amount: subtotal, curr: 'YER', source: { type: 'invoice', id: invoiceId } });

            // 2. If there's a discount, record it: Dr Sales Discount, Cr Customer (A/R)
            if (discount > 0) {
                db.journal.push({ id: generateId(), date, desc: `خصم مسموح به للفاتورة #${invoiceId.slice(-6)}`, debit: discountAccount, credit: debitAccount, amount: discount, curr: 'YER', source: { type: 'invoice_discount', id: invoiceId } });
            }

            // If it's a cash invoice, we also need a payment journal entry
            if (invoiceType === 'cash') {
                const paymentJournalId = generateId();
                db.journal.push({
                    id: paymentJournalId,
                    date: date,
                    desc: `تحصيل نقدي لفاتورة #${invoiceId.slice(-6)}`,
                    debit: db.settings.accountingLinks.cash,
                    credit: customer.accountNo,
                    amount: total,
                    curr: 'YER',
                    source: { type: 'payment', invoiceId: invoiceId }
                });
                // Link the payment record to this journal entry
                invoice.payments[0].journalId = paymentJournalId;
            }

            // Journal Entry for Cost of Goods Sold (COGS) and Bonus Expense
            const cogsAccount = db.settings.accountingLinks.cogs;
            const inventoryAccount = db.settings.accountingLinks.inventory;
            const bonusExpenseAccount = db.settings.accountingLinks.bonusExpense;

            const cogsTotal = currentInvoiceItems.filter(i => !i.isBonus).reduce((sum, invItem) => {
                const stockItem = db.items.find(i => i.id === invItem.id);
                return sum + (invItem.qty * (stockItem?.purchasePrice || 0));
            }, 0);

            const bonusTotalCost = currentInvoiceItems.filter(i => i.isBonus).reduce((sum, invItem) => {
                const stockItem = db.items.find(i => i.id === invItem.id);
                return sum + (invItem.qty * (stockItem?.purchasePrice || 0));
            }, 0);

            if (cogsTotal > 0) {
                db.journal.push({ id: generateId(), date, desc: `تكلفة البضاعة المباعة للفاتورة #${invoiceId.slice(-6)}`, debit: cogsAccount, credit: inventoryAccount, amount: cogsTotal, curr: 'YER', source: { type: 'invoice_cogs', id: invoiceId } });
            }

            if (bonusTotalCost > 0) {
                db.journal.push({ id: generateId(), date, desc: `تكلفة البونص للفاتورة #${invoiceId.slice(-6)}`, debit: bonusExpenseAccount, credit: inventoryAccount, amount: bonusTotalCost, curr: 'YER', source: { type: 'invoice_bonus', id: invoiceId } });
            }

            saveDB();
            showAlert('تم حفظ الفاتورة وتحديث المخزون والقيود');
            clearInvoice();
            showTab('invoice-list');
        }

        function saveInventoryDisbursement() {
            const date = $('#disbursementDate').value;
            const notes = $('#disbursementNotes').value.trim();
            if (!date || !notes) return showAlert('التاريخ والبيان مطلوبان', 'error');
            if (currentDisbursementItems.length === 0) return showAlert('لم يتم إضافة أي أصناف!', 'error');
            if (!db.settings.accountingLinks.samplesExpense || !db.settings.accountingLinks.inventory) {
                return showAlert('الرجاء تحديد حساب مصروفات العينات وحساب المخزون في الإعدادات.', 'error');
            }

            const disbursementId = generateId();
            const totalCost = currentDisbursementItems.reduce((sum, item) => sum + (item.qty * item.purchasePrice), 0);

            db.inventoryDisbursements.push({ id: disbursementId, date, notes, items: currentDisbursementItems, totalCost });

            currentDisbursementItems.forEach(item => { db.items.find(i => i.id === item.id).qty -= item.qty; });

            db.journal.push({ id: generateId(), date, desc: notes, debit: db.settings.accountingLinks.samplesExpense, credit: db.settings.accountingLinks.inventory, amount: totalCost, curr: 'YER', source: { type: 'disbursement', id: disbursementId } });

            saveDB();
            showAlert('تم حفظ أمر الصرف وتحديث المخزون.');
            clearDisbursement();
            renderAll();
        }

        function updateInvoice() {
            const originalInvoiceIndex = db.invoices.findIndex(i => i.id === editingInvoiceId);
            if (originalInvoiceIndex === -1) {
                showAlert('خطأ: الفاتورة الأصلية غير موجودة.', 'error');
                return resetInvoiceForm();
            }
            const originalInvoice = db.invoices[originalInvoiceIndex];

            // Revert stock changes from original invoice
            originalInvoice.items.forEach(item => {
                const stockItem = db.items.find(i => i.id === item.id);
                if (stockItem) stockItem.qty += item.qty;
            });
            
            // Delete original journal entries
            db.journal = db.journal.filter(j => !(j.source && (
                (j.source.type === 'invoice' && j.source.id === editingInvoiceId) ||
                (j.source.type === 'invoice_cogs' && j.source.id === editingInvoiceId) ||
                (j.source.type === 'invoice_discount' && j.source.id === editingInvoiceId) ||
                (j.source.type === 'invoice_bonus' && j.source.id === editingInvoiceId)
            )));

            // Gather new data from form
            const date = $('#invoiceDate').value;
            const invoiceType = $('#invoiceType').value;
            const customerId = $('#invoiceCustomer').value;
            if (!customerId) return showAlert('الرجاء اختيار العميل', 'error');
            if (currentInvoiceItems.length === 0) return showAlert('الفاتورة فارغة!', 'error');

            const customer = db.customers.find(c => c.id === customerId);
            const subtotal = currentInvoiceItems.filter(i => !i.isBonus).reduce((sum, item) => sum + (item.qty * item.price), 0);
            const discount = parseFloat($('#invoiceDiscount').value) || 0;
            const total = subtotal - discount;

            // Apply new stock changes
            currentInvoiceItems.forEach(invoiceItem => {
                const stockItem = db.items.find(i => i.id === invoiceItem.id);
                if (stockItem) stockItem.qty -= invoiceItem.qty;
            });

            // Determine debit account
            const debitAccount = customer.accountNo;
            if (!debitAccount) return showAlert('خطأ: العميل غير مربوط بحساب.', 'error');

            const salesAccount = db.settings.accountingLinks.sales;
            const discountAccount = db.settings.accountingLinks.salesDiscount;
            const cogsAccount = db.settings.accountingLinks.cogs;
            const inventoryAccount = db.settings.accountingLinks.inventory;
            const bonusExpenseAccount = db.settings.accountingLinks.bonusExpense;

            // Create new journal entries
            db.journal.push({ id: generateId(), date, desc: `(تعديل) فاتورة مبيعات للعميل ${customer.name}`, debit: debitAccount, credit: salesAccount, amount: subtotal, curr: 'YER', source: { type: 'invoice', id: editingInvoiceId } });

            if (discount > 0) {
                db.journal.push({ id: generateId(), date, desc: `(تعديل) خصم مسموح به للفاتورة #${editingInvoiceId.slice(-6)}`, debit: discountAccount, credit: debitAccount, amount: discount, curr: 'YER', source: { type: 'invoice_discount', id: editingInvoiceId } });
            }

            const cogsTotal = currentInvoiceItems.filter(i => !i.isBonus).reduce((sum, invItem) => {
                const stockItem = db.items.find(i => i.id === invItem.id);
                return sum + (invItem.qty * (stockItem?.purchasePrice || 0));
            }, 0);
            const bonusTotalCost = currentInvoiceItems.filter(i => i.isBonus).reduce((sum, invItem) => {
                const stockItem = db.items.find(i => i.id === invItem.id);
                return sum + (invItem.qty * (stockItem?.purchasePrice || 0));
            }, 0);

            if (cogsTotal > 0) {
                db.journal.push({ id: generateId(), date, desc: `(تعديل) تكلفة البضاعة للفاتورة #${editingInvoiceId.slice(-6)}`, debit: cogsAccount, credit: inventoryAccount, amount: cogsTotal, curr: 'YER', source: { type: 'invoice_cogs', id: editingInvoiceId } });
            }
            if (bonusTotalCost > 0) {
                db.journal.push({ id: generateId(), date, desc: `(تعديل) تكلفة البونص للفاتورة #${editingInvoiceId.slice(-6)}`, debit: bonusExpenseAccount, credit: inventoryAccount, amount: bonusTotalCost, curr: 'YER', source: { type: 'invoice_bonus', id: editingInvoiceId } });
            }

            // Update the invoice object
            const updatedInvoice = {
                ...originalInvoice,
                date, customerId, customerName: customer.name,
                notes: $('#invoiceNotes').value.trim(),
                items: currentInvoiceItems,
                discount, total, type: invoiceType,
                // Keep payment info as is, since we block editing paid invoices
            };
            db.invoices[originalInvoiceIndex] = updatedInvoice;

            saveDB();
            showAlert('تم تحديث الفاتورة بنجاح.');
            resetInvoiceForm();
            showTab('invoice-list');
        }
        function resetInvoiceForm() {
            editingInvoiceId = null;
            currentInvoiceItems = [];
            renderInvoices();
            $('#invoiceNotes').value = '';
            $('#invoiceCustomer').value = '';
            // Reset UI texts
            $('#panel-invoices h2').textContent = 'فاتورة بيع جديدة';
            $('#btnSaveInvoice').innerHTML = '<i class="fas fa-save"></i> حفظ الفاتورة (F9)';
            $('#btnClearInvoice').innerHTML = '<i class="fas fa-eraser"></i> فاتورة جديدة (F7)';
        }

        function clearInvoice() {
            // Add confirmation if there are items in the current invoice
            if (currentInvoiceItems.length > 0 && !confirm('هل أنت متأكد؟ سيتم مسح جميع الأصناف من الفاتورة الحالية.')) {
                return; // Do nothing if user cancels
            }
            resetInvoiceForm();
        }

        function addPurchaseItem() {
            const itemId = $('#purchaseItem').value;
            const qty = parseInt($('#purchaseQty').value);
            const price = parseFloat($('#purchasePrice').value);
            const prodDate = $('#purchaseProdDate').value;
            const expDate = $('#purchaseExpDate').value;

            if (!expDate) {
                return showAlert('تاريخ الانتهاء إجباري.', 'error');
            }
            if (!itemId || isNaN(qty) || qty <= 0 || isNaN(price) || price < 0) return showAlert('اختر صنف وكمية وسعر شراء صحيح', 'error');

            const item = db.items.find(i => i.id === itemId);
            if (!item) {
                return showAlert('الصنف المختار غير صالح أو لم يعد موجوداً.', 'error');
            }
            currentPurchaseItems.push({ id: item.id, name: item.name, qty, price, prodDate, expDate });
            renderPurchases();

            // إعادة تعيين حقول الإدخال بعد الإضافة
            $('#purchaseItem').value = '';
            $('#purchaseQty').value = 1;
            $('#purchasePrice').value = '';
            $('#purchaseProdDate').value = '';
            $('#purchaseExpDate').value = '';
            $('#purchaseItem').focus();
        }

        function removePurchaseItem(index, withConfirmation = true) {
            const doRemove = !withConfirmation || confirm('هل أنت متأكد من حذف هذا الصنف من الفاتورة؟');
            if (doRemove) {
                currentPurchaseItems.splice(index, 1);
                renderPurchaseItemsTable();
                validatePurchaseQty();
            }
        }

        function savePurchaseInvoice() {
            // If we are in edit mode, call the update function instead
            if (editingPurchaseId) {
                updatePurchaseInvoice();
                return;
            }

            console.log('Attempting to save purchase invoice...');
            const supplierId = $('#purchaseSupplier').value;
            if (!supplierId) return showAlert('الرجاء اختيار المورد', 'error');
            if (currentPurchaseItems.length === 0) return showAlert('فاتورة الشراء فارغة!', 'error');

            const supplier = db.suppliers.find(s => s.id === supplierId);
            if (!supplier) {
                return showAlert('المورد المختار غير صالح. الرجاء تحديث الصفحة والمحاولة مرة أخرى.', 'error');
            }
            if (!supplier.accountNo) {
                return showAlert(`المورد "${supplier.name}" غير مربوط بحساب محاسبي.`, 'error');
            }
            if (!db.settings.accountingLinks.inventory) {
                return showAlert('الرجاء تحديد حساب المخزون في الإعدادات أولاً.', 'error');
            }

            const total = currentPurchaseItems.reduce((sum, item) => sum + (item.qty * item.price), 0);
            const purchaseId = generateId();

            db.purchases.push({
                id: purchaseId, date: $('#purchaseDate').value, supplierId, supplierName: supplier.name,
                notes: $('#purchaseNotes').value.trim(), items: currentPurchaseItems, total,
                paidAmount: 0,
                payments: []
            });

            currentPurchaseItems.forEach(purchaseItem => {
                const stockItem = db.items.find(i => i.id === purchaseItem.id);
                if (stockItem) {
                    stockItem.qty += purchaseItem.qty;
                    stockItem.purchasePrice = purchaseItem.price;
                    // New logic for expiry date
                    if (purchaseItem.expDate) {
                        // If the stock item has no expiry date, or the new one is sooner, update it.
                        if (!stockItem.expiryDate || new Date(purchaseItem.expDate) < new Date(stockItem.expiryDate)) {
                            stockItem.expiryDate = purchaseItem.expDate;
                        }
                    }
                }
            });

            db.journal.push({
                id: generateId(), date: $('#purchaseDate').value,
                desc: `فاتورة مشتريات من المورد ${supplier.name}`,
                debit: db.settings.accountingLinks.inventory, credit: supplier.accountNo,
                amount: total, curr: 'YER', source: { type: 'purchase', id: purchaseId }
            });

            saveDB();
            showAlert('تم حفظ فاتورة الشراء وتحديث المخزون والقيود');
            clearPurchaseInvoice();
            showTab('purchase-list');
        }

        function updatePurchaseInvoice() {
            console.log('Starting updatePurchaseInvoice for ID:', editingPurchaseId);
            // 1. Get original purchase to revert its effects
            const originalPurchaseIndex = db.purchases.findIndex(p => p.id === editingPurchaseId);
            if (originalPurchaseIndex === -1) {
                showAlert('خطأ: فاتورة الشراء الأصلية غير موجودة.', 'error');
                resetPurchaseForm();
                return;
            }
            const originalPurchase = db.purchases[originalPurchaseIndex];
            const affectedItemIds = new Set(originalPurchase.items.map(i => i.id));

            console.log('Original Purchase:', JSON.parse(JSON.stringify(originalPurchase)));
            // 2. Revert stock changes from original purchase
            originalPurchase.items.forEach(item => {
                const stockItem = db.items.find(i => i.id === item.id);
                if (stockItem) stockItem.qty -= item.qty;
            });
            console.log('Stock after reverting original items.');

            // 3. Delete original journal entry
            db.journal = db.journal.filter(j => !(j.source && j.source.type === 'purchase' && j.source.id === editingPurchaseId));

            // 4. Gather new data from form
            const supplierId = $('#purchaseSupplier').value;
            if (!supplierId) return showAlert('الرجاء اختيار المورد', 'error');
            if (currentPurchaseItems.length === 0) return showAlert('الفاتورة فارغة!', 'error');

            // Add new item IDs to the affected set
            currentPurchaseItems.forEach(item => affectedItemIds.add(item.id));

            const supplier = db.suppliers.find(s => s.id === supplierId);
            const total = currentPurchaseItems.reduce((sum, item) => sum + (item.qty * item.price), 0);
            console.log('New Purchase Total:', total);

            // 5. Apply new stock changes
            currentPurchaseItems.forEach(purchaseItem => {
                const stockItem = db.items.find(i => i.id === purchaseItem.id);
                if (stockItem) {
                    stockItem.qty += purchaseItem.qty;
                    stockItem.purchasePrice = purchaseItem.price; // Also update purchase price
                }
            });
            console.log('Stock after applying new items.');

            // 6. Create new journal entry
            db.journal.push({
                id: generateId(), date: $('#purchaseDate').value,
                desc: `(تعديل) فاتورة مشتريات من المورد ${supplier.name}`,
                debit: db.settings.accountingLinks.inventory, credit: supplier.accountNo,
                amount: total, curr: 'YER', source: { type: 'purchase', id: editingPurchaseId }
            });
            console.log('New Journal Entry created.');

            // 7. Update the purchase object in the database
            const updatedPurchase = {
                ...originalPurchase, // Keep original ID, payments etc.
                date: $('#purchaseDate').value,
                supplierId: supplierId,
                supplierName: supplier.name,
                notes: $('#purchaseNotes').value.trim(),
                items: currentPurchaseItems,
                total: total,
            };
            console.log('Updated Purchase Object:', JSON.parse(JSON.stringify(updatedPurchase)));
            db.purchases[originalPurchaseIndex] = updatedPurchase;

            // 8. Recalculate expiry for all affected items
            affectedItemIds.forEach(itemId => recalculateNearestExpiry(itemId));

            // 9. Save and reset
            saveDB();
            showAlert('تم تحديث فاتورة الشراء بنجاح.');
            resetPurchaseForm();
            showTab('purchase-list');
        }

        function resetPurchaseForm() {
            editingPurchaseId = null;
            currentPurchaseItems = [];
            renderPurchases();
            $('#purchaseNotes').value = '';
            $('#purchaseSupplier').value = '';
            $('#purchaseProdDate').value = '';
            $('#purchaseExpDate').value = '';
            // Reset UI texts
            $('#panel-purchases h2').textContent = 'فاتورة شراء جديدة';
            $('#btnSavePurchase').innerHTML = '<i class="fas fa-save"></i> حفظ (F9)';
            $('#btnClearPurchase').innerHTML = '<i class="fas fa-eraser"></i> جديد (F7)';
        }

        function clearPurchaseInvoice() {
            // Add confirmation if there are items in the current purchase
            if (currentPurchaseItems.length > 0 && !confirm('هل أنت متأكد؟ سيتم مسح جميع الأصناف من فاتورة الشراء الحالية.')) {
                return; // Do nothing if user cancels
            }
            resetPurchaseForm();
        }

        function deleteCustomer(customerId) {
            const customer = db.customers.find(c => c.id === customerId);
            if (!customer) return;
            if (db.journal.some(j => j.debit === customer.accountNo || j.credit === customer.accountNo)) {
                return showAlert('لا يمكن حذف العميل لوجود قيود مرتبطة به.', 'error');
            }
            if (confirm(`هل أنت متأكد من حذف العميل "${customer.name}"؟`)) {
                db.chart = db.chart.filter(acc => acc.no !== customer.accountNo);
                db.customers = db.customers.filter(c => c.id !== customerId);
                saveDB();
                renderAll();
                showAlert('تم حذف العميل بنجاح.');
            }
        }

        function deleteSupplier(supplierId) {
            const supplier = db.suppliers.find(s => s.id === supplierId);
            if (!supplier) return;
            if (db.journal.some(j => j.credit === supplier.accountNo)) {
                return showAlert('لا يمكن حذف المورد لوجود قيود مرتبطة به.', 'error');
            }
            if (confirm(`هل أنت متأكد من حذف المورد "${supplier.name}"؟`)) {
                db.chart = db.chart.filter(acc => acc.no !== supplier.accountNo);
                db.suppliers = db.suppliers.filter(s => s.id !== supplierId);
                saveDB();
                renderAll();
                showAlert('تم حذف المورد بنجاح.');
            }
        }

        function deletePurchaseInvoice(purchaseId) {
            if (!confirm('هل أنت متأكد من الحذف النهائي لهذه الفاتورة؟ لا يمكن التراجع عن هذا الإجراء. للإرجاع المحاسبي، استخدم زر "إرجاع".')) return;

            const purchaseIndex = db.purchases.findIndex(p => p.id === purchaseId);
            if (purchaseIndex === -1) return;
            const p = db.purchases[purchaseIndex];
            const affectedItemIds = new Set(p.items.map(i => i.id));

            // 1. Revert stock quantities
            p.items.forEach(purchaseItem => {
                const stockItem = db.items.find(i => i.id === purchaseItem.id);
                if (stockItem) {
                    stockItem.qty -= purchaseItem.qty;
                }
            });

            // 2. Find and delete the related journal entry
            const journalIdsToDelete = new Set();
            db.journal.forEach(j => {
                if (j.source && ((j.source.type === 'purchase' && j.source.id === purchaseId) || (j.source.type === 'payment_out' && j.source.purchaseId === purchaseId))) {
                    journalIdsToDelete.add(j.id);
                }
            });
            db.journal = db.journal.filter(j => !journalIdsToDelete.has(j.id));

            // 3. Delete the purchase invoice itself
            db.purchases.splice(purchaseIndex, 1);

            // 4. Recalculate expiry dates for affected items
            affectedItemIds.forEach(itemId => recalculateNearestExpiry(itemId));

            saveDB();
            renderAll();
            showAlert('تم حذف فاتورة الشراء نهائياً.');
        }

        function editInvoice(invoiceId) {
            const inv = db.invoices.find(i => i.id === invoiceId);
            if (!inv) return;

            if (inv.paidAmount > 0) {
                showAlert('لا يمكن تعديل فاتورة تم تسجيل دفعات عليها. يمكنك حذفها وإنشاء واحدة جديدة.', 'error');
                return;
            }

            editingInvoiceId = invoiceId;

            $('#invoiceCustomer').value = inv.customerId;
            $('#invoiceType').value = inv.type;
            $('#invoiceDate').value = inv.date;
            $('#invoiceNotes').value = inv.notes;
            $('#invoiceDiscount').value = inv.discount || '';
            currentInvoiceItems = JSON.parse(JSON.stringify(inv.items));

            $('#panel-invoices h2').textContent = `تعديل فاتورة بيع #${invoiceId.slice(-6)}`;
            $('#btnSaveInvoice').innerHTML = '<i class="fas fa-check"></i> تحديث الفاتورة (F9)';
            $('#btnClearInvoice').innerHTML = '<i class="fas fa-times"></i> إلغاء التعديل';

            renderInvoices();
            showTab('invoices');
        }

        function editPurchaseInvoice(purchaseId) {
            const p = db.purchases.find(p => p.id === purchaseId);
            if (!p) return;

            if ((p.paidAmount || 0) > 0) {
                showAlert('لا يمكن تعديل فاتورة شراء تم تسجيل دفعات عليها. يمكنك حذفها وإنشاء واحدة جديدة.', 'error');
                return;
            }

            editingPurchaseId = purchaseId;

            $('#purchaseSupplier').value = p.supplierId;
            $('#purchaseDate').value = p.date;
            $('#purchaseNotes').value = p.notes;
            currentPurchaseItems = JSON.parse(JSON.stringify(p.items));

            $('#panel-purchases h2').textContent = `تعديل فاتورة شراء #${purchaseId.slice(-6)}`;
            $('#btnSavePurchase').innerHTML = '<i class="fas fa-check"></i> تحديث الفاتورة (F9)';
            $('#btnClearPurchase').innerHTML = '<i class="fas fa-times"></i> إلغاء التعديل';

            renderPurchases();
            showTab('purchases');
        }

        function createCustomerRefund(customerId, amount, date, returnId) {
            const customer = db.customers.find(c => c.id === customerId);
            if (!customer) return;

            const journalId = generateId();
            const desc = `سند صرف آلي لمرتجع مبيعات #${returnId.slice(-6)}`;

            // Journal Entry: Dr Customer (to clear their credit), Cr Cash (money out)
            db.journal.push({
                id: journalId,
                date: date,
                desc: desc,
                debit: customer.accountNo,
                credit: db.settings.accountingLinks.cash,
                amount: amount,
                curr: 'YER',
                source: { type: 'sales_return_refund', returnId: returnId }
            });
            showAlert('تم إنشاء سند الصرف النقدي بنجاح.');
        }

        function createSupplierRefundReceipt(supplierId, amount, date, returnId) {
            const supplier = db.suppliers.find(s => s.id === supplierId);
            if (!supplier) return;

            const journalId = generateId();
            const desc = `سند قبض آلي لمرتجع مشتريات #${returnId.slice(-6)}`;

            // Journal Entry: Dr Cash (money in), Cr Supplier (to clear their debit)
            db.journal.push({
                id: journalId, date: date, desc: desc,
                debit: db.settings.accountingLinks.cash, credit: supplier.accountNo,
                amount: amount, curr: 'YER', source: { type: 'purchase_return_refund', returnId: returnId }
            });
            showAlert('تم تسجيل سند القبض النقدي بنجاح.');
        }

        function saveSalesReturn() {
            const customerId = $('#returnCustomer').value;
            const originalInvoiceId = $('#returnInvoice').value;
            const returnDate = $('#returnDate').value;

            if (!customerId || !originalInvoiceId || !returnDate) {
                return showAlert('الرجاء اختيار العميل والفاتورة الأصلية وتاريخ الإرجاع.', 'error');
            }

            if (!db.settings.accountingLinks.salesReturns || !db.settings.accountingLinks.cogs || !db.settings.accountingLinks.inventory) {
                return showAlert('الرجاء تحديد حسابات الربط (مرتجعات المبيعات، تكلفة المبيعات، المخزون) في الإعدادات أولاً.', 'error');
            }

            const returnedItems = [];
            let returnTotal = 0;
            const rows = $$('#tblReturnItems tbody tr');
            rows.forEach(row => {
                const qtyInput = row.querySelector('input.return-qty');
                const qty = parseInt(qtyInput.value) || 0;
                if (qty > 0) {
                    const item = {
                        id: row.dataset.itemId,
                        name: row.dataset.itemName,
                        qty: qty,
                        price: parseFloat(row.dataset.itemPrice)
                    };
                    returnedItems.push(item);
                    returnTotal += item.qty * item.price;
                }
            });

            if (returnedItems.length === 0) {
                return showAlert('لم يتم تحديد أي كميات للإرجاع.', 'error');
            }

            const originalInvoice = db.invoices.find(inv => inv.id === originalInvoiceId);
            if (!originalInvoice) {
                return showAlert('الفاتورة الأصلية غير موجودة.', 'error');
            }

            const customer = db.customers.find(c => c.id === customerId);
            const returnId = generateId();
            const journalId = generateId();

            // 1. Create Sales Return document
            db.salesReturns.push({
                id: returnId, date: returnDate, customerId, customerName: customer.name,
                originalInvoiceId, items: returnedItems, total: returnTotal, journalId
            });

            // 2. Update stock
            returnedItems.forEach(item => {
                const stockItem = db.items.find(i => i.id === item.id);
                if (stockItem) stockItem.qty += item.qty;
            });

            // 3. Create reversal journal entry
            db.journal.push({
                id: journalId, date: returnDate,
                desc: `مرتجع مبيعات من الفاتورة #${originalInvoiceId.slice(-6)}`,
                debit: db.settings.accountingLinks.salesReturns, // Debit Sales Returns (contra-revenue)
                credit: customer.accountNo, // Credit Customer Account
                amount: returnTotal, curr: 'YER',
                source: { type: 'sales_return', id: returnId, originalInvoiceId: originalInvoiceId }
            });
            
            // 4. Create inventory value journal entry
            const returnCostTotal = returnedItems.reduce((sum, retItem) => {
                const stockItem = db.items.find(i => i.id === retItem.id);
                return sum + (retItem.qty * (stockItem.purchasePrice || 0));
            }, 0);
            db.journal.push({
                id: generateId(), date: returnDate,
                desc: `إرجاع قيمة بضاعة للمخزون من مرتجع #${returnId.slice(-6)}`,
                debit: db.settings.accountingLinks.inventory, // Debit Inventory
                credit: db.settings.accountingLinks.cogs, // Credit COGS
                amount: returnCostTotal, curr: 'YER',
                source: { type: 'sales_return_cogs', id: returnId }
            });

            // Apply the return as a credit to the invoice
            originalInvoice.paidAmount += returnTotal;
            originalInvoice.payments.push({
                date: returnDate,
                amount: returnTotal,
                journalId: journalId,
                desc: `مرتجع مبيعات #${returnId.slice(-6)}`
            });

            // Check if the return resulted in a credit balance for the customer on this invoice
            const creditBalance = originalInvoice.paidAmount - originalInvoice.total;
            if (creditBalance > 0.01) {
                if (confirm(`هذا المرتجع أدى إلى وجود رصيد دائن للعميل بقيمة ${formatCurrency(creditBalance)}. هل تريد إصدار سند صرف نقدي بهذا المبلغ؟`)) {
                    createCustomerRefund(customerId, creditBalance, returnDate, returnId);
                    // Adjust the invoice's paid amount to match the total, as the rest is being refunded.
                    originalInvoice.paidAmount = originalInvoice.total;
                }
            }

            saveDB();
            renderAll();
            showAlert('تم حفظ مرتجع المبيعات.');
        }

        function savePurchaseReturn() {
            const supplierId = $('#purchaseReturnSupplier').value;
            const originalPurchaseId = $('#purchaseReturnInvoice').value;
            const returnDate = $('#purchaseReturnDate').value;

            if (!supplierId || !originalPurchaseId || !returnDate) {
                return showAlert('الرجاء اختيار المورد والفاتورة الأصلية وتاريخ الإرجاع.', 'error');
            }

            const returnedItems = [];
            let returnTotal = 0;
            let validationError = null;
            $$('#tblPurchaseReturnItems tbody tr').forEach(row => {
                if (validationError) return; // Stop processing if an error was found
                const qty = parseInt(row.querySelector('input.return-qty').value) || 0;
                if (qty > 0) {
                    const itemId = row.dataset.itemId;
                    const currentStock = db.items.find(i => i.id === itemId)?.qty || 0;
                    if (qty > currentStock) {
                        validationError = `لا يمكن إرجاع ${qty} من "${row.dataset.itemName}"، الكمية المتوفرة في المخزون هي ${currentStock} فقط.`;
                        return;
                    }
                    const item = { id: itemId, name: row.dataset.itemName, qty, price: parseFloat(row.dataset.itemPrice) };
                    returnedItems.push(item);
                    returnTotal += item.qty * item.price;
                }
            });

            if (validationError) {
                return showAlert(validationError, 'error');
            }
            if (returnedItems.length === 0) return showAlert('لم يتم تحديد أي كميات للإرجاع.', 'error');

            const originalPurchase = db.purchases.find(p => p.id === originalPurchaseId);
            if (!originalPurchase) return showAlert('الفاتورة الأصلية غير موجودة.', 'error');

            const supplier = db.suppliers.find(s => s.id === supplierId);
            const returnId = generateId();
            const journalId = generateId();

            db.purchaseReturns.push({
                id: returnId, date: returnDate, supplierId, supplierName: supplier.name,
                originalPurchaseId, items: returnedItems, total: returnTotal, journalId
            });

            returnedItems.forEach(item => { db.items.find(i => i.id === item.id).qty -= item.qty; });

            db.journal.push({
                id: journalId, date: returnDate, desc: `مرتجع مشتريات للفاتورة #${originalPurchaseId.slice(-6)}`,
                debit: supplier.accountNo, credit: db.settings.accountingLinks.inventory,
                amount: returnTotal, curr: 'YER', source: { type: 'purchase_return', id: returnId, originalPurchaseId }
            });

            // Apply the return as a credit to the original purchase invoice
            if (!originalPurchase.paidAmount) originalPurchase.paidAmount = 0;
            if (!originalPurchase.payments) originalPurchase.payments = [];
            originalPurchase.paidAmount += returnTotal;
            originalPurchase.payments.push({
                date: returnDate,
                amount: returnTotal,
                journalId: journalId,
                desc: `مرتجع مشتريات #${returnId.slice(-6)}`
            });

            const debitBalance = originalPurchase.paidAmount - originalPurchase.total;
            if (debitBalance > 0.01) {
                if (confirm(`هذا المرتجع أدى إلى وجود رصيد لنا لدى المورد بقيمة ${formatCurrency(debitBalance)}. هل تريد تسجيل سند قبض نقدي بهذا المبلغ؟`)) {
                    createSupplierRefundReceipt(supplierId, debitBalance, returnDate, returnId);
                    originalPurchase.paidAmount = originalPurchase.total;
                }
            }

            saveDB();
            renderAll();
            showAlert('تم حفظ مرتجع المشتريات.');
        }

        function deleteItem(itemId) {
            // In a real app, you'd check if the item is part of any invoice.
            // For simplicity, we allow deletion.
            if (confirm('هل أنت متأكد من حذف هذا الصنف؟ سيتم حذفه نهائياً.')) {
                db.items = db.items.filter(i => i.id !== itemId);
                saveDB();
                renderAll();
                showAlert('تم حذف الصنف بنجاح');
            }
        }

        function deleteSalesReturn(returnId) {
            if (!confirm('هل أنت متأكد من حذف هذا المرتجع؟ سيتم عكس تأثيره على المخزون والقيود.')) return;

            const returnIndex = db.salesReturns.findIndex(sr => sr.id === returnId);
            if (returnIndex === -1) return;
            const sr = db.salesReturns[returnIndex];

            // 1. Revert stock (add back to stock because it was returned from customer)
            sr.items.forEach(item => {
                const stockItem = db.items.find(i => i.id === item.id);
                if (stockItem) stockItem.qty -= item.qty;
            });

            // 2. Delete related journal entries (the return itself and any auto-refund)
            db.journal = db.journal.filter(j => !(j.source && (
                (j.source.type === 'sales_return' && j.source.id === returnId) ||
                (j.source.type === 'sales_return_cogs' && j.source.id === returnId) ||
                (j.source.type === 'sales_return_refund' && j.source.returnId === returnId)
            )));

            // 3. Delete the return document
            db.salesReturns.splice(returnIndex, 1);

            saveDB();
            renderAll();
            showAlert('تم حذف المرتجع بنجاح.');
        }

        function deletePurchaseReturn(returnId) {
            if (!confirm('هل أنت متأكد من حذف هذا المرتجع؟ سيتم عكس تأثيره على المخزون والقيود.')) return;
            const returnIndex = db.purchaseReturns.findIndex(pr => pr.id === returnId);
            if (returnIndex === -1) return;
            const pr = db.purchaseReturns[returnIndex];
            pr.items.forEach(item => { db.items.find(i => i.id === item.id).qty += item.qty; });
            db.journal = db.journal.filter(j => j.id !== pr.journalId);
            db.journal = db.journal.filter(j => !(j.source && j.source.type === 'purchase_return_refund' && j.source.returnId === returnId));
            db.purchaseReturns.splice(returnIndex, 1);
            saveDB(); renderAll(); showAlert('تم حذف مرتجع المشتريات بنجاح.');
        }

        function deleteInvoice(invoiceId) {
            if (!confirm('هل أنت متأكد من الحذف النهائي لهذه الفاتورة؟ لا يمكن التراجع عن هذا الإجراء. للإرجاع المحاسبي، استخدم زر "إرجاع".')) return;

            const invoiceIndex = db.invoices.findIndex(i => i.id === invoiceId);
            if (invoiceIndex === -1) return;
            const inv = db.invoices[invoiceIndex];

            // 1. Revert stock quantities
            inv.items.forEach(invoiceItem => {
                const stockItem = db.items.find(i => i.id === invoiceItem.id);
                if (stockItem) stockItem.qty += invoiceItem.qty;
            });

            // 2. Find and collect all related journal entry IDs
            const journalIdsToDelete = new Set();
            db.journal.forEach(j => {
                if (j.source && (
                    (j.source.type === 'invoice' && j.source.id === invoiceId) || 
                    (j.source.type === 'invoice_cogs' && j.source.id === invoiceId) ||
                    (j.source.type === 'payment' && j.source.invoiceId === invoiceId))) {
                    journalIdsToDelete.add(j.id);
                }
            });
            db.journal = db.journal.filter(j => !journalIdsToDelete.has(j.id));

            // 3. Delete the invoice itself
            db.invoices.splice(invoiceIndex, 1);

            saveDB();
            renderAll();
            showAlert('تم حذف الفاتورة وجميع الحركات المرتبطة بها بنجاح.');
        }

        function processPayment(invoiceId, paymentAmount, paymentDate, description, forCollector) {
            const inv = db.invoices.find(i => i.id === invoiceId);
            if (!inv) return { success: false, message: 'لم يتم العثور على الفاتورة.' };

            const remaining = inv.total - inv.paidAmount;
            if (paymentAmount <= 0 || paymentAmount > remaining + 0.001) {
                return { success: false, message: 'مبلغ الدفعة أكبر من المبلغ المتبقي.' };
            }

            const customer = db.customers.find(c => c.id === inv.customerId);
            if (!customer) return { success: false, message: 'لم يتم العثور على العميل المرتبط بالفاتورة.' };

            const journalId = generateId();
            const desc = description || `تحصيل دفعة لفاتورة #${inv.id.slice(-6)}`;
            db.journal.push({
                id: journalId,
                date: paymentDate,
                desc: desc,
                debit: db.settings.accountingLinks.cash,
                credit: customer.accountNo,
                amount: paymentAmount, curr: 'YER',
                source: { type: 'payment', invoiceId: inv.id }
            });

            inv.paidAmount += paymentAmount;
            inv.payments.push({ date: paymentDate, amount: paymentAmount, journalId: journalId, desc: desc, forCollector: forCollector });
            
            return { success: true };
        }

        function makePayment(invoiceId) {
            const inv = db.invoices.find(i => i.id === invoiceId);
            if (!inv) return;

            const remaining = inv.total - inv.paidAmount;
            const amountStr = prompt(`المبلغ المتبقي على الفاتورة: ${formatCurrency(remaining)}\nأدخل مبلغ الدفعة:`, remaining.toFixed(2));
            if (!amountStr) return;
            const amount = parseFloat(amountStr);
            
            const result = processPayment(invoiceId, amount, new Date().toISOString().split('T')[0], `دفعة سريعة للفاتورة #${invoiceId.slice(-6)}`);
            if (result.success) {
                saveDB();
                renderAll();
                showAlert('تم تسجيل الدفعة بنجاح.');
            } else {
                showAlert(result.message, 'error');
            }
        }

        function processOutgoingPayment(purchaseId, paymentAmount, paymentDate, description) {
            const p = db.purchases.find(p => p.id === purchaseId);
            if (!p) return { success: false, message: 'لم يتم العثور على فاتورة الشراء.' };

            const remaining = p.total - (p.paidAmount || 0);
            if (paymentAmount <= 0 || paymentAmount > remaining + 0.001) {
                return { success: false, message: 'مبلغ الدفعة أكبر من المبلغ المتبقي.' };
            }

            const supplier = db.suppliers.find(s => s.id === p.supplierId);
            if (!supplier) return { success: false, message: 'لم يتم العثور على المورد المرتبط بالفاتورة.' };

            const journalId = generateId();
            const desc = description || `سداد دفعة لفاتورة شراء #${p.id.slice(-6)}`;
            db.journal.push({
                id: journalId,
                date: paymentDate,
                desc: desc,
                debit: supplier.accountNo, // Debit supplier account
                credit: db.settings.accountingLinks.cash, // Credit cash
                amount: paymentAmount, curr: 'YER',
                source: { type: 'payment_out', purchaseId: p.id }
            });

            if (p.paidAmount === undefined) p.paidAmount = 0;
            if (!p.payments) p.payments = [];
            p.paidAmount += paymentAmount;
            p.payments.push({ date: paymentDate, amount: paymentAmount, journalId: journalId, desc: desc });
            
            return { success: true };
        }

        function makeOutgoingPayment(purchaseId) {
            const p = db.purchases.find(p => p.id === purchaseId);
            if (!p) return;

            const remaining = p.total - (p.paidAmount || 0);
            const amountStr = prompt(`المبلغ المتبقي على الفاتورة: ${formatCurrency(remaining)}\nأدخل مبلغ الدفعة:`, remaining.toFixed(2));
            if (!amountStr) return;
            const amount = parseFloat(amountStr);
            
            const result = processOutgoingPayment(purchaseId, amount, new Date().toISOString().split('T')[0], `دفعة سريعة لفاتورة شراء #${purchaseId.slice(-6)}`);
            if (result.success) {
                saveDB();
                renderAll();
                showAlert('تم تسجيل الدفعة بنجاح.');
            } else {
                showAlert(result.message, 'error');
            }
        }

        function savePayment() {
            const date = $('#paymentDate').value;
            const purchaseId = $('#paymentPurchaseInvoice').value;
            const amount = parseFloat($('#paymentAmount').value);
            const desc = $('#paymentDesc').value.trim();

            if (!date || !purchaseId || isNaN(amount) || amount <= 0) {
                return showAlert('الرجاء تعبئة جميع الحقول بشكل صحيح.', 'error');
            }

            const result = processOutgoingPayment(purchaseId, amount, date, desc);

            if (result.success) {
                saveDB();
                renderAll();
                showAlert('تم تسجيل المدفوعات بنجاح.');
                $('#formAddPayment').classList.add('hidden');
            } else {
                showAlert(result.message, 'error');
            }
        }

        function addReceipt() {
            const date = $('#receiptDate').value;
            const invoiceId = $('#receiptInvoice').value;
            const amount = parseFloat($('#receiptAmount').value);
            const desc = $('#receiptDesc').value.trim();
            const forCollector = $('#addToCollector').checked;

            if (!date || !invoiceId || isNaN(amount) || amount <= 0) {
                return showAlert('الرجاء تعبئة جميع الحقول بشكل صحيح.', 'error');
            }

            const result = processPayment(invoiceId, amount, date, desc, forCollector);

            if (result.success) {
                saveDB();
                renderAll();
                showAlert('تم تسجيل المقبوضات بنجاح.');
                $('#formAddReceipt').classList.add('hidden');
                $('#addToCollector').checked = false;
            } else {
                showAlert(result.message, 'error');
            }
        }

        function deleteAccount(accNo) {
            if (db.journal.some(j => j.debit === accNo || j.credit === accNo)) {
                return showAlert('لا يمكن حذف الحساب لوجود قيود مرتبطة به.', 'error');
            }
            if (Object.values(db.settings.accountingLinks).includes(accNo)) {
                return showAlert('لا يمكن حذف الحساب لأنه مربوط في الإعدادات.', 'error');
            }
            if (confirm(`هل أنت متأكد من حذف الحساب رقم ${accNo}؟`)) {
                db.chart = db.chart.filter(acc => acc.no !== accNo);
                saveDB();
                renderAll();
                showAlert('تم حذف الحساب بنجاح.');
            }
        }

        function reverseJournalEntry(journalId) {
            const entry = db.journal.find(j => j.id === journalId);
            if (!entry) return;
            if (entry && entry.source) {
                return showAlert('لا يمكن عكس قيد مرتبط بعملية تلقائية.', 'error');
            }
            if (confirm('هل أنت متأكد من عكس هذا القيد؟ سيتم إنشاء قيد جديد معاكس له.')) {
                db.journal.push({
                    id: generateId(),
                    date: new Date().toISOString().split('T')[0],
                    desc: `عكس القيد: ${entry.desc}`,
                    debit: entry.credit, // Swapped
                    credit: entry.debit, // Swapped
                    amount: entry.amount,
                    curr: entry.curr,
                    source: { type: 'reversal', originalId: journalId }
                });
                saveDB();
                renderAll();
                showAlert('تم عكس القيد بنجاح.');
            }
        }

        function deleteReceipt(invoiceId, journalId) {
            if (!confirm('هل أنت متأكد من حذف هذا القبض؟ سيتم عكس تأثيره المحاسبي.')) return;

            const inv = db.invoices.find(i => i.id === invoiceId);
            if (!inv) return showAlert('لم يتم العثور على الفاتورة الأصلية.', 'error');

            const paymentIndex = inv.payments.findIndex(p => p.journalId === journalId);
            if (paymentIndex === -1) return showAlert('لم يتم العثور على حركة القبض.', 'error');

            const payment = inv.payments[paymentIndex];

            inv.paidAmount -= payment.amount;
            inv.payments.splice(paymentIndex, 1);
            db.journal = db.journal.filter(j => j.id !== journalId);

            saveDB();
            renderAll();
            showAlert('تم حذف القبض بنجاح.');
        }

        function deleteOutgoingPayment(purchaseId, journalId) {
            if (!confirm('هل أنت متأكد من حذف هذا الصرف؟ سيتم عكس تأثيره المحاسبي.')) return;

            const p = db.purchases.find(p => p.id === purchaseId);
            if (!p) return showAlert('لم يتم العثور على فاتورة الشراء الأصلية.', 'error');

            const paymentIndex = p.payments.findIndex(payment => payment.journalId === journalId);
            if (paymentIndex === -1) return showAlert('لم يتم العثور على حركة الصرف.', 'error');

            const payment = p.payments[paymentIndex];
            p.paidAmount -= payment.amount;
            p.payments.splice(paymentIndex, 1);
            db.journal = db.journal.filter(j => j.id !== journalId);
            saveDB(); renderAll(); showAlert('تم حذف الصرف بنجاح.');
        }

        function printInvoice(invoiceId) {
            const inv = db.invoices.find(i => i.id === invoiceId);
            if (!inv) return;

            const logoEl = $('#invoice-print-area #print-logo-invoice');
            if (db.settings.companyLogo) {
                logoEl.src = db.settings.companyLogo;
                logoEl.classList.remove('hidden');
            } else {
                logoEl.classList.add('hidden');
            }

            $('#print-company-name').textContent = db.settings.companyName;
            $('#print-company-address').textContent = db.settings.companyAddress;
            $('#print-company-tax-id').textContent = db.settings.companyTaxId ? `الرقم الضريبي: ${db.settings.companyTaxId}` : '';
            $('#print-company-phone').textContent = db.settings.companyPhone;
            $('#print-customer-name').textContent = inv.customerName;
            $('#print-invoice-id').textContent = '#' + inv.id.slice(-6);
            $('#print-invoice-notes').textContent = inv.notes || '-';
            $('#print-invoice-date').textContent = inv.date;

            const itemsTbody = $('#print-invoice-items');
            itemsTbody.innerHTML = '';
            inv.items.forEach(item => {
                itemsTbody.innerHTML += `<tr class="border-b border-gray-200">
                    <td class="text-right p-2">${item.name}</td><td class="text-center p-2">${item.qty}</td>
                    <td class="text-center p-2 font-mono">${formatCurrency(item.price)}</td>
                    <td class="text-left p-2 font-mono">${formatCurrency(item.qty * item.price)}</td></tr>`;
            });

            const subtotal = inv.total + (inv.discount || 0);
            $('#print-invoice-subtotal').textContent = formatCurrency(subtotal);
            $('#print-invoice-discount').textContent = `-${formatCurrency(inv.discount || 0)}`;
            $('#print-invoice-total').textContent = formatCurrency(inv.total);
            $('#print-invoice-paid').textContent = formatCurrency(inv.paidAmount || 0);
            $('#print-invoice-remaining').textContent = formatCurrency(inv.total - (inv.paidAmount || 0));
            
            const printArea = $('#invoice-print-area');
            $('body').classList.add('is-printing');
            printArea.classList.add('active-print');
            window.print();
            $('body').classList.remove('is-printing');
            printArea.classList.remove('active-print');
        }

        function printPurchaseInvoice(purchaseId) {
            const p = db.purchases.find(p => p.id === purchaseId);
            if (!p) return;

            const logoEl = $('#purchase-print-area #print-logo-purchase');
            if (db.settings.companyLogo) {
                logoEl.src = db.settings.companyLogo;
                logoEl.classList.remove('hidden');
            } else {
                logoEl.classList.add('hidden');
            }

            $('#print-purchase-company-name').textContent = db.settings.companyName;
            $('#print-purchase-company-address').textContent = db.settings.companyAddress;
            $('#print-purchase-tax-id').textContent = db.settings.companyTaxId ? `الرقم الضريبي: ${db.settings.companyTaxId}` : '';
            $('#print-purchase-company-phone').textContent = db.settings.companyPhone;
            $('#print-purchase-supplier-name').textContent = p.supplierName;
            $('#print-purchase-id').textContent = '#' + p.id.slice(-6);
            $('#print-purchase-notes').textContent = p.notes || '-';
            $('#print-purchase-date').textContent = p.date;

            const itemsTbody = $('#print-purchase-items');
            itemsTbody.innerHTML = '';
            p.items.forEach(item => {
                itemsTbody.innerHTML += `<tr class="border-b border-gray-200">
                    <td class="text-right p-2">${item.name}</td><td class="text-center p-2">${item.qty}</td>
                    <td class="text-center p-2 font-mono">${formatCurrency(item.price)}</td>
                    <td class="text-left p-2 font-mono">${formatCurrency(item.qty * item.price)}</td></tr>`;
            });

            $('#print-purchase-total').textContent = formatCurrency(p.total);
            
            const printArea = $('#purchase-print-area');
            $('body').classList.add('is-printing');
            printArea.classList.add('active-print');
            window.print();
            $('body').classList.remove('is-printing');
            printArea.classList.remove('active-print');
        }

        function printSalesReturn(returnId) {
            const sr = db.salesReturns.find(r => r.id === returnId);
            if (!sr) return;

            const printArea = $('#sales-return-print-area');
            const logoImg = db.settings.companyLogo ? `<img src="${db.settings.companyLogo}" alt="Logo" class="mx-auto max-h-24 mb-4">` : '';
            let html = `
                <div class="print-header">
                    ${logoImg}
                    <h1>${sanitizeHTML(db.settings.companyName)}</h1>
                    <p>${sanitizeHTML(db.settings.companyAddress)} | ${sanitizeHTML(db.settings.companyPhone)}</p>
                </div>
                <h2 class="text-2xl font-bold text-center my-6 border-y-2 py-2">مستند مرتجع مبيعات</h2>
                <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                    <div><strong>العميل:</strong> ${sanitizeHTML(sr.customerName)}</div>
                    <div class="text-left"><strong>رقم المرتجع:</strong> #${sr.id.slice(-6)}</div>
                    <div><strong>الفاتورة الأصلية:</strong> #${sr.originalInvoiceId.slice(-6)}</div>
                    <div class="text-left"><strong>التاريخ:</strong> ${sr.date}</div>
                </div>
                <table class="w-full text-sm">
                    <thead class="bg-gray-100"><tr><th class="text-right p-2">الصنف</th><th class="text-center p-2">الكمية المرتجعة</th><th class="text-center p-2">السعر</th><th class="text-left p-2">الإجمالي</th></tr></thead>
                    <tbody>`;
            sr.items.forEach(item => {
                html += `<tr class="border-b border-gray-200"><td class="text-right p-2">${sanitizeHTML(item.name)}</td><td class="text-center p-2">${item.qty}</td><td class="text-center p-2 font-mono">${formatCurrency(item.price)}</td><td class="text-left p-2 font-mono">${formatCurrency(item.qty * item.price)}</td></tr>`;
            });
            html += `</tbody><tfoot><tr class="font-bold text-lg"><td colspan="3" class="text-left p-2 border-t-2 border-gray-400">إجمالي المرتجع</td><td class="text-left p-2 border-t-2 border-gray-400 font-mono">${formatCurrency(sr.total)}</td></tr></tfoot></table>
                <div class="grid grid-cols-2 gap-8 mt-16 text-sm"><div class="text-center">...........................<br><strong>توقيع المستلم</strong></div><div class="text-center">...........................<br><strong>توقيع أمين المخازن</strong></div></div>`;
            
            printArea.innerHTML = html;
            $('body').classList.add('is-printing');
            printArea.classList.add('active-print');
            window.print();
            $('body').classList.remove('is-printing');
            printArea.classList.remove('active-print');
        }

        function printPurchaseReturn(returnId) {
            const pr = db.purchaseReturns.find(r => r.id === returnId);
            if (!pr) return;

            const printArea = $('#purchase-return-print-area');
            const logoImg = db.settings.companyLogo ? `<img src="${db.settings.companyLogo}" alt="Logo" class="mx-auto max-h-24 mb-4">` : '';
            let html = `
                <div class="print-header">
                    ${logoImg}
                    <h1>${sanitizeHTML(db.settings.companyName)}</h1>
                    <p>${sanitizeHTML(db.settings.companyAddress)} | ${sanitizeHTML(db.settings.companyTaxId ? `الرقم الضريبي: ${db.settings.companyTaxId}` : '')} | ${sanitizeHTML(db.settings.companyPhone)}</p>
                </div>
                <h2 class="text-2xl font-bold text-center my-6 border-y-2 py-2">مستند مرتجع مشتريات</h2>
                <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                    <div><strong>المورد:</strong> ${sanitizeHTML(pr.supplierName)}</div>
                    <div class="text-left"><strong>رقم المرتجع:</strong> #${pr.id.slice(-6)}</div>
                    <div><strong>الفاتورة الأصلية:</strong> #${pr.originalPurchaseId.slice(-6)}</div>
                    <div class="text-left"><strong>التاريخ:</strong> ${pr.date}</div>
                </div>
                <table class="w-full text-sm">
                    <thead class="bg-gray-100"><tr><th class="text-right p-2">الصنف</th><th class="text-center p-2">الكمية المرتجعة</th><th class="text-center p-2">السعر</th><th class="text-left p-2">الإجمالي</th></tr></thead>
                    <tbody>`;
            pr.items.forEach(item => {
                html += `<tr class="border-b border-gray-200"><td class="text-right p-2">${sanitizeHTML(item.name)}</td><td class="text-center p-2">${item.qty}</td><td class="text-center p-2 font-mono">${formatCurrency(item.price)}</td><td class="text-left p-2 font-mono">${formatCurrency(item.qty * item.price)}</td></tr>`;
            });
            html += `</tbody><tfoot><tr class="font-bold text-lg"><td colspan="3" class="text-left p-2 border-t-2 border-gray-400">إجمالي المرتجع</td><td class="text-left p-2 border-t-2 border-gray-400 font-mono">${formatCurrency(pr.total)}</td></tr></tfoot></table>
                <div class="grid grid-cols-2 gap-8 mt-16 text-sm"><div class="text-center">...........................<br><strong>توقيع المستلم</strong></div><div class="text-center">...........................<br><strong>توقيع أمين المخازن</strong></div></div>`;
            
            printArea.innerHTML = html;
            $('body').classList.add('is-printing');
            printArea.classList.add('active-print');
            window.print();
            $('body').classList.remove('is-printing');
            printArea.classList.remove('active-print');
        }

        function printDisbursement(disbursementId) {
            const d = db.inventoryDisbursements.find(d => d.id === disbursementId);
            if (!d) return;

            const printArea = $('#disbursement-print-area');
            const logoImg = db.settings.companyLogo ? `<img src="${db.settings.companyLogo}" alt="Logo" class="mx-auto max-h-24 mb-4">` : '';
            let html = `
                <div class="print-header">
                    ${logoImg}
                    <h1>${sanitizeHTML(db.settings.companyName)}</h1>
                    <p>${sanitizeHTML(db.settings.companyAddress)} | ${sanitizeHTML(db.settings.companyPhone)}</p>
                </div>
                <h2 class="text-2xl font-bold text-center my-6 border-y-2 py-2">أمر صرف مخزني</h2>
                <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                    <div><strong>البيان:</strong> ${sanitizeHTML(d.notes)}</div>
                    <div class="text-left"><strong>رقم الأمر:</strong> #${d.id.slice(-6)}</div>
                    <div></div>
                    <div class="text-left"><strong>التاريخ:</strong> ${d.date}</div>
                </div>
                <table class="w-full text-sm">
                    <thead class="bg-gray-100"><tr><th class="text-right p-2">الصنف</th><th class="text-center p-2">الكمية المصروفة</th></tr></thead>
                    <tbody>`;
            d.items.forEach(item => {
                html += `<tr class="border-b border-gray-200"><td class="text-right p-2">${sanitizeHTML(item.name)}</td><td class="text-center p-2">${item.qty}</td></tr>`;
            });
            html += `</tbody></table>
                <div class="grid grid-cols-2 gap-8 mt-16 text-sm"><div class="text-center">...........................<br><strong>توقيع المستلم</strong></div><div class="text-center">...........................<br><strong>توقيع أمين المخازن</strong></div></div>`;
            
            printArea.innerHTML = html;
            $('body').classList.add('is-printing');
            printArea.classList.add('active-print');
            window.print();
            $('body').classList.remove('is-printing');
            printArea.classList.remove('active-print');
        }

        function printReceipt(invoiceId, journalId) {
            const inv = db.invoices.find(i => i.id === invoiceId);
            const payment = inv?.payments.find(p => p.journalId === journalId);
            if (!inv || !payment) return showAlert('لم يتم العثور على بيانات القبض للطباعة.', 'error');

            const printArea = $('#receipt-print-area');
            const logoImg = db.settings.companyLogo ? `<img src="${db.settings.companyLogo}" alt="Logo" class="mx-auto max-h-24 mb-4">` : '';
            const html = `
                <div class="print-header">
                    ${logoImg}
                    <h1>${sanitizeHTML(db.settings.companyName)}</h1>
                    <p>${sanitizeHTML(db.settings.companyAddress)} | ${sanitizeHTML(db.settings.companyPhone)}</p>
                </div>
                <h2 class="text-2xl font-bold text-center my-6 border-y-2 py-2">سند قبض</h2>
                <div class="grid grid-cols-2 gap-4 text-sm mb-6">
                    <div><strong>من العميل:</strong> ${sanitizeHTML(inv.customerName)}</div>
                    <div class="text-left"><strong>رقم السند:</strong> #${payment.journalId.slice(-6)}</div>
                    <div><strong>الفاتورة المرتبطة:</strong> #${inv.id.slice(-6)}</div>
                    <div class="text-left"><strong>التاريخ:</strong> ${payment.date}</div>
                </div>
                <div class="p-4 border rounded-lg bg-gray-50 text-lg">
                    <p><strong>المبلغ:</strong> <span class="font-mono font-bold">${formatCurrency(payment.amount)}</span></p>
                    <p class="mt-2"><strong>المبلغ كتابة:</strong> ${tafqeet(payment.amount)}</p>
                    <p class="mt-2"><strong>وذلك مقابل:</strong> ${sanitizeHTML(payment.desc)}</p>
                </div>
                <div class="grid grid-cols-2 gap-8 mt-16 text-sm">
                    <div class="text-center">...........................<br><strong>توقيع المستلم</strong></div>
                    <div class="text-center">...........................<br><strong>توقيع أمين الصندوق</strong></div>
                </div>`;
            
            printArea.innerHTML = html;
            $('body').classList.add('is-printing');
            printArea.classList.add('active-print');
            window.print();
            $('body').classList.remove('is-printing');
            printArea.classList.remove('active-print');
        }

        function printPayment(purchaseId, journalId) {
            const p = db.purchases.find(p => p.id === purchaseId);
            const payment = p?.payments.find(pm => pm.journalId === journalId);
            if (!p || !payment) return showAlert('لم يتم العثور على بيانات الصرف للطباعة.', 'error');

            const printArea = $('#payment-print-area');
            const logoImg = db.settings.companyLogo ? `<img src="${db.settings.companyLogo}" alt="Logo" class="mx-auto max-h-24 mb-4">` : '';
            const html = `
                <div class="print-header">
                    ${logoImg}<h1>${sanitizeHTML(db.settings.companyName)}</h1><p>${sanitizeHTML(db.settings.companyAddress)} | ${sanitizeHTML(db.settings.companyPhone)}</p>
                </div>
                <h2 class="text-2xl font-bold text-center my-6 border-y-2 py-2">سند صرف</h2>
                <div class="grid grid-cols-2 gap-4 text-sm mb-6">
                    <div><strong>إلى المورد:</strong> ${sanitizeHTML(p.supplierName)}</div><div class="text-left"><strong>رقم السند:</strong> #${payment.journalId.slice(-6)}</div>
                    <div><strong>الفاتورة المرتبطة:</strong> #${p.id.slice(-6)}</div><div class="text-left"><strong>التاريخ:</strong> ${payment.date}</div>
                </div>
                <div class="p-4 border rounded-lg bg-gray-50 text-lg"><p><strong>المبلغ:</strong> <span class="font-mono font-bold">${formatCurrency(payment.amount)}</span></p><p class="mt-2"><strong>المبلغ كتابة:</strong> ${tafqeet(payment.amount)}</p><p class="mt-2"><strong>وذلك مقابل:</strong> ${sanitizeHTML(payment.desc)}</p></div>
                <div class="grid grid-cols-2 gap-8 mt-16 text-sm"><div class="text-center">...........................<br><strong>توقيع المستلم</strong></div><div class="text-center">...........................<br><strong>توقيع أمين الصندوق</strong></div></div>`;
            
            printArea.innerHTML = html;
            $('body').classList.add('is-printing');
            printArea.classList.add('active-print');
            window.print();
            $('body').classList.remove('is-printing');
            printArea.classList.remove('active-print');
        }

        function printCurrentReport() {
            const printArea = $('#report-print-area');
            const reportOutput = $('#report-output');
            if (!reportOutput || reportOutput.children.length === 0 || !currentReportType) {
                showAlert('لا يوجد تقرير فعال لطباعته.', 'error');
                return;
            }

            // Just copy the generated report content directly for printing
            const contentToPrint = reportOutput.innerHTML;
            printArea.innerHTML = contentToPrint;

            $('body').classList.add('is-printing');
            printArea.classList.add('active-print');
            window.print();
            $('body').classList.remove('is-printing');
            printArea.classList.remove('active-print');
            printArea.innerHTML = ''; // Clear after printing
        }

        function viewPurchaseFromPayments(purchaseId) {
            showTab('purchase-list');
            // In a more complex app, you'd scroll to and highlight the invoice.
        }

        function viewInvoiceFromReceipts(invoiceId) {
            showTab('invoice-list');
            // In a more complex app, you'd scroll to and highlight the invoice.
        }

        // --- Calculation/Helper Functions ---
        const getAccountName = (no) => {
            const acc = db.chart.find(a => a.no === no);
            return acc ? acc.name : `حساب ${no}`;
        };

        function getBalances() {
            const balances = {};
            db.chart.forEach(acc => {
                balances[acc.no] = { debit: 0, credit: 0, balance: 0, acc: acc };
            });
            db.journal.forEach(entry => {
                if (balances[entry.debit]) balances[entry.debit].debit += entry.amount;
                if (balances[entry.credit]) balances[entry.credit].credit += entry.amount;
                if (isNaN(balances[entry.debit]?.debit) || isNaN(balances[entry.credit]?.credit)) console.warn('NaN detected in journal processing', entry);
            });
            for (const accNo in balances) {
                const item = balances[accNo];
                const isDebitNatural = ['asset', 'expense', 'receivable', 'cash'].includes(item.acc.type);
                item.balance = isDebitNatural ? (item.debit - item.credit) : (item.credit - item.debit);
            }
            return balances;
        }

        function getBalancesAsOf(asOfDate) {
            const balances = {};
            db.chart.forEach(acc => {
                balances[acc.no] = { debit: 0, credit: 0, balance: 0, acc: acc };
            });

            db.journal.filter(j => new Date(j.date) <= asOfDate).forEach(entry => {
                if (balances[entry.debit]) balances[entry.debit].debit += entry.amount;
                if (balances[entry.credit]) balances[entry.credit].credit += entry.amount;
            });

            for (const accNo in balances) {
                const item = balances[accNo];
                const isDebitNatural = ['asset', 'expense', 'receivable', 'cash'].includes(item.acc.type);
                item.balance = isDebitNatural ? (item.debit - item.credit) : (item.credit - item.debit);
            }
            return balances;
        }

        function recalculateNearestExpiry(itemId) {
            const stockItem = db.items.find(i => i.id === itemId);
            if (!stockItem) return;

            let nearestExpiry = null;
            // Scan all purchases for this item
            db.purchases.forEach(p => {
                p.items.forEach(item => {
                    if (item.id === itemId && item.expDate) {
                        const expDate = new Date(item.expDate);
                        if (!nearestExpiry || expDate < nearestExpiry) {
                            nearestExpiry = expDate;
                        }
                    }
                });
            });

            stockItem.expiryDate = nearestExpiry ? nearestExpiry.toISOString().split('T')[0] : '';
        }

        function showTab(tabName) {
            const subTabButton = $(`button.sub-nav-tab[data-tab="${tabName}"]`);
            
            if (subTabButton) {
                const subNav = subTabButton.closest('.sub-nav');
                const groupName = subNav.dataset.subNavFor;
                const mainTabButton = $(`button.nav-tab[data-group="${groupName}"]`);
                
                if (mainTabButton) {
                    if (!mainTabButton.classList.contains('active')) {
                        mainTabButton.click();
                    }
                    if (!subTabButton.classList.contains('active')) {
                        subTabButton.click();
                    }
                }
            } else {
                // It's a standalone main tab
                const mainTabButton = $(`button.nav-tab[data-group="${tabName}"]`);
                if (mainTabButton) {
                    mainTabButton.click();
                }
            }
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            const handleTabClick = (tabName) => {
                $$('main > section[id^="panel-"]').forEach(p => p.classList.add('hidden'));
                const panel = $(`#panel-${tabName}`);
                if (panel) panel.classList.remove('hidden');

                // Specific render calls for each tab
                if (tabName === 'dashboard') renderDashboard();
                if (tabName === 'inventory') renderInventory();
                if (tabName === 'invoice-list') renderInvoiceList();
                if (tabName === 'sales-returns') renderSalesReturns();
                if (tabName === 'disbursement-list') renderDisbursementList();
                if (tabName === 'payments') renderPayments();
                if (tabName === 'purchase-returns') renderPurchaseReturns();
                if (tabName === 'purchase-list') renderPurchaseList();
                if (tabName === 'purchases') renderPurchases();
                if (tabName === 'receipts') renderReceipts();
                if (tabName === 'invoices') renderInvoices();
                if (tabName === 'customers') renderCustomers();
                if (tabName === 'suppliers') renderSuppliers();
                if (tabName === 'items') renderItems();
                if (tabName === 'chart') renderChart();
                if (tabName === 'journal') renderJournal();
                if (tabName === 'settings') renderSettings();
            };

            // Main Navigation
            $$('#main-nav .nav-tab').forEach(tab => tab.addEventListener('click', (e) => {
                const clickedTab = e.currentTarget;
                const groupName = clickedTab.dataset.group;

                $$('#main-nav .nav-tab').forEach(t => t.classList.remove('active'));
                clickedTab.classList.add('active');

                $$('.sub-nav').forEach(sn => sn.classList.add('hidden'));

                const subNav = $(`[data-sub-nav-for="${groupName}"]`);
                if (subNav) {
                    subNav.classList.remove('hidden');
                    subNav.querySelector('.sub-nav-tab').click();
                } else {
                    handleTabClick(groupName);
                }
            }));

            // Sub Navigation
            $$('.sub-nav-tab').forEach(tab => tab.addEventListener('click', (e) => {
                const clickedTab = e.currentTarget;
                const tabName = clickedTab.dataset.tab;

                clickedTab.parentElement.querySelectorAll('.sub-nav-tab').forEach(t => t.classList.remove('active'));
                clickedTab.classList.add('active');

                handleTabClick(tabName);
            }));

            // Reports
            $('#btnPrintReport').addEventListener('click', printCurrentReport);
            
            // Search functionality
            $('#searchCustomers').addEventListener('input', renderCustomers);
            $('#searchSuppliers').addEventListener('input', renderSuppliers);
            $('#searchItems').addEventListener('input', renderItems);
            $('#searchInvoices').addEventListener('input', renderInvoiceList);
            $('#searchPurchases').addEventListener('input', renderPurchaseList);
            $('#searchDisbursements').addEventListener('input', renderDisbursementList);

            // Keyboard Shortcuts
            document.addEventListener('keydown', (e) => {
                const activePanel = $$('main > section:not(.hidden)')[0];
                if (!activePanel) return;

                // F9 for Save/Add
                if (e.key === 'F9') {
                    e.preventDefault();
                    const saveButton = activePanel.querySelector('.hotkey-save');
                    if (saveButton && !saveButton.disabled) saveButton.click();
                }

                // F7 for New/Clear/Cancel
                if (e.key === 'F7') {
                    e.preventDefault();
                    const clearButton = activePanel.querySelector('.hotkey-clear');
                    if (clearButton && !clearButton.disabled) clearButton.click();
                }
                
                // F8 for Add Item to grid
                if (e.key === 'F8') {
                    e.preventDefault();
                    const actionButton = activePanel.querySelector('.hotkey-action');
                    if (actionButton && !actionButton.disabled) actionButton.click();
                }

                // Enter key for navigation
                if (e.key === 'Enter' && !e.shiftKey) {
                    const activeElement = document.activeElement;
                    if (activeElement.tagName === 'INPUT' || activeElement.tagName === 'SELECT') {
                        e.preventDefault();
                        const form = activeElement.closest('.card');
                        if (form) {
                            const focusable = Array.from(form.querySelectorAll('input:not([type="hidden"]):not(:disabled):not([readonly]), select:not(:disabled)'));
                            const index = focusable.indexOf(activeElement);
                            const nextElement = focusable[index + 1];
                            
                            if (nextElement) {
                                nextElement.focus();
                            } else {
                                const saveButton = form.querySelector('.hotkey-save');
                                if (saveButton && !saveButton.disabled) saveButton.click();
                            }
                        }
                    }
                }
            });

            // Toggle Add Forms
            $('#btnShowAddItem').addEventListener('click', () => {
                resetItemForm();
                $('#formAddItem').classList.remove('hidden');
                $('#itemName').focus();
            });
            $('#btnCancelAddItem').addEventListener('click', resetItemForm);
            
            $('#btnShowAddCustomer').addEventListener('click', () => {
                renderCustomerAccountLinkOptions();
                $('#formAddCustomer').classList.remove('hidden');
            });
            $('#btnCancelAddCustomer').addEventListener('click', () => $('#formAddCustomer').classList.add('hidden'));
            
            $('#btnShowAddSupplier').addEventListener('click', () => {
                renderSupplierAccountLinkOptions();
                $('#formAddSupplier').classList.remove('hidden');
            });
            $('#btnCancelAddSupplier').addEventListener('click', () => $('#formAddSupplier').classList.add('hidden'));

            $('#btnShowAddAcc').addEventListener('click', () => $('#formAddAcc').classList.remove('hidden'));
            $('#btnCancelAddAcc').addEventListener('click', () => $('#formAddAcc').classList.add('hidden'));

            $('#btnShowAddPayment').addEventListener('click', () => {
                renderPayments(); // Renders the form part
                $('#formAddPayment').classList.remove('hidden');
            });
            $('#btnCancelAddPayment').addEventListener('click', () => {
                $('#formAddPayment').classList.add('hidden');
            });

            $('#btnShowAddReceipt').addEventListener('click', () => {
                renderReceiptsForm();
                $('#formAddReceipt').classList.remove('hidden');
            });
            $('#btnCancelAddReceipt').addEventListener('click', () => {
                $('#formAddReceipt').classList.add('hidden');
                $('#addToCollector').checked = false;
            });

            // Actions
            $('#btnAddCustomer').addEventListener('click', addCustomer);
            $('#btnAddSupplier').addEventListener('click', addSupplier);
            $('#btnAddItem').addEventListener('click', () => {
                if (editingItemId) {
                    updateItem();
                } else {
                    addItem();
                }
            });
            $('#btnAddAcc').addEventListener('click', addAccount);
            $('#btnAddEntry').addEventListener('click', addEntry);
            $('#btnAddReceipt').addEventListener('click', addReceipt);
            $('#btnAddPayment').addEventListener('click', savePayment);
            $('#btnSaveSalesReturn').addEventListener('click', saveSalesReturn);
            $('#btnSaveDisbursement').addEventListener('click', saveInventoryDisbursement);
            $('#btnSavePurchaseReturn').addEventListener('click', savePurchaseReturn);

            // Invoice Actions
            $('#btnAddInvoiceItem').addEventListener('click', addInvoiceItem);
            $('#btnSaveInvoice').addEventListener('click', saveInvoice);
            $('#btnClearInvoice').addEventListener('click', clearInvoice);
            $('#invoiceItem').addEventListener('change', e => {
                validateInvoiceQty();
                const item = db.items.find(i => i.id === e.target.value);
                $('#invoicePrice').value = item ? item.sellPrice : '';
            });

            // Disbursement Actions
            $('#btnAddDisbursementItem').addEventListener('click', addDisbursementItem);
            $('#btnClearDisbursement').addEventListener('click', clearDisbursement);


            // Purchase Actions
            $('#btnAddPurchaseItem').addEventListener('click', addPurchaseItem);
            $('#btnSavePurchase').addEventListener('click', savePurchaseInvoice);
            $('#btnClearPurchase').addEventListener('click', clearPurchaseInvoice);
            $('#purchaseItem').addEventListener('change', e => {
                validatePurchaseQty();
                const item = db.items.find(i => i.id === e.target.value);
                if (item) {
                    $('#purchasePrice').value = item.purchasePrice || '';
                }
            });

            // Sales Return Actions
            $('#invoiceQty').addEventListener('input', validateInvoiceQty);
            $('#invoiceDiscount').addEventListener('input', renderInvoiceItemsTable);
            $('#purchaseQty').addEventListener('input', validatePurchaseQty);

            $('#returnCustomer').addEventListener('change', e => {
                populateReturnInvoicesForCustomer(e.target.value);
            });
            $('#returnInvoice').addEventListener('change', e => {
                const invoiceId = e.target.value;
                const tbody = $('#tblReturnItems tbody');
                tbody.innerHTML = '';
                if (!invoiceId) return;

                const availableQtyEl = $('#invoiceItemAvailableQty');
                const item = db.items.find(i => i.id === e.target.value);
                if (item) {
                    availableQtyEl.textContent = `المتوفر: ${item.qty}`;
                    $('#invoiceQty').setAttribute('max', item.qty);
                } else {
                    availableQtyEl.textContent = '';
                    $('#invoiceQty').removeAttribute('max');
                }

                const originalInvoice = db.invoices.find(inv => inv.id === invoiceId);
                const pastReturns = db.salesReturns.filter(sr => sr.originalInvoiceId === invoiceId);

                originalInvoice.items.forEach(item => {
                    let totalReturnedSoFar = 0;
                    pastReturns.forEach(sr => {
                        const returnedItem = sr.items.find(ri => ri.id === item.id);
                        if (returnedItem) totalReturnedSoFar += returnedItem.qty;
                    });
                    const maxReturnable = item.qty - totalReturnedSoFar;
                    if (maxReturnable > 0) {
                        const row = tbody.insertRow();
                        row.dataset.itemId = item.id;
                        row.dataset.itemName = item.name;
                        row.dataset.itemPrice = item.price;
                        row.innerHTML = `<td>${item.name}</td><td>${item.qty}</td>
                            <td><input type="number" class="input return-qty" value="0" min="0" max="${maxReturnable}"></td>
                            <td>${formatCurrency(item.price)}</td><td class="font-mono item-total">0.00</td>`;
                    }
                });
            });
            $('#tblReturnItems').addEventListener('input', e => {
                if (e.target.classList.contains('return-qty')) {
                    let grandTotal = 0;
                    $$('#tblReturnItems tbody tr').forEach(row => {
                        const qty = parseInt(row.querySelector('.return-qty').value) || 0;
                        const price = parseFloat(row.dataset.itemPrice);
                        const itemTotal = qty * price;
                        row.querySelector('.item-total').textContent = formatCurrency(itemTotal);
                        grandTotal += itemTotal;
                    });
                    $('#salesReturnTotal').textContent = formatCurrency(grandTotal);
                }
            });

            // Purchase Return Actions
            $('#purchaseReturnSupplier').addEventListener('change', e => {
                populateReturnPurchasesForSupplier(e.target.value);
            });
            $('#purchaseReturnInvoice').addEventListener('change', e => {
                const purchaseId = e.target.value;
                const tbody = $('#tblPurchaseReturnItems tbody');
                tbody.innerHTML = '';
                if (!purchaseId) return;

                const originalPurchase = db.purchases.find(p => p.id === purchaseId);
                const pastReturns = db.purchaseReturns.filter(pr => pr.originalPurchaseId === purchaseId);

                originalPurchase.items.forEach(item => {
                    const totalReturnedSoFar = pastReturns.flatMap(pr => pr.items).filter(ri => ri.id === item.id).reduce((sum, ri) => sum + ri.qty, 0);
                    const maxReturnableFromInvoice = item.qty - totalReturnedSoFar;
                    const currentStock = db.items.find(i => i.id === item.id)?.qty || 0;
                    const maxReturnable = Math.min(maxReturnableFromInvoice, currentStock);

                    if (maxReturnableFromInvoice > 0) { // Only show items that can still be returned from this invoice
                        const row = tbody.insertRow();
                        row.dataset.itemId = item.id;
                        row.dataset.itemName = item.name;
                        row.dataset.itemPrice = item.price;
                        row.innerHTML = `<td>${item.name}<br><small class="text-gray-500">المتوفر: ${currentStock}</small></td><td>${item.qty}</td>
                            <td><input type="number" class="input return-qty" value="0" min="0" max="${maxReturnable}" ${maxReturnable === 0 ? 'disabled' : ''}></td>
                            <td>${formatCurrency(item.price)}</td><td class="font-mono item-total">0.00</td>`;
                    }
                });
            });
            $('#tblPurchaseReturnItems').addEventListener('input', e => {
                if (e.target.classList.contains('return-qty')) {
                    let grandTotal = 0;
                    $$('#tblPurchaseReturnItems tbody tr').forEach(row => {
                        const qty = parseInt(row.querySelector('.return-qty').value) || 0;
                        const price = parseFloat(row.dataset.itemPrice);
                        const itemTotal = qty * price;
                        row.querySelector('.item-total').textContent = formatCurrency(itemTotal);
                        grandTotal += itemTotal;
                    });
                    $('#purchaseReturnTotal').textContent = formatCurrency(grandTotal);
                }
            });

            // Payment Form Actions
            $('#paymentSupplier').addEventListener('change', e => {
                const supplierId = e.target.value;
                const invoiceSelect = $('#paymentPurchaseInvoice');
                invoiceSelect.innerHTML = '<option value="">-- اختر فاتورة --</option>';
                if (supplierId) {
                    db.purchases
                      .filter(p => p.supplierId === supplierId && (p.total - (p.paidAmount || 0) > 0.001))
                      .forEach(p => {
                          const remaining = p.total - (p.paidAmount || 0);
                          invoiceSelect.innerHTML += `<option value="${p.id}">فاتورة #${p.id.slice(-6)} (المتبقي: ${formatCurrency(remaining)})</option>`;
                      });
                }
            });

            // Receipt Form Actions
            $('#receiptCustomer').addEventListener('change', e => {
                const customerId = e.target.value;
                const invoiceSelect = $('#receiptInvoice');
                invoiceSelect.innerHTML = '<option value="">-- اختر فاتورة --</option>';
                if (customerId) {
                    db.invoices
                      .filter(inv => inv.customerId === customerId && (inv.total - inv.paidAmount > 0.001))
                      .forEach(inv => {
                          const remaining = inv.total - inv.paidAmount;
                          invoiceSelect.innerHTML += `<option value="${inv.id}">فاتورة #${inv.id.slice(-6)} (المتبقي: ${formatCurrency(remaining)})</option>`;
                      });
                }
            });

            // Quick Entry Buttons
            $('#btnQuickInvoice').addEventListener('click', () => {
                const customerId = $('#jCustomer').value;
                if (!customerId) return showAlert('الرجاء اختيار عميل أولاً.', 'error');
                const customer = db.customers.find(c => c.id === customerId);
                $('#jDebit').value = customer.accountNo;
                $('#jCredit').value = db.settings.accountingLinks.sales;
                $('#jDesc').value = `فاتورة مبيعات للعميل ${customer.name}`;
            });
            $('#btnQuickPayment').addEventListener('click', () => {
                const customerId = $('#jCustomer').value;
                if (!customerId) return showAlert('الرجاء اختيار عميل أولاً.', 'error');
                const customer = db.customers.find(c => c.id === customerId);
                $('#jDebit').value = db.settings.accountingLinks.cash;
                $('#jCredit').value = customer.accountNo;
                $('#jDesc').value = `تحصيل دفعة من العميل ${customer.name}`;
            });

            // Settings
            $$('#panel-settings select').forEach(sel => sel.addEventListener('change', e => {
                const key = e.target.id.replace('link', '').charAt(0).toLowerCase() + e.target.id.slice(5); // e.g., linkSales -> sales
                if (db.settings.accountingLinks.hasOwnProperty(key)) db.settings.accountingLinks[key] = e.target.value;
                saveDB();
                showAlert('تم حفظ الإعدادات');
            }));
            $('#settingCompanyName').addEventListener('input', (e) => { db.settings.companyName = e.target.value; saveDB(); });
            $('#settingCompanyAddress').addEventListener('input', (e) => { db.settings.companyAddress = e.target.value; saveDB(); });
            $('#settingCompanyTaxId').addEventListener('input', (e) => { db.settings.companyTaxId = e.target.value; saveDB(); });
            $('#settingCompanyPhone').addEventListener('input', (e) => { db.settings.companyPhone = e.target.value; saveDB(); });
            $('#settingLowStock').addEventListener('input', (e) => { 
                db.settings.inventory.lowStockThreshold = parseInt(e.target.value) || 10; saveDB(); showAlert('تم حفظ الإعدادات'); 
            });
            $('#settingExpiryWarning').addEventListener('input', (e) => { 
                db.settings.inventory.expiryWarningDays = parseInt(e.target.value) || 90; saveDB(); showAlert('تم حفظ الإعدادات'); 
            });
            
            // New Report Settings Listeners
            const saveReportSetting = (key, value) => { db.settings.report[key] = value; saveDB(); showAlert('تم حفظ إعدادات التقرير'); };
            $('#settingReportColor').addEventListener('input', (e) => saveReportSetting('headerColor', e.target.value));
            $('#settingLogoPosition').addEventListener('change', (e) => saveReportSetting('logoPosition', e.target.value));
            $('#settingCustomField1Label').addEventListener('input', (e) => saveReportSetting('customField1Label', e.target.value));
            $('#settingCustomField1Value').addEventListener('input', (e) => saveReportSetting('customField1Value', e.target.value));
            $('#settingCustomField2Label').addEventListener('input', (e) => saveReportSetting('customField2Label', e.target.value));
            $('#settingCustomField2Value').addEventListener('input', (e) => saveReportSetting('customField2Value', e.target.value));

            // System
            $('#btnBackup').addEventListener('click', () => {
                const dataStr = JSON.stringify(db, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click(); URL.revokeObjectURL(url);
                showAlert('تم إنشاء نسخة احتياطية.');
            });
            $('#restoreFile').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const restoredDb = JSON.parse(event.target.result);
                        if (confirm('هل أنت متأكد من استعادة البيانات؟ سيتم الكتابة فوق جميع البيانات الحالية.')) {
                            db = restoredDb;
                            saveDB();
                            renderAll();
                            showAlert('تم استعادة البيانات بنجاح.');
                        }
                    } catch (err) { showAlert('ملف نسخة احتياطية غير صالح.', 'error'); }
                };
                reader.readAsText(file);
                e.target.value = ''; // Reset file input
            });
            $('#btnReset').addEventListener('click', resetSystem);
        }

        // --- Reports ---
        let currentReportType = null;

        function initializeReports() {
            // Set default dates to the current month
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            $('#report-from-date').valueAsDate = firstDayOfMonth;
            $('#report-to-date').valueAsDate = today;

            // Populate item selector for reports
            const itemSelector = $('#report-item-selector');
            if (itemSelector) {
                populateSelect(itemSelector, db.items, {
                    valueKey: 'id',
                    textKey: 'name',
                    placeholder: '-- اختر صنفاً --'
                });
                itemSelector.addEventListener('change', generateCurrentReport);
            }
            
            const commissionRateInput = $('#report-commission-rate');
            if (commissionRateInput) {
                commissionRateInput.addEventListener('input', generateCurrentReport);
            }

            // Event Listeners for report links
            $$('#reports-nav .report-link').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    $$('#reports-nav .report-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    currentReportType = link.dataset.report;

                    // Show/hide item selector based on report type
                    const reportItemSelectorContainer = $('#report-item-selector-container');
                    const commissionRateContainer = $('#report-commission-rate-container');

                    // Show/hide special inputs based on report type
                    const showItemSelector = currentReportType === 'item_movement';
                    const showCommissionRate = ['collector_commission', 'collector_receipts_detail'].includes(currentReportType);
                    reportItemSelectorContainer.classList.toggle('hidden', !showItemSelector);
                    commissionRateContainer.classList.toggle('hidden', !showCommissionRate);

                    generateCurrentReport();
                });
            });

            // Listener for date changes to auto-regenerate
            $('#report-from-date').addEventListener('change', generateCurrentReport);
            $('#report-to-date').addEventListener('change', generateCurrentReport);
        }

        function generateCurrentReport() {
            if (!currentReportType) {
                $('#report-output').innerHTML = `<div class="text-center text-gray-500 py-16 h-full flex flex-col justify-center items-center"><i class="fas fa-file-alt text-5xl mb-4 text-gray-300"></i><h3 class="text-lg font-bold text-gray-600">مرحباً بك في مركز التقارير</h3><p>الرجاء اختيار تقرير من القائمة الجانبية لعرضه هنا.</p></div>`;
                return;
            }
            
            
            const fromDate = new Date($('#report-from-date').value);
            const toDate = new Date($('#report-to-date').value);
            toDate.setHours(23, 59, 59, 999); // Include the whole day

            const container = $('#report-output');
            container.innerHTML = '<p class="text-center p-10">جاري توليد التقرير...</p>';

            setTimeout(() => {
                switch (currentReportType) {
                    case 'sales_summary': renderSalesSummary(container, fromDate, toDate); break;
                    case 'sales_detailed': renderSalesDetailed(container, fromDate, toDate); break;
                    case 'sales_by_type': renderSalesByType(container, fromDate, toDate); break;
                    case 'returns_summary': renderReturnsSummary(container, fromDate, toDate); break;
                    case 'purchases_summary': renderPurchasesSummary(container, fromDate, toDate); break;
                    case 'inventory_status': renderInventoryStatus(container); break;
                    case 'inventory_expiry': renderInventoryExpiry(container); break;
                    case 'customer_balances': renderCustomerBalances(container); break;
                    case 'customer_value_analysis': renderCustomerValueAnalysis(container, fromDate, toDate); break;
                    case 'invoice_status': renderInvoiceStatusReport(container, fromDate, toDate); break;
                    case 'supplier_balances': renderSupplierBalances(container); break;
                    case 'aging_receivables': renderAgingReceivables(container, toDate); break;
                    case 'cash_flow': renderCashFlow(container, fromDate, toDate); break;
                    case 'item_movement': renderItemMovementReport(container, fromDate, toDate); break;
                    case 'best_selling_items': renderBestSellingItemsReport(container, fromDate, toDate); break;
                    case 'collector_commission': renderCollectorCommissionReport(container, fromDate, toDate); break;
                    case 'collector_receipts_detail': renderCollectorReceiptsDetailReport(container, fromDate, toDate); break;
                    case 'least_selling_items': renderLeastSellingItemsReport(container, fromDate, toDate); break;
                    case 'item_profitability': renderItemProfitabilityReport(container, fromDate, toDate); break;
                    case 'receipts_payments_summary': renderReceiptsAndPaymentsSummary(container, fromDate, toDate); break;
                    case 'discounts_bonus_analysis': renderDiscountsAndBonusReport(container, fromDate, toDate); break;
                    case 'samples_report': renderSamplesReport(container, fromDate, toDate); break;
                    case 'income_statement': renderIncomeStatement(container, fromDate, toDate); break;
                    case 'balance_sheet': renderBalanceSheet(container, toDate); break;
                    case 'statement_of_cash_flows': renderStatementOfCashFlows(container, fromDate, toDate); break;
                    default: container.innerHTML = `<p class="text-center text-red-500">التقرير المطلوب غير معروف.</p>`;
                }
            }, 10);
        }

        function renderReportWithHeader(container, title, content, fromDate, toDate) {
            const reportSettings = db.settings.report || emptyDB.settings.report;
            const logoImg = db.settings.companyLogo ? `<img src="${db.settings.companyLogo}" alt="Logo" class="max-h-full max-w-full object-contain">` : '';
            const companyName = db.settings.companyName;
            let dateRangeHTML = '';
            if (fromDate && toDate) {
                dateRangeHTML = `<p class="text-sm text-gray-600">من: ${fromDate.toLocaleDateString('ar-EG')} إلى: ${toDate.toLocaleDateString('ar-EG')}</p>`;
            } else if (toDate) {
                dateRangeHTML = `<p class="text-sm text-gray-600">حتى تاريخ: ${toDate.toLocaleDateString('ar-EG')}</p>`;
            }

            // Custom Fields
            let customFieldsHTML = '';
            if (reportSettings.customField1Label && reportSettings.customField1Value) {
                customFieldsHTML += `<p class="text-slate-600 text-sm"><strong>${sanitizeHTML(reportSettings.customField1Label)}:</strong> ${sanitizeHTML(reportSettings.customField1Value)}</p>`;
            }
            if (reportSettings.customField2Label && reportSettings.customField2Value) {
                customFieldsHTML += `<p class="text-slate-600 text-sm"><strong>${sanitizeHTML(reportSettings.customField2Label)}:</strong> ${sanitizeHTML(reportSettings.customField2Value)}</p>`;
            }

            // Logo Position
            const logoPositionClass = reportSettings.logoPosition === 'left' ? 'flex-row-reverse' : '';

            const headerHTML = `
                <div class="mb-6 p-4 bg-slate-100 rounded-lg" style="border-bottom: 4px solid ${reportSettings.headerColor};">
                    <div class="flex justify-between items-center ${logoPositionClass}">
                        <div class="text-right">
                            <h1 class="text-3xl font-bold text-slate-800">${sanitizeHTML(companyName)}</h1>
                            <p class="text-slate-600">${sanitizeHTML(db.settings.companyAddress)}</p>
                <p class="text-slate-600">${sanitizeHTML(db.settings.companyTaxId ? `الرقم الضريبي: ${db.settings.companyTaxId}` : '')}</p>
                            <p class="text-slate-600">${sanitizeHTML(db.settings.companyPhone)}</p>
                            ${customFieldsHTML}
                        </div>
                        <div class="w-28 h-28 flex items-center justify-center bg-white rounded-md shadow-inner overflow-hidden shrink-0">
                            ${logoImg}
                        </div>
                    </div>
                    <div class="mt-4 text-center border-t border-slate-300 pt-3">
                        <h2 class="text-2xl font-bold" style="color: ${reportSettings.headerColor};">${sanitizeHTML(title)}</h2>
                        ${dateRangeHTML}
                    </div>
                </div>
            `;
            container.innerHTML = headerHTML + content;
        }

        function renderSalesSummary(container, fromDate, toDate) {
            const invoices = db.invoices.filter(inv => { const d = new Date(inv.date); return d >= fromDate && d <= toDate; });
            const totalSales = invoices.reduce((sum, inv) => sum + inv.total, 0);
            const totalCost = invoices.reduce((sum, inv) => sum + inv.items.reduce((itemSum, item) => itemSum + (item.qty * (db.items.find(i => i.id === item.id)?.purchasePrice || 0)), 0), 0);
            const totalProfit = totalSales - totalCost;
            const content = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <div class="grid grid-cols-1 gap-4 text-center">
                            <div class="summary-card border-blue-500"><p class="text-sm text-gray-500 mb-1">إجمالي المبيعات</p><span class="text-2xl font-bold text-blue-600">${formatCurrency(totalSales)}</span></div>
                            <div class="summary-card border-orange-500"><p class="text-sm text-gray-500 mb-1">إجمالي التكلفة</p><span class="text-2xl font-bold text-orange-600">${formatCurrency(totalCost)}</span></div>
                            <div class="summary-card border-green-500"><p class="text-sm text-gray-500 mb-1">إجمالي صافي الربح</p><span class="text-2xl font-bold text-green-600">${formatCurrency(totalProfit)}</span></div>
                        </div>
                    </div>
                    <div>
                        <canvas id="salesSummaryChart"></canvas>
                    </div>
                </div>`;
            
            renderReportWithHeader(container, 'ملخص المبيعات', content, fromDate, toDate);
            
            // Render Chart
            const ctx = $('#salesSummaryChart')?.getContext('2d');
            if (ctx) {
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['صافي الربح', 'التكلفة'],
                        datasets: [{
                            data: [totalProfit, totalCost],
                            backgroundColor: ['#22c55e', '#f97316'],
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'توزيع إجمالي المبيعات' }
                        }
                    }
                });
            }
        }

        function renderSalesDetailed(container, fromDate, toDate) {
            const invoices = db.invoices.filter(inv => { const d = new Date(inv.date); return d >= fromDate && d <= toDate; });
            if (invoices.length === 0) {
                renderReportWithHeader(container, 'تقرير المبيعات التفصيلي', '<p class="text-center text-gray-500 p-10">لا توجد فواتير مبيعات في الفترة المحددة.</p>', fromDate, toDate);
                return;
            }
            let totalSales = 0, totalCost = 0;
            let html = `<table class="w-full text-sm table-bordered"><thead><tr><th class="font-mono">#</th><th>التاريخ</th><th>العميل</th><th class="font-mono">الإجمالي</th><th class="font-mono">التكلفة</th><th class="font-mono">صافي الربح</th></tr></thead><tbody>`;
            invoices.forEach(inv => {
                const invoiceCost = inv.items.reduce((sum, item) => sum + (item.qty * (db.items.find(i => i.id === item.id)?.purchasePrice || 0)), 0);
                const invoiceProfit = inv.total - invoiceCost;
                totalSales += inv.total; totalCost += invoiceCost;
                html += `<tr><td class="font-mono">#${inv.id.slice(-6)}</td><td>${inv.date}</td><td>${sanitizeHTML(inv.customerName)}</td><td class="font-mono">${formatCurrency(inv.total)}</td><td class="font-mono text-orange-600">${formatCurrency(invoiceCost)}</td><td class="font-mono font-bold text-green-600">${formatCurrency(invoiceProfit)}</td></tr>`;
            });
            html += `</tbody><tfoot>
                        <tr><td colspan="3">الإجمالي</td><td class="font-mono">${formatCurrency(totalSales)}</td><td class="font-mono text-orange-600">${formatCurrency(totalCost)}</td><td class="font-mono font-bold text-green-600">${formatCurrency(totalSales - totalCost)}</td></tr>
                        <tr><td colspan="6" class="p-2 text-right"><span class="text-sm text-gray-700 font-medium">إجمالي المبيعات كتابة: </span><span class="text-sm text-gray-600">${tafqeet(totalSales)}</span></td></tr>
                     </tfoot></table>`;
            renderReportWithHeader(container, 'تقرير المبيعات التفصيلي', html, fromDate, toDate);
        }

        function renderPurchasesSummary(container, fromDate, toDate) {
            const purchases = db.purchases.filter(p => { const d = new Date(p.date); return d >= fromDate && d <= toDate; });
            if (purchases.length === 0) {
                renderReportWithHeader(container, 'تقرير المشتريات التفصيلي', '<p class="text-center text-gray-500 p-10">لا توجد فواتير مشتريات في الفترة المحددة.</p>', fromDate, toDate);
                return;
            }
            let totalPurchases = 0;
            let html = `<table class="w-full text-sm table-bordered"><thead><tr><th class="font-mono">#</th><th>التاريخ</th><th>المورد</th><th class="font-mono">الإجمالي</th></tr></thead><tbody>`;
            purchases.forEach(p => { totalPurchases += p.total; html += `<tr><td class="font-mono">#${p.id.slice(-6)}</td><td>${p.date}</td><td>${sanitizeHTML(p.supplierName)}</td><td class="font-mono">${formatCurrency(p.total)}</td></tr>`; });
            html += `</tbody><tfoot>
                        <tr><td colspan="3">الإجمالي</td><td class="font-mono">${formatCurrency(totalPurchases)}</td></tr>
                        <tr><td colspan="4" class="p-2 text-right"><span class="text-sm text-gray-700 font-medium">الإجمالي كتابة: </span><span class="text-sm text-gray-600">${tafqeet(totalPurchases)}</span></td></tr>
                     </tfoot></table>`;
            renderReportWithHeader(container, 'تقرير المشتريات التفصيلي', html, fromDate, toDate);
        }

        function renderInventoryStatus(container) {
            let html = `<table class="w-full text-sm table-bordered"><thead><tr><th>الصنف</th><th class="font-mono">الكمية الحالية</th><th class="font-mono">سعر الشراء</th><th class="font-mono">سعر البيع</th><th class="font-mono">قيمة المخزون (شراء)</th><th class="font-mono">قيمة المخزون (بيع)</th></tr></thead><tbody>`;
            let totalPurchaseValue = 0, totalSellValue = 0;
            db.items.forEach(item => {
                const purchaseValue = item.qty * (item.purchasePrice || 0);
                const sellValue = item.qty * item.sellPrice;
                totalPurchaseValue += purchaseValue; totalSellValue += sellValue;
                html += `<tr><td>${sanitizeHTML(item.name)}</td><td class="font-mono">${item.qty} ${sanitizeHTML(item.unit)}</td><td class="font-mono">${formatCurrency(item.purchasePrice)}</td><td class="font-mono">${formatCurrency(item.sellPrice)}</td><td class="font-mono">${formatCurrency(purchaseValue)}</td><td class="font-mono">${formatCurrency(sellValue)}</td></tr>`;
            });
            html += `</tbody><tfoot>
                        <tr><td colspan="4">الإجمالي</td><td class="font-mono">${formatCurrency(totalPurchaseValue)}</td><td class="font-mono">${formatCurrency(totalSellValue)}</td></tr>
                        <tr><td colspan="6" class="p-2 text-right"><span class="text-sm text-gray-700 font-medium">قيمة الشراء كتابة: </span><span class="text-sm text-gray-600">${tafqeet(totalPurchaseValue)}</span></td></tr>
                        <tr><td colspan="6" class="p-2 text-right"><span class="text-sm text-gray-700 font-medium">قيمة البيع كتابة: </span><span class="text-sm text-gray-600">${tafqeet(totalSellValue)}</span></td></tr>
                     </tfoot></table>`;
            renderReportWithHeader(container, 'تقرير حالة المخزون', html);
        }

        function renderInventoryExpiry(container) {
            const today = new Date(), warningDays = db.settings.inventory.expiryWarningDays;
            const expiredItems = [], nearExpiryItems = [];
            db.items.forEach(item => {
                if (!item.expiryDate || item.qty <= 0) return;
                const daysRemaining = (new Date(item.expiryDate) - today) / (1000 * 60 * 60 * 24);
                if (daysRemaining < 0) expiredItems.push({ ...item, days: Math.round(daysRemaining) });
                else if (daysRemaining <= warningDays) nearExpiryItems.push({ ...item, days: Math.round(daysRemaining) });
            });
            let html = `<h4 class="font-semibold mt-6 mb-2 text-red-700">أصناف منتهية الصلاحية (${expiredItems.length})</h4>`;
            if (expiredItems.length > 0) {
                html += `<table class="w-full text-sm table-bordered"><thead><tr><th>الصنف</th><th class="font-mono">الكمية</th><th>تاريخ الانتهاء</th><th class="font-mono">منتهي منذ (يوم)</th></tr></thead><tbody>`;
                expiredItems.sort((a,b) => a.days - b.days).forEach(item => { html += `<tr><td>${sanitizeHTML(item.name)}</td><td class="font-mono">${item.qty}</td><td>${item.expiryDate}</td><td class="font-mono font-bold">${Math.abs(item.days)}</td></tr>`; });
                html += `</tbody></table>`;
            } else html += `<p class="text-center text-gray-500 py-4">لا توجد أصناف منتهية الصلاحية.</p>`;
            html += `<h4 class="font-semibold mt-6 mb-2 text-yellow-700">أصناف قريبة من الانتهاء (${nearExpiryItems.length}) (خلال ${warningDays} يوم)</h4>`;
            if (nearExpiryItems.length > 0) {
                html += `<table class="w-full text-sm table-bordered"><thead><tr><th>الصنف</th><th class="font-mono">الكمية</th><th>تاريخ الانتهاء</th><th class="font-mono">متبقي (يوم)</th></tr></thead><tbody>`;
                nearExpiryItems.sort((a,b) => a.days - b.days).forEach(item => { html += `<tr><td>${sanitizeHTML(item.name)}</td><td class="font-mono">${item.qty}</td><td>${item.expiryDate}</td><td class="font-mono font-bold">${item.days}</td></tr>`; });
                html += `</tbody></table>`;
            } else html += `<p class="text-center text-gray-500 py-4">لا توجد أصناف قريبة من الانتهاء.</p>`;
            renderReportWithHeader(container, 'تقرير صلاحية الأصناف', html);
        }

        function renderCustomerBalances(container) {
            const balances = getBalances();
            let html = `<table class="w-full text-sm table-bordered"><thead><tr><th>العميل</th><th class="font-mono">رقم الحساب</th><th class="font-mono">الرصيد الحالي</th></tr></thead><tbody>`;
            let totalBalance = 0;
            db.customers.forEach(customer => {
                const balanceData = balances[customer.accountNo];
                if (balanceData) {
                    const balance = balanceData.balance;
                    totalBalance += balance;
                    html += `<tr><td>${sanitizeHTML(customer.name)}</td><td>${customer.accountNo}</td><td class="font-mono font-bold ${balance > 0 ? 'text-red-600' : (balance < 0 ? 'text-green-600' : '')}">${formatCurrency(balance)}</td></tr>`;
                }
            });
            html += `</tbody><tfoot>
                        <tr><td colspan="2">إجمالي الديون على العملاء</td><td class="font-mono">${formatCurrency(totalBalance)}</td></tr>
                        <tr><td colspan="3" class="p-2 text-right"><span class="text-sm text-gray-700 font-medium">الإجمالي كتابة: </span><span class="text-sm text-gray-600">${tafqeet(totalBalance)}</span></td></tr>
                     </tfoot></table>`;
            renderReportWithHeader(container, 'تقرير أرصدة العملاء', html);
        }

        function renderSupplierBalances(container) {
            const balances = getBalances();
            let html = `<table class="w-full text-sm table-bordered"><thead><tr><th>المورد</th><th class="font-mono">رقم الحساب</th><th class="font-mono">الرصيد الحالي (لصالحهم)</th></tr></thead><tbody>`;
            let totalBalance = 0;
            db.suppliers.forEach(supplier => {
                const balanceData = balances[supplier.accountNo];
                if (balanceData) {
                    const balance = balanceData.balance;
                    totalBalance += balance;
                    html += `<tr><td>${sanitizeHTML(supplier.name)}</td><td>${supplier.accountNo}</td><td class="font-mono font-bold ${balance > 0 ? 'text-red-600' : ''}">${formatCurrency(balance)}</td></tr>`;
                }
            });
            html += `</tbody><tfoot>
                        <tr><td colspan="2">إجمالي ديون الموردين</td><td class="font-mono">${formatCurrency(totalBalance)}</td></tr>
                        <tr><td colspan="3" class="p-2 text-right"><span class="text-sm text-gray-700 font-medium">الإجمالي كتابة: </span><span class="text-sm text-gray-600">${tafqeet(totalBalance)}</span></td></tr>
                     </tfoot></table>`;
            renderReportWithHeader(container, 'تقرير أرصدة الموردين', html);
        }

        function renderAgingReceivables(container, asOfDate) {
            const today = asOfDate;
            // تعديل: فلترة الفواتير الآجلة فقط التي لم تسدد بالكامل
            // تعديل: فلترة الفواتير التي لها رصيد متبقي فقط، بغض النظر عن نوعها
            const data = db.invoices.filter(inv => {
                const remaining = inv.total - (inv.paidAmount || 0);
                return remaining >= 0.01 && new Date(inv.date) <= today;
            });

            const entityName = 'العميل', entityList = db.customers, entityIdField = 'customerId', agingData = {};
            // تعديل: استخدام فئات تعمير قياسية (0-30, 31-60, 61-90, 91+)
            const totals = { b0_30: 0, b31_60: 0, b61_90: 0, b_over_90: 0, total: 0 };

            data.forEach(inv => {
                const remaining = inv.total - (inv.paidAmount || 0);
                const entity = entityList.find(e => e.id === inv[entityIdField]);
                if (!entity) return;

                // تعديل: تجميع الفواتير حسب العميل ونوع الفاتورة لإظهار كل نوع على حدة
                const agingKey = `${entity.id}-${inv.type}`;
                if (!agingData[agingKey]) {
                    agingData[agingKey] = { 
                        name: entity.name, 
                        type: inv.type === 'credit' ? 'آجل' : 'نقدي',
                        b0_30: 0, b31_60: 0, b61_90: 0, b_over_90: 0, total: 0 
                    };
                }
                
                const asOfDateUTC = new Date(today.toISOString().split('T')[0]);
                const invDateUTC = new Date(inv.date);
                const daysDiff = Math.floor((asOfDateUTC - invDateUTC) / (1000 * 60 * 60 * 24));

                // تعديل: منطق توزيع الديون على الفئات
                if (daysDiff <= 30) {
                    agingData[agingKey].b0_30 += remaining;
                } else if (daysDiff <= 60) {
                    agingData[agingKey].b31_60 += remaining;
                } else if (daysDiff <= 90) {
                    agingData[agingKey].b61_90 += remaining;
                } else {
                    agingData[agingKey].b_over_90 += remaining;
                }
                agingData[agingKey].total += remaining;
            });
            // تعديل: تحديث رؤوس الأعمدة لتناسب الفئات الجديدة
            // تعديل: إضافة عمود "النوع" وتحديث العناوين
            let html = `<table class="w-full text-sm table-bordered"><thead><tr><th>${entityName}</th><th>النوع</th><th class="font-mono">0-30 يوم</th><th class="font-mono">31-60 يوم</th><th class="font-mono">61-90 يوم</th><th class="font-mono">أكثر من 90 يوم</th><th class="font-mono">الإجمالي</th></tr></thead><tbody>`;
            const sortedData = Object.values(agingData).sort((a, b) => b.total - a.total);
            if (sortedData.length === 0) {
                html += `<tr><td colspan="7" class="text-center text-gray-500 py-4">لا توجد ديون مستحقة.</td></tr>`;
            } else {
                sortedData.forEach(d => {
                    totals.b0_30 += d.b0_30; totals.b31_60 += d.b31_60; totals.b61_90 += d.b61_90; totals.b_over_90 += d.b_over_90; totals.total += d.total;
                    const typeChipClass = d.type === 'آجل' ? 'chip-warning' : 'chip-success';
                    html += `<tr>
                                <td>${sanitizeHTML(d.name)}</td>
                                <td><span class="chip ${typeChipClass}">${d.type}</span></td>
                                <td class="font-mono">${formatCurrency(d.b0_30)}</td>
                                <td class="font-mono">${formatCurrency(d.b31_60)}</td>
                                <td class="font-mono">${formatCurrency(d.b61_90)}</td>
                                <td class="font-mono text-red-600 font-bold">${formatCurrency(d.b_over_90)}</td>
                                <td class="font-mono font-bold">${formatCurrency(d.total)}</td>
                            </tr>`;
                });
            }
            html += `</tbody><tfoot>
                        <tr>
                            <td colspan="2">الإجمالي العام</td>
                            <td class="font-mono">${formatCurrency(totals.b0_30)}</td>
                            <td class="font-mono">${formatCurrency(totals.b31_60)}</td>
                            <td class="font-mono">${formatCurrency(totals.b61_90)}</td>
                            <td class="font-mono">${formatCurrency(totals.b_over_90)}</td>
                            <td class="font-mono">${formatCurrency(totals.total)}</td>
                        </tr>
                        <tr>
                            <td colspan="7" class="p-2 text-right"><span class="text-sm text-gray-700 font-medium">الإجمالي كتابة: </span><span class="text-sm text-gray-600">${tafqeet(totals.total)}</span></td>
                        </tr>
                     </tfoot></table>`;
            renderReportWithHeader(container, 'تقرير أعمار ديون العملاء', html, null, today);
        }

        function renderReturnsSummary(container, fromDate, toDate) {
            const salesReturns = db.salesReturns.filter(r => { const d = new Date(r.date); return d >= fromDate && d <= toDate; });
            const purchaseReturns = db.purchaseReturns.filter(r => { const d = new Date(r.date); return d >= fromDate && d <= toDate; });

            let html = `<h4 class="font-semibold mt-6 mb-2 text-orange-700">مرتجعات المبيعات (${salesReturns.length})</h4>`;
            if (salesReturns.length > 0) {
                html += `<table class="w-full text-sm table-bordered"><thead><tr><th>التاريخ</th><th>العميل</th><th class="font-mono">الفاتورة الأصلية</th><th class="font-mono">الإجمالي</th></tr></thead><tbody>`;
                salesReturns.forEach(r => { html += `<tr><td>${r.date}</td><td>${sanitizeHTML(r.customerName)}</td><td class="font-mono">#${r.originalInvoiceId.slice(-6)}</td><td class="font-mono">${formatCurrency(r.total)}</td></tr>`; });
                html += `</tbody></table>`;
            } else {
                html += `<p class="text-center text-gray-500 py-4">لا توجد مرتجعات مبيعات في الفترة المحددة.</p>`;
            }

            html += `<h4 class="font-semibold mt-6 mb-2 text-violet-700">مرتجعات المشتريات (${purchaseReturns.length})</h4>`;
            if (purchaseReturns.length > 0) {
                html += `<table class="w-full text-sm table-bordered"><thead><tr><th>التاريخ</th><th>المورد</th><th class="font-mono">الفاتورة الأصلية</th><th class="font-mono">الإجمالي</th></tr></thead><tbody>`;
                purchaseReturns.forEach(r => { html += `<tr><td>${r.date}</td><td>${sanitizeHTML(r.supplierName)}</td><td class="font-mono">#${r.originalPurchaseId.slice(-6)}</td><td class="font-mono">${formatCurrency(r.total)}</td></tr>`; });
                html += `</tbody></table>`;
            } else {
                html += `<p class="text-center text-gray-500 py-4">لا توجد مرتجعات مشتريات في الفترة المحددة.</p>`;
            }
            renderReportWithHeader(container, 'تقرير المرتجعات', html, fromDate, toDate);
        }

        function renderSalesByType(container, fromDate, toDate) {
            const invoices = db.invoices.filter(inv => { const d = new Date(inv.date); return d >= fromDate && d <= toDate; });
            const cashInvoices = invoices.filter(inv => inv.type === 'cash');
            const creditInvoices = invoices.filter(inv => inv.type === 'credit');

            let html = `<h4 class="font-semibold mt-6 mb-2 text-green-700">الفواتير النقدية (${cashInvoices.length})</h4>`;
            if (cashInvoices.length > 0) {
                let total = 0;
                html += `<table class="w-full text-sm table-bordered"><thead><tr><th class="font-mono">#</th><th>التاريخ</th><th>العميل</th><th class="font-mono">الإجمالي</th></tr></thead><tbody>`;
                cashInvoices.forEach(inv => { total += inv.total; html += `<tr><td class="font-mono">#${inv.id.slice(-6)}</td><td>${inv.date}</td><td>${sanitizeHTML(inv.customerName)}</td><td class="font-mono">${formatCurrency(inv.total)}</td></tr>`; });
                html += `</tbody><tfoot>
                            <tr><td colspan="3">الإجمالي</td><td class="font-mono">${formatCurrency(total)}</td></tr>
                            <tr><td colspan="4" class="p-2 text-right"><span class="text-sm text-gray-700 font-medium">الإجمالي كتابة: </span><span class="text-sm text-gray-600">${tafqeet(total)}</span></td></tr>
                         </tfoot></table>`;
            } else {
                html += `<p class="text-center text-gray-500 py-4">لا توجد فواتير نقدية في الفترة المحددة.</p>`;
            }

            html += `<h4 class="font-semibold mt-6 mb-2 text-yellow-700">الفواتير الآجلة (${creditInvoices.length})</h4>`;
            if (creditInvoices.length > 0) {
                let total = 0, totalPaid = 0, totalRemaining = 0;
                html += `<table class="w-full text-sm table-bordered"><thead><tr><th class="font-mono">#</th><th>التاريخ</th><th>العميل</th><th class="font-mono">الإجمالي</th><th class="font-mono">المدفوع</th><th class="font-mono">المتبقي</th></tr></thead><tbody>`;
                creditInvoices.forEach(inv => { 
                    const remaining = inv.total - inv.paidAmount;
                    total += inv.total; 
                    totalPaid += inv.paidAmount;
                    totalRemaining += remaining;
                    html += `<tr><td class="font-mono">#${inv.id.slice(-6)}</td><td>${inv.date}</td><td>${sanitizeHTML(inv.customerName)}</td><td class="font-mono">${formatCurrency(inv.total)}</td><td class="font-mono text-green-600">${formatCurrency(inv.paidAmount)}</td><td class="font-mono font-bold text-red-600">${formatCurrency(remaining)}</td></tr>`; 
                });
                html += `</tbody><tfoot>
                            <tr><td colspan="3">الإجمالي</td><td class="font-mono">${formatCurrency(total)}</td><td class="font-mono text-green-600">${formatCurrency(totalPaid)}</td><td class="font-mono text-red-600">${formatCurrency(totalRemaining)}</td></tr>
                            <tr><td colspan="6" class="p-2 text-right"><span class="text-sm text-gray-700 font-medium">إجمالي الآجل كتابة: </span><span class="text-sm text-gray-600">${tafqeet(total)}</span></td></tr>
                         </tfoot></table>`;
            } else {
                html += `<p class="text-center text-gray-500 py-4">لا توجد فواتير آجلة في الفترة المحددة.</p>`;
            }
            renderReportWithHeader(container, 'تقرير المبيعات حسب النوع', html, fromDate, toDate);
        }

        function renderInvoiceStatusReport(container, fromDate, toDate) {
            const invoices = db.invoices.filter(inv => { const d = new Date(inv.date); return d >= fromDate && d <= toDate; });
            if (invoices.length === 0) {
                renderReportWithHeader(container, 'تقرير حالة الفواتير وسدادها', '<p class="text-center text-gray-500 p-10">لا توجد فواتير في الفترة المحددة.</p>', fromDate, toDate);
                return;
            }

            let html = `<table class="w-full text-sm table-bordered"><thead><tr><th class="font-mono">الفاتورة</th><th>العميل</th><th class="font-mono">الإجمالي</th><th class="font-mono">المدفوع</th><th class="font-mono">المتبقي</th><th>الحالة</th><th>تفاصيل السداد</th></tr></thead><tbody>`;
            
            invoices.forEach(inv => {
                const remaining = inv.total - inv.paidAmount;
                let statusChip = '';
                if (remaining <= 0.01) statusChip = '<span class="chip chip-success">مسددة</span>';
                else if (inv.paidAmount > 0) statusChip = '<span class="chip chip-warning">مسددة جزئياً</span>';
                else statusChip = '<span class="chip chip-danger">غير مسددة</span>';

                let paymentsHtml = 'لا يوجد سداد';
                if (inv.payments && inv.payments.length > 0) {
                    paymentsHtml = '<ul class="list-disc list-inside text-xs">';
                    inv.payments.forEach(p => {
                        paymentsHtml += `<li>${p.date}: ${formatCurrency(p.amount)}</li>`;
                    });
                    paymentsHtml += '</ul>';
                }

                html += `<tr>
                    <td>#${inv.id.slice(-6)}<br><small class="text-gray-500">${inv.date}</small></td>
                    <td>${sanitizeHTML(inv.customerName)}</td>
                    <td class="font-mono">${formatCurrency(inv.total)}</td>
                    <td class="font-mono text-green-600">${formatCurrency(inv.paidAmount)}</td>
                    <td class="font-mono font-bold ${remaining > 0 ? 'text-red-600' : ''}">${formatCurrency(remaining)}</td>
                    <td>${statusChip}</td>
                    <td>${paymentsHtml}</td>
                </tr>`;
            });

            html += `</tbody></table>`;
            renderReportWithHeader(container, 'تقرير حالة الفواتير وسدادها', html, fromDate, toDate);
        }

        function calculateAvgDaysToPay(customerId, fromDate, toDate) {
            const paidInvoices = db.invoices.filter(inv => {
                const d = new Date(inv.date);
                return inv.customerId === customerId &&
                    inv.type === 'credit' &&
                    (inv.total - inv.paidAmount) < 0.01 && // Fully paid
                    inv.payments.length > 0 &&
                    d >= fromDate && d <= toDate;
            });

            if (paidInvoices.length === 0) return { days: null, count: 0 };

            let totalDays = 0;
            paidInvoices.forEach(inv => {
                const invoiceDate = new Date(inv.date);
                // Find the date of the last payment that made it fully paid
                const lastPaymentDate = new Date(inv.payments[inv.payments.length - 1].date);
                const daysDiff = (lastPaymentDate - invoiceDate) / (1000 * 60 * 60 * 24);
                totalDays += daysDiff;
            });

            return { days: Math.round(totalDays / paidInvoices.length), count: paidInvoices.length };
        }

        function renderCustomerValueAnalysis(container, fromDate, toDate) {
            const customerAnalysis = {};
            db.customers.forEach(c => {
                customerAnalysis[c.id] = { name: c.name, profit: 0, invoiceCount: 0, avgDaysToPay: null };
            });

            db.invoices.filter(inv => { const d = new Date(inv.date); return d >= fromDate && d <= toDate; }).forEach(inv => {
                if (customerAnalysis[inv.customerId]) {
                    const invoiceCost = inv.items.reduce((sum, item) => sum + (item.qty * (db.items.find(i => i.id === item.id)?.purchasePrice || 0)), 0);
                    customerAnalysis[inv.customerId].profit += (inv.total - invoiceCost);
                    customerAnalysis[inv.customerId].invoiceCount++;
                }
            });

            for (const customerId in customerAnalysis) {
                const paymentData = calculateAvgDaysToPay(customerId, fromDate, toDate);
                customerAnalysis[customerId].avgDaysToPay = paymentData.days;
            }

            const sortedCustomers = Object.values(customerAnalysis).filter(c => c.invoiceCount > 0).sort((a, b) => b.profit - a.profit);

            let html = `<div class="tutorial-box"><div class="tutorial-title"><i class="fas fa-award"></i> توصية</div><p class="text-sm text-gray-700">العملاء في أعلى القائمة هم الأكثر ربحية. العملاء الذين لديهم "متوسط أيام للسداد" منخفض يعتبرون جيدين في السداد. هؤلاء هم العملاء الذين يجب المحافظة عليهم.</p></div>
                        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                            <div class="lg:col-span-3">
                                <table class="w-full text-sm table-bordered"><thead><tr><th>العميل</th><th class="font-mono">إجمالي الربح</th><th class="font-mono">عدد الفواتير</th><th>متوسط أيام للسداد (للآجل)</th></tr></thead><tbody>`;

            if (sortedCustomers.length === 0) {
                html += `<tr><td colspan="4" class="text-center text-gray-500 py-4">لا توجد بيانات مبيعات في الفترة المحددة.</td></tr>`;
            } else {
                sortedCustomers.forEach(c => {
                    html += `<tr>
                        <td class="font-bold">${sanitizeHTML(c.name)}</td>
                        <td class="font-mono font-bold text-green-600">${formatCurrency(c.profit)}</td>
                        <td class="font-mono">${c.invoiceCount}</td>
                        <td class="text-center">${c.avgDaysToPay !== null ? `<span class="chip chip-success">${c.avgDaysToPay} يوم</span>` : '<span class="chip chip-info">لا يوجد</span>'}</td>
                    </tr>`;
                });
            }
            html += `</tbody></table></div><div class="lg:col-span-2"><canvas id="customerValueChart"></canvas></div></div>`;
            renderReportWithHeader(container, 'تحليل قيمة العملاء (الأكثر ربحية)', html, fromDate, toDate);

            const top5Customers = sortedCustomers.slice(0, 5);
            const ctx = $('#customerValueChart')?.getContext('2d');
            if(ctx && top5Customers.length > 0) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: top5Customers.map(c => c.name),
                        datasets: [{
                            label: 'إجمالي الربح',
                            data: top5Customers.map(c => c.profit),
                            backgroundColor: '#22c55e',
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false }, title: { display: true, text: 'أفضل 5 عملاء حسب الربح' } }
                    }
                });
            }
        }

        function renderCashFlow(container, fromDate, toDate) {
            const cashAccountNo = db.settings.accountingLinks.cash;
            if (!cashAccountNo) {
                renderReportWithHeader(container, 'تقرير حركة الصندوق', `<p class="text-center text-red-500 p-10">الرجاء تحديد حساب الصندوق الافتراضي في الإعدادات أولاً.</p>`, fromDate, toDate);
                return;
            }
            const entries = db.journal.filter(j => { const d = new Date(j.date); return (j.debit === cashAccountNo || j.credit === cashAccountNo) && (d >= fromDate && d <= toDate); });
            let html = `<table class="w-full text-sm table-bordered"><thead><tr><th>التاريخ</th><th>البيان</th><th class="font-mono">مقبوضات (مدين)</th><th class="font-mono">مدفوعات (دائن)</th></tr></thead><tbody>`;
            let totalIn = 0, totalOut = 0;
            entries.forEach(entry => {
                const amountIn = entry.debit === cashAccountNo ? entry.amount : 0;
                const amountOut = entry.credit === cashAccountNo ? entry.amount : 0;
                totalIn += amountIn; totalOut += amountOut;
                html += `<tr><td>${entry.date}</td><td>${sanitizeHTML(entry.desc)}</td><td class="font-mono text-green-600">${formatCurrency(amountIn)}</td><td class="font-mono text-red-600">${formatCurrency(amountOut)}</td></tr>`;
            });
            const netFlow = totalIn - totalOut;
            html += `</tbody><tfoot>
                        <tr><td colspan="2">الإجمالي</td><td class="font-mono text-green-600">${formatCurrency(totalIn)}</td><td class="font-mono text-red-600">${formatCurrency(totalOut)}</td></tr>
                        <tr><td colspan="3">صافي الحركة</td><td class="font-mono font-bold ${netFlow >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(netFlow)}</td></tr>
                        <tr><td colspan="4" class="p-2 text-right"><span class="text-sm text-gray-700 font-medium">صافي الحركة كتابة: </span><span class="text-sm text-gray-600">${tafqeet(netFlow)}</span></td></tr>
                     </tfoot></table>`;
            renderReportWithHeader(container, 'تقرير حركة الصندوق', html, fromDate, toDate);
        }

        function renderItemMovementReport(container, fromDate, toDate) {
            const itemId = $('#report-item-selector').value;
            if (!itemId) {
                renderReportWithHeader(container, 'تقرير حركة صنف', '<p class="text-center text-gray-500 p-10">الرجاء اختيار صنف من القائمة الجانبية.</p>', fromDate, toDate);
                return;
            }

            const item = db.items.find(i => i.id === itemId);
            const movements = [];

            // Calculate opening balance
            let openingBalance = 0;
            db.purchases.forEach(p => {
                if (new Date(p.date) < fromDate) {
                    p.items.forEach(i => { if (i.id === itemId) openingBalance += i.qty; });
                }
            });
            db.invoices.forEach(inv => {
                if (new Date(inv.date) < fromDate) {
                    inv.items.forEach(i => { if (i.id === itemId) openingBalance -= i.qty; });
                }
            });
            db.salesReturns.forEach(sr => {
                if (new Date(sr.date) < fromDate) {
                    sr.items.forEach(i => { if (i.id === itemId) openingBalance += i.qty; });
                }
            });
            db.purchaseReturns.forEach(pr => {
                if (new Date(pr.date) < fromDate) {
                    pr.items.forEach(i => { if (i.id === itemId) openingBalance -= i.qty; });
                }
            });
            db.inventoryDisbursements.forEach(d => {
                if (new Date(d.date) < fromDate) {
                    d.items.forEach(i => { if (i.id === itemId) openingBalance -= i.qty; });
                }
            });
            db.bonusInvoices.forEach(b => {
                if (new Date(b.date) < fromDate) {
                    b.items.forEach(i => { if (i.id === itemId) openingBalance -= i.qty; });
                }
            });

            // Collect transactions within the date range
            const filterByDate = (doc) => {
                const d = new Date(doc.date);
                return d >= fromDate && d <= toDate;
            };

            db.purchases.filter(filterByDate).forEach(p => {
                p.items.forEach(i => {
                    if (i.id === itemId) movements.push({ date: p.date, type: 'شراء', ref: `#${p.id.slice(-6)}`, qtyIn: i.qty, qtyOut: 0 });
                });
            });
            db.invoices.filter(filterByDate).forEach(inv => {
                inv.items.forEach(i => {
                    if (i.id === itemId) movements.push({ date: inv.date, type: i.isBonus ? 'بونص' : 'بيع', ref: `#${inv.id.slice(-6)}`, qtyIn: 0, qtyOut: i.qty });
                });
            });
            db.salesReturns.filter(filterByDate).forEach(sr => {
                sr.items.forEach(i => {
                    if (i.id === itemId) movements.push({ date: sr.date, type: 'مرتجع بيع', ref: `#${sr.id.slice(-6)}`, qtyIn: i.qty, qtyOut: 0 });
                });
            });
            db.purchaseReturns.filter(filterByDate).forEach(pr => {
                pr.items.forEach(i => {
                    if (i.id === itemId) movements.push({ date: pr.date, type: 'مرتجع شراء', ref: `#${pr.id.slice(-6)}`, qtyIn: 0, qtyOut: i.qty });
                });
            });
            db.inventoryDisbursements.filter(filterByDate).forEach(d => {
                d.items.forEach(i => {
                    if (i.id === itemId) movements.push({ date: d.date, type: 'صرف مخزني', ref: `#${d.id.slice(-6)}`, qtyIn: 0, qtyOut: i.qty });
                });
            });
            db.bonusInvoices.filter(filterByDate).forEach(b => {
                b.items.forEach(i => {
                    if (i.id === itemId) movements.push({ date: b.date, type: 'فاتورة بونص', ref: `#${b.id.slice(-6)}`, qtyIn: 0, qtyOut: i.qty });
                });
            });

            movements.sort((a, b) => new Date(a.date) - new Date(b.date));

            let html = `<table class="w-full text-sm table-bordered"><thead><tr><th>التاريخ</th><th>النوع</th><th>المرجع</th><th class="font-mono">وارد</th><th class="font-mono">صادر</th><th class="font-mono">الرصيد</th></tr></thead><tbody><tr><td colspan="5"><strong>الرصيد الافتتاحي</strong></td><td class="font-mono font-bold">${openingBalance}</td></tr>`;
            let currentBalance = openingBalance;
            movements.forEach(m => {
                currentBalance += m.qtyIn - m.qtyOut;
                const typeChipClass = { 'شراء': 'chip-success', 'مرتجع بيع': 'chip-success', 'بيع': 'chip-danger', 'مرتجع شراء': 'chip-danger', 'صرف مخزني': 'chip-warning', 'بونص': 'chip-warning', 'فاتورة بونص': 'chip-warning' }[m.type] || 'chip-info';
                html += `<tr><td>${m.date}</td><td><span class="chip ${typeChipClass}">${m.type}</span></td><td>${m.ref}</td><td class="font-mono text-green-600">${m.qtyIn > 0 ? m.qtyIn : ''}</td><td class="font-mono text-red-600">${m.qtyOut > 0 ? m.qtyOut : ''}</td><td class="font-mono font-bold">${currentBalance}</td></tr>`;
            });
            html += `</tbody><tfoot><tr><td colspan="5"><strong>الرصيد النهائي</strong></td><td class="font-mono font-bold">${currentBalance}</td></tr></tfoot></table>`;

            renderReportWithHeader(container, `تقرير حركة صنف: ${sanitizeHTML(item.name)}`, html, fromDate, toDate);
        }

        function renderBestSellingItemsReport(container, fromDate, toDate) {
            const salesData = {};
            db.items.forEach(item => {
                salesData[item.id] = { name: item.name, qty: 0, totalValue: 0 };
            });

            db.invoices.filter(inv => {
                const d = new Date(inv.date);
                return d >= fromDate && d <= toDate;
            }).forEach(inv => {
                inv.items.forEach(item => {
                    if (salesData[item.id] && !item.isBonus) {
                        salesData[item.id].qty += item.qty;
                        salesData[item.id].totalValue += item.qty * item.price;
                    }
                });
            });

            const sortedItems = Object.values(salesData).filter(item => item.qty > 0).sort((a, b) => b.qty - a.qty);

            if (sortedItems.length === 0) {
                renderReportWithHeader(container, 'تقرير الأصناف الأكثر مبيعاً', '<p class="text-center text-gray-500 p-10">لا توجد بيانات مبيعات للأصناف في الفترة المحددة.</p>', fromDate, toDate);
                return;
            }

            let html = `<table class="w-full text-sm table-bordered"><thead><tr><th>الترتيب</th><th>الصنف</th><th class="font-mono">الكمية المباعة</th><th class="font-mono">إجمالي قيمة المبيعات</th></tr></thead><tbody>`;
            sortedItems.forEach((item, index) => { html += `<tr><td>${index + 1}</td><td>${sanitizeHTML(item.name)}</td><td class="font-mono">${item.qty}</td><td class="font-mono">${formatCurrency(item.totalValue)}</td></tr>`; });
            html += `</tbody></table>`;
            renderReportWithHeader(container, 'تقرير الأصناف الأكثر مبيعاً (حسب الكمية)', html, fromDate, toDate);
        }

        function renderLeastSellingItemsReport(container, fromDate, toDate) {
            const salesData = {};
            db.items.forEach(item => {
                salesData[item.id] = { name: item.name, qty: 0, totalValue: 0 };
            });

            db.invoices.filter(inv => {
                const d = new Date(inv.date);
                return d >= fromDate && d <= toDate;
            }).forEach(inv => {
                inv.items.forEach(item => {
                    if (salesData[item.id] && !item.isBonus) {
                        salesData[item.id].qty += item.qty;
                        salesData[item.id].totalValue += item.qty * item.price;
                    }
                });
            });

            const sortedItems = Object.values(salesData).sort((a, b) => a.qty - b.qty);

            if (sortedItems.length === 0) {
                renderReportWithHeader(container, 'تقرير الأصناف الأقل مبيعاً', '<p class="text-center text-gray-500 p-10">لا توجد أصناف في النظام.</p>', fromDate, toDate);
                return;
            }

            let html = `<table class="w-full text-sm table-bordered"><thead><tr><th>الترتيب</th><th>الصنف</th><th class="font-mono">الكمية المباعة</th><th class="font-mono">إجمالي قيمة المبيعات</th></tr></thead><tbody>`;
            sortedItems.forEach((item, index) => { html += `<tr><td>${index + 1}</td><td>${sanitizeHTML(item.name)}</td><td class="font-mono">${item.qty}</td><td class="font-mono">${formatCurrency(item.totalValue)}</td></tr>`; });
            html += `</tbody></table>`;
            renderReportWithHeader(container, 'تقرير الأصناف الأقل مبيعاً (حسب الكمية)', html, fromDate, toDate);
        }

        function renderItemProfitabilityReport(container, fromDate, toDate) {
            const itemData = {};
            db.items.forEach(item => {
                itemData[item.id] = { 
                    name: item.name, 
                    qtySold: 0, 
                    totalSales: 0, 
                    totalCost: 0,
                    totalProfit: 0
                };
            });

            db.invoices.filter(inv => {
                const d = new Date(inv.date);
                return d >= fromDate && d <= toDate;
            }).forEach(inv => {
                inv.items.forEach(item => {
                    if (itemData[item.id] && !item.isBonus) {
                        const stockItem = db.items.find(i => i.id === item.id);
                        const cost = stockItem ? (stockItem.purchasePrice || 0) : 0;
                        
                        itemData[item.id].qtySold += item.qty;
                        itemData[item.id].totalSales += item.qty * item.price;
                        itemData[item.id].totalCost += item.qty * cost;
                    }
                });
            });

            const sortedItems = Object.values(itemData)
                .filter(item => item.qtySold > 0)
                .map(item => {
                    item.totalProfit = item.totalSales - item.totalCost;
                    return item;
                })
                .sort((a, b) => b.totalProfit - a.totalProfit);

            if (sortedItems.length === 0) {
                renderReportWithHeader(container, 'تقرير ربحية الأصناف', '<p class="text-center text-gray-500 p-10">لا توجد بيانات مبيعات للأصناف في الفترة المحددة.</p>', fromDate, toDate);
                return;
            }

            let html = `<table class="w-full text-sm table-bordered"><thead><tr><th>الترتيب</th><th>الصنف</th><th class="font-mono">الكمية المباعة</th><th class="font-mono">إجمالي المبيعات</th><th class="font-mono">إجمالي التكلفة</th><th class="font-mono">إجمالي الربح</th></tr></thead><tbody>`;
            sortedItems.forEach((item, index) => { html += `<tr><td>${index + 1}</td><td>${sanitizeHTML(item.name)}</td><td class="font-mono">${item.qtySold}</td><td class="font-mono">${formatCurrency(item.totalSales)}</td><td class="font-mono text-orange-600">${formatCurrency(item.totalCost)}</td><td class="font-mono font-bold text-green-600">${formatCurrency(item.totalProfit)}</td></tr>`; });
            html += `</tbody></table>`;
            renderReportWithHeader(container, 'تقرير ربحية الأصناف (مرتب حسب الأعلى ربحاً)', html, fromDate, toDate);
        }

        function renderCollectorCommissionReport(container, fromDate, toDate) {
            const commissionRate = parseFloat($('#report-commission-rate').value) || 0;

            const collectedByCustomer = {};

            db.invoices.forEach(inv => {
                if (!inv.payments) return;

                inv.payments.forEach(p => {
                    const paymentDate = new Date(p.date);
                    if (p.forCollector && paymentDate >= fromDate && paymentDate <= toDate) {
                        if (!collectedByCustomer[inv.customerId]) {
                            collectedByCustomer[inv.customerId] = {
                                name: inv.customerName,
                                totalCollected: 0,
                                payments: []
                            };
                        }
                        collectedByCustomer[inv.customerId].totalCollected += p.amount;
                        collectedByCustomer[inv.customerId].payments.push(p);
                    }
                });
            });

            const data = Object.values(collectedByCustomer).sort((a, b) => b.totalCollected - a.totalCollected);

            if (data.length === 0) {
                renderReportWithHeader(container, 'تقرير نسبة المحصلين', '<p class="text-center text-gray-500 p-10">لا توجد مقبوضات خاضعة للنسبة في الفترة المحددة.</p>', fromDate, toDate);
                return;
            }

            let grandTotalCollected = 0;
            let grandTotalCommission = 0;

            let html = `<div class="tutorial-box"><div class="tutorial-title"><i class="fas fa-percent"></i> ملاحظة</div><p class="text-sm text-gray-700">هذا التقرير يعرض فقط المقبوضات التي تم تحديدها لتدخل في نسبة المحصل. يمكنك تغيير نسبة العمولة من القائمة الجانبية.</p></div>
                        <table class="w-full text-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>العميل</th>
                                    <th class="font-mono">إجمالي المبلغ المحصل</th>
                                    <th class="font-mono">نسبة العمولة (%)</th>
                                    <th class="font-mono">مبلغ العمولة</th>
                                </tr>
                            </thead>
                            <tbody>`;

            data.forEach(customer => {
                const commissionAmount = customer.totalCollected * (commissionRate / 100);
                grandTotalCollected += customer.totalCollected;
                grandTotalCommission += commissionAmount;

                html += `<tr><td>${sanitizeHTML(customer.name)}</td><td class="font-mono">${formatCurrency(customer.totalCollected)}</td><td class="font-mono">${commissionRate.toFixed(2)}%</td><td class="font-mono font-bold text-green-600">${formatCurrency(commissionAmount)}</td></tr>`;
            });

            html += `</tbody><tfoot><tr><td><strong>الإجمالي العام</strong></td><td class="font-mono">${formatCurrency(grandTotalCollected)}</td><td></td><td class="font-mono font-bold text-green-600">${formatCurrency(grandTotalCommission)}</td></tr></tfoot></table>`;

            renderReportWithHeader(container, `تقرير نسبة المحصلين (${commissionRate}%)`, html, fromDate, toDate);
        }

        function renderCollectorReceiptsDetailReport(container, fromDate, toDate) {
            const commissionRate = parseFloat($('#report-commission-rate').value) || 0;

            const collectorReceipts = [];
            db.invoices.forEach(inv => {
                if (!inv.payments) return;
                inv.payments.forEach(p => {
                    const paymentDate = new Date(p.date);
                    if (p.forCollector && paymentDate >= fromDate && paymentDate <= toDate) {
                        const commissionAmount = p.amount * (commissionRate / 100);
                        collectorReceipts.push({
                            date: p.date,
                            customerName: inv.customerName,
                            invoiceId: inv.id,
                            amount: p.amount,
                            commission: commissionAmount,
                            desc: p.desc
                        });
                    }
                });
            });

            if (collectorReceipts.length === 0) {
                renderReportWithHeader(container, 'تقرير مقبوضات المحصل التفصيلي', '<p class="text-center text-gray-500 p-10">لا توجد مقبوضات خاضعة للنسبة في الفترة المحددة.</p>', fromDate, toDate);
                return;
            }

            let totalCollected = 0;
            let totalCommission = 0;

            let html = `<div class="tutorial-box"><div class="tutorial-title"><i class="fas fa-percent"></i> ملاحظة</div><p class="text-sm text-gray-700">هذا التقرير يعرض تفاصيل المقبوضات التي تم تحديدها لتدخل في نسبة المحصل. يمكنك تغيير نسبة العمولة من القائمة الجانبية.</p></div>
                        <table class="w-full text-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>العميل</th>
                                    <th class="font-mono">الفاتورة</th>
                                    <th class="font-mono">المبلغ المحصل</th>
                                    <th class="font-mono">العمولة (${commissionRate}%)</th>
                                    <th>البيان</th>
                                </tr>
                            </thead>
                            <tbody>`;

            collectorReceipts.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(r => {
                totalCollected += r.amount;
                totalCommission += r.commission;
                html += `<tr>
                            <td>${r.date}</td>
                            <td>${sanitizeHTML(r.customerName)}</td>
                            <td class="font-mono">#${r.invoiceId.slice(-6)}</td>
                            <td class="font-mono">${formatCurrency(r.amount)}</td>
                            <td class="font-mono font-bold text-green-600">${formatCurrency(r.commission)}</td>
                            <td>${sanitizeHTML(r.desc || '')}</td>
                         </tr>`;
            });

            html += `</tbody><tfoot>
                        <tr>
                            <td colspan="3"><strong>الإجمالي العام</strong></td>
                            <td class="font-mono">${formatCurrency(totalCollected)}</td>
                            <td class="font-mono font-bold text-green-600">${formatCurrency(totalCommission)}</td>
                            <td></td>
                        </tr>
                     </tfoot></table>`;

            renderReportWithHeader(container, `تقرير مقبوضات المحصل التفصيلي (${commissionRate}%)`, html, fromDate, toDate);
        }

        function renderReceiptsAndPaymentsSummary(container, fromDate, toDate) {
            const filterByDate = (payment) => {
                const d = new Date(payment.date);
                return d >= fromDate && d <= toDate;
            };

            const allReceipts = db.invoices.flatMap(inv => 
                (inv.payments || []).map(p => ({...p, customerName: inv.customerName, invoiceId: inv.id}))
            ).filter(filterByDate);

            const allPayments = db.purchases.flatMap(p => 
                (p.payments || []).map(payment => ({...payment, supplierName: p.supplierName, purchaseId: p.id}))
            ).filter(filterByDate);

            const totalReceipts = allReceipts.reduce((sum, r) => sum + r.amount, 0);
            const totalPayments = allPayments.reduce((sum, p) => sum + p.amount, 0);
            const netFlow = totalReceipts - totalPayments;

            let html = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="summary-card border-green-500"><p class="text-sm text-gray-500 mb-1">إجمالي المقبوضات</p><span class="text-2xl font-bold text-green-600">${formatCurrency(totalReceipts)}</span></div>
                    <div class="summary-card border-red-500"><p class="text-sm text-gray-500 mb-1">إجمالي المدفوعات</p><span class="text-2xl font-bold text-red-600">${formatCurrency(totalPayments)}</span></div>
                    <div class="summary-card ${netFlow >= 0 ? 'border-blue-500' : 'border-orange-500'}"><p class="text-sm text-gray-500 mb-1">صافي التدفق النقدي</p><span class="text-2xl font-bold ${netFlow >= 0 ? 'text-blue-600' : 'text-orange-600'}">${formatCurrency(netFlow)}</span></div>
                </div>
            `;

            html += `<h4 class="font-semibold mt-6 mb-2 text-green-700">تفاصيل المقبوضات (${allReceipts.length})</h4>`;
            if (allReceipts.length > 0) {
                html += `<table class="w-full text-sm table-bordered"><thead><tr><th>التاريخ</th><th>العميل</th><th class="font-mono">الفاتورة</th><th class="font-mono">المبلغ</th><th>البيان</th></tr></thead><tbody>`;
                allReceipts.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(r => { html += `<tr><td>${r.date}</td><td>${sanitizeHTML(r.customerName)}</td><td class="font-mono">#${r.invoiceId.slice(-6)}</td><td class="font-mono">${formatCurrency(r.amount)}</td><td>${sanitizeHTML(r.desc)}</td></tr>`; });
                html += `</tbody></table>`;
            } else { html += `<p class="text-center text-gray-500 py-4">لا توجد مقبوضات في الفترة المحددة.</p>`; }

            html += `<h4 class="font-semibold mt-6 mb-2 text-red-700">تفاصيل المدفوعات (${allPayments.length})</h4>`;
            if (allPayments.length > 0) {
                html += `<table class="w-full text-sm table-bordered"><thead><tr><th>التاريخ</th><th>المورد</th><th class="font-mono">الفاتورة</th><th class="font-mono">المبلغ</th><th>البيان</th></tr></thead><tbody>`;
                allPayments.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(p => { html += `<tr><td>${p.date}</td><td>${sanitizeHTML(p.supplierName)}</td><td class="font-mono">#${p.purchaseId.slice(-6)}</td><td class="font-mono">${formatCurrency(p.amount)}</td><td>${sanitizeHTML(p.desc)}</td></tr>`; });
                html += `</tbody></table>`;
            } else { html += `<p class="text-center text-gray-500 py-4">لا توجد مدفوعات في الفترة المحددة.</p>`; }

            renderReportWithHeader(container, 'ملخص المقبوضات والمدفوعات', html, fromDate, toDate);
        }

        function renderIncomeStatement(container, fromDate, toDate) {
            const periodChanges = {};
            db.chart.forEach(acc => {
                if (acc.type === 'income' || acc.type === 'expense') {
                    periodChanges[acc.no] = { name: acc.name, type: acc.type, total: 0, no: acc.no };
                }
            });

            db.journal.filter(j => {
                const d = new Date(j.date);
                return d >= fromDate && d <= toDate;
            }).forEach(entry => {
                if (periodChanges[entry.credit]) {
                    if (periodChanges[entry.credit].type === 'income') periodChanges[entry.credit].total += entry.amount;
                    else if (periodChanges[entry.credit].type === 'expense') periodChanges[entry.credit].total -= entry.amount;
                }
                if (periodChanges[entry.debit]) {
                    if (periodChanges[entry.debit].type === 'expense') periodChanges[entry.debit].total += entry.amount;
                    else if (periodChanges[entry.debit].type === 'income') periodChanges[entry.debit].total -= entry.amount;
                }
            });

            const revenues = Object.values(periodChanges).filter(acc => acc.type === 'income' && acc.total !== 0);
            const expenses = Object.values(periodChanges).filter(acc => acc.type === 'expense' && acc.total !== 0);

            const cogsAccountNo = db.settings.accountingLinks.cogs;
            const cogs = expenses.find(exp => exp.no === cogsAccountNo) || { name: 'تكلفة البضاعة المباعة', total: 0 };
            const otherExpenses = expenses.filter(exp => exp.no !== cogsAccountNo);

            const totalRevenue = revenues.reduce((sum, acc) => sum + acc.total, 0);
            const totalCogs = cogs.total;
            const grossProfit = totalRevenue - totalCogs;
            const totalOtherExpenses = otherExpenses.reduce((sum, acc) => sum + acc.total, 0);
            const netProfit = grossProfit - totalOtherExpenses;

            let html = `<table class="w-full text-sm table-bordered">`;

            html += `<thead><tr><th colspan="2" class="text-lg !text-right">الإيرادات</th></tr></thead><tbody>`;
            revenues.forEach(rev => { html += `<tr><td class="pl-8">${sanitizeHTML(rev.name)}</td><td class="font-mono">${formatCurrency(rev.total)}</td></tr>`; });
            html += `<tr class="font-bold bg-slate-100"><td>إجمالي الإيرادات</td><td class="font-mono">${formatCurrency(totalRevenue)}</td></tr>`;
            
            html += `<tr><td class="pl-4">(-) تكلفة البضاعة المباعة</td><td class="font-mono text-red-600">${formatCurrency(totalCogs)}</td></tr>`;
            html += `<tr class="font-bold bg-slate-200 text-base"><td>إجمالي الربح</td><td class="font-mono">${formatCurrency(grossProfit)}</td></tr>`;
            
            html += `<tr><td colspan="2" class="bg-white !border-0 h-4"></td></tr>`;

            html += `<thead><tr><th colspan="2" class="text-lg !text-right">المصروفات</th></tr></thead>`;
            otherExpenses.forEach(exp => { html += `<tr><td class="pl-8">${sanitizeHTML(exp.name)}</td><td class="font-mono text-red-600">${formatCurrency(exp.total)}</td></tr>`; });
            html += `<tr class="font-bold bg-slate-100"><td>إجمالي المصروفات</td><td class="font-mono text-red-600">${formatCurrency(totalOtherExpenses)}</td></tr>`;

            const netProfitClass = netProfit >= 0 ? 'text-green-600' : 'text-red-600';
            html += `<tr class="font-bold bg-blue-100 text-lg"><td class="!border-t-2 !border-slate-400">صافي الربح / (الخسارة)</td><td class="font-mono !border-t-2 !border-slate-400 ${netProfitClass}">${formatCurrency(netProfit)}</td></tr>`;

            html += `</tbody></table>`;
            renderReportWithHeader(container, 'قائمة الدخل (الأرباح والخسائر)', html, fromDate, toDate);
        }

        function renderIncomeStatement(container, fromDate, toDate) {
            const periodChanges = {};
            db.chart.forEach(acc => {
                if (acc.type === 'income' || acc.type === 'expense') {
                    periodChanges[acc.no] = { name: acc.name, type: acc.type, total: 0, no: acc.no };
                }
            });

            db.journal.filter(j => {
                const d = new Date(j.date);
                return d >= fromDate && d <= toDate;
            }).forEach(entry => {
                if (periodChanges[entry.credit]) {
                    if (periodChanges[entry.credit].type === 'income') periodChanges[entry.credit].total += entry.amount;
                    else if (periodChanges[entry.credit].type === 'expense') periodChanges[entry.credit].total -= entry.amount;
                }
                if (periodChanges[entry.debit]) {
                    if (periodChanges[entry.debit].type === 'expense') periodChanges[entry.debit].total += entry.amount;
                    else if (periodChanges[entry.debit].type === 'income') periodChanges[entry.debit].total -= entry.amount;
                }
            });

            const revenues = Object.values(periodChanges).filter(acc => acc.type === 'income' && acc.total !== 0);
            const expenses = Object.values(periodChanges).filter(acc => acc.type === 'expense' && acc.total !== 0);

            const cogsAccountNo = db.settings.accountingLinks.cogs;
            const cogs = expenses.find(exp => exp.no === cogsAccountNo) || { name: 'تكلفة البضاعة المباعة', total: 0 };
            const otherExpenses = expenses.filter(exp => exp.no !== cogsAccountNo);

            const totalRevenue = revenues.reduce((sum, acc) => sum + acc.total, 0);
            const totalCogs = cogs.total;
            const grossProfit = totalRevenue - totalCogs;
            const totalOtherExpenses = otherExpenses.reduce((sum, acc) => sum + acc.total, 0);
            const netProfit = grossProfit - totalOtherExpenses;

            let html = `<table class="w-full text-sm table-bordered">`;

            html += `<thead><tr><th colspan="2" class="text-lg !text-right">الإيرادات</th></tr></thead><tbody>`;
            revenues.forEach(rev => { html += `<tr><td class="pl-8">${sanitizeHTML(rev.name)}</td><td class="font-mono">${formatCurrency(rev.total)}</td></tr>`; });
            html += `<tr class="font-bold bg-slate-100"><td>إجمالي الإيرادات</td><td class="font-mono">${formatCurrency(totalRevenue)}</td></tr>`;
            
            html += `<tr><td class="pl-4">(-) تكلفة البضاعة المباعة</td><td class="font-mono text-red-600">${formatCurrency(totalCogs)}</td></tr>`;
            html += `<tr class="font-bold bg-slate-200 text-base"><td>إجمالي الربح</td><td class="font-mono">${formatCurrency(grossProfit)}</td></tr>`;
            
            html += `<tr><td colspan="2" class="bg-white !border-0 h-4"></td></tr>`;

            html += `<thead><tr><th colspan="2" class="text-lg !text-right">المصروفات</th></tr></thead>`;
            otherExpenses.forEach(exp => { html += `<tr><td class="pl-8">${sanitizeHTML(exp.name)}</td><td class="font-mono text-red-600">${formatCurrency(exp.total)}</td></tr>`; });
            html += `<tr class="font-bold bg-slate-100"><td>إجمالي المصروفات</td><td class="font-mono text-red-600">${formatCurrency(totalOtherExpenses)}</td></tr>`;

            const netProfitClass = netProfit >= 0 ? 'text-green-600' : 'text-red-600';
            html += `<tr class="font-bold bg-blue-100 text-lg"><td class="!border-t-2 !border-slate-400">صافي الربح / (الخسارة)</td><td class="font-mono !border-t-2 !border-slate-400 ${netProfitClass}">${formatCurrency(netProfit)}</td></tr>`;

            html += `</tbody></table>`;
            renderReportWithHeader(container, 'قائمة الدخل (الأرباح والخسائر)', html, fromDate, toDate);
        }

        function renderDiscountsAndBonusReport(container, fromDate, toDate) {
            const invoices = db.invoices.filter(inv => {
                const d = new Date(inv.date);
                return d >= fromDate && d <= toDate;
            });

            // 1. Calculate Gross Sales, Discounts, COGS, and Bonus Cost from invoices
            let grossSales = 0;
            let totalDiscounts = 0;
            let bonusCost = 0;
            let cogs = 0;

            invoices.forEach(inv => {
                totalDiscounts += (inv.discount || 0);
                inv.items.forEach(item => {
                    const stockItem = db.items.find(i => i.id === item.id);
                    const itemCost = stockItem ? (stockItem.purchasePrice || 0) : 0;
                    
                    grossSales += item.qty * item.price;

                    if (item.isBonus) {
                        bonusCost += item.qty * itemCost;
                    } else {
                        cogs += item.qty * itemCost;
                    }
                });
            });

            const netSales = grossSales - totalDiscounts;

            // 2. Calculate total "other" expenses from the journal
            const periodJournal = db.journal.filter(j => {
                const d = new Date(j.date);
                return d >= fromDate && d <= toDate;
            });

            const expenseAccounts = new Set(db.chart.filter(a => a.type === 'expense').map(a => a.no));
            const excludedExpenseAccounts = new Set([
                db.settings.accountingLinks.cogs,
                db.settings.accountingLinks.salesDiscount,
                db.settings.accountingLinks.bonusExpense,
                db.settings.accountingLinks.samplesExpense
            ]);

            let otherExpenses = 0;
            periodJournal.forEach(entry => {
                if (expenseAccounts.has(entry.debit) && !excludedExpenseAccounts.has(entry.debit)) {
                    otherExpenses += entry.amount;
                }
                if (expenseAccounts.has(entry.credit) && !excludedExpenseAccounts.has(entry.credit)) {
                    otherExpenses -= entry.amount;
                }
            });

            // 3. Calculate Net Profit
            const totalCostsAndExpenses = cogs + bonusCost + totalDiscounts + otherExpenses;
            const netProfit = netSales - totalCostsAndExpenses;

            // 4. Build the report table
            let html = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <table class="w-full text-sm table-bordered">
                        <tbody>
                            <tr><td class="font-bold">إجمالي المبيعات (قبل الخصم)</td><td class="font-mono">${formatCurrency(grossSales)}</td></tr>
                            <tr><td class="pl-8">(-) إجمالي الخصومات النقدية</td><td class="font-mono text-red-600">(${formatCurrency(totalDiscounts)})</td></tr>
                            <tr class="bg-slate-100"><td class="font-bold">صافي المبيعات</td><td class="font-mono font-bold">${formatCurrency(netSales)}</td></tr>
                            <tr><td colspan="2" class="bg-white !border-0 h-4"></td></tr>
                            <tr><td class="pl-8">(-) تكلفة البضاعة المباعة</td><td class="font-mono text-red-600">(${formatCurrency(cogs)})</td></tr>
                            <tr><td class="pl-8">(-) القيمة التكليفية للبونص</td><td class="font-mono text-red-600">(${formatCurrency(bonusCost)})</td></tr>
                            <tr><td class="pl-8">(-) المصروفات الأخرى</td><td class="font-mono text-red-600">(${formatCurrency(otherExpenses)})</td></tr>
                            <tr class="font-bold bg-blue-100 text-lg"><td class="!border-t-2 !border-slate-400">صافي الربح</td><td class="font-mono font-bold ${netProfit >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(netProfit)}</td></tr>
                        </tbody>
                    </table>
                </div>
                <div><canvas id="discountBonusChart"></canvas></div>
            </div>
            <div class="tutorial-box mt-6"><div class="tutorial-title"><i class="fas fa-info-circle"></i> تحليل التقرير</div><p class="text-sm text-gray-700">هذا التقرير يساعد على فهم تكلفة الحوافز البيعية. قارن بين <strong>إجمالي الخصومات</strong> و <strong>تكلفة البونص</strong> وبين <strong>صافي الربح</strong>. إذا كانت تكلفة الحوافز مرتفعة مقارنة بالربح، قد تحتاج لمراجعة سياسات التسعير والترويج.</p></div>`;

            renderReportWithHeader(container, 'تقرير تحليلي للخصومات والبونص', html, fromDate, toDate);

            // Render Chart
            const ctx = $('#discountBonusChart')?.getContext('2d');
            if (ctx) {
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['صافي الربح', 'تكلفة البضاعة', 'تكلفة البونص', 'الخصومات', 'مصروفات أخرى'],
                        datasets: [{
                            data: [netProfit, cogs, bonusCost, totalDiscounts, otherExpenses].map(v => Math.max(0, v)),
                            backgroundColor: ['#22c55e', '#f97316', '#f59e0b', '#ef4444', '#64748b'],
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'توزيع صافي المبيعات' } } }
                });
            }
        }

        function renderSamplesReport(container, fromDate, toDate) {
            const disbursements = db.inventoryDisbursements.filter(d => {
                const date = new Date(d.date);
                return date >= fromDate && date <= toDate;
            });

            if (disbursements.length === 0) {
                renderReportWithHeader(container, 'تقرير العينات والصرف المخزني', '<p class="text-center text-gray-500 p-10">لا توجد أوامر صرف في الفترة المحددة.</p>', fromDate, toDate);
                return;
            }

            let totalCost = 0;
            let html = `<table class="w-full text-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>البيان / الغرض</th>
                                    <th>الأصناف المصروفة</th>
                                </tr>
                            </thead>
                            <tbody>`;

            disbursements.forEach(d => {
                let itemsHtml = '<ul class="list-disc list-inside text-xs">';
                d.items.forEach(item => {
                    itemsHtml += `<li>${sanitizeHTML(item.name)} (الكمية: ${item.qty})</li>`;
                });
                itemsHtml += '</ul>';

                html += `<tr><td>${d.date}</td><td>${sanitizeHTML(d.notes)}</td><td>${itemsHtml}</td></tr>`;
            });

            html += `</tbody></table>`;
            renderReportWithHeader(container, 'تقرير العينات والصرف المخزني', html, fromDate, toDate);
        }

        function renderBalanceSheet(container, asOfDate) {
            const balances = getBalancesAsOf(asOfDate);

            const assets = [];
            const liabilities = [];
            const equity = [];
            let totalRevenue = 0;
            let totalExpense = 0;

            for (const accNo in balances) {
                const item = balances[accNo];
                if (['asset', 'cash', 'receivable'].includes(item.acc.type)) {
                    assets.push(item);
                } else if (['liability', 'payable'].includes(item.acc.type)) {
                    liabilities.push(item);
                } else if (item.acc.type === 'equity') {
                    equity.push(item);
                } else if (item.acc.type === 'income') {
                    totalRevenue += item.balance;
                } else if (item.acc.type === 'expense') {
                    totalExpense += item.balance;
                }
            }

            const netProfit = totalRevenue - totalExpense;
            equity.push({ acc: { name: 'صافي الربح / (الخسارة) للفترة' }, balance: netProfit });

            const totalAssets = assets.reduce((sum, acc) => sum + acc.balance, 0);
            const totalLiabilities = liabilities.reduce((sum, acc) => sum + acc.balance, 0);
            const totalEquity = equity.reduce((sum, acc) => sum + acc.balance, 0);
            const totalLiabilitiesAndEquity = totalLiabilities + totalEquity;

            let html = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">`;

            // Assets Column
            html += `<div><table class="w-full text-sm table-bordered">
                        <thead><tr><th colspan="2" class="text-lg !text-right">الأصول</th></tr></thead>
                        <tbody>`;
            assets.forEach(acc => { html += `<tr><td class="pl-8">${sanitizeHTML(acc.acc.name)}</td><td class="font-mono">${formatCurrency(acc.balance)}</td></tr>`; });
            html += `</tbody><tfoot><tr class="font-bold bg-slate-200 text-base"><td>إجمالي الأصول</td><td class="font-mono">${formatCurrency(totalAssets)}</td></tr></tfoot></table></div>`;

            // Liabilities & Equity Column
            html += `<div><table class="w-full text-sm table-bordered">
                        <thead><tr><th colspan="2" class="text-lg !text-right">الالتزامات وحقوق الملكية</th></tr></thead>
                        <tbody>
                        <tr><td colspan="2" class="font-bold bg-slate-100">الالتزامات</td></tr>`;
            liabilities.forEach(acc => { html += `<tr><td class="pl-8">${sanitizeHTML(acc.acc.name)}</td><td class="font-mono">${formatCurrency(acc.balance)}</td></tr>`; });
            html += `<tr class="font-bold bg-slate-100"><td>إجمالي الالتزامات</td><td class="font-mono">${formatCurrency(totalLiabilities)}</td></tr>`;
            html += `<tr><td colspan="2" class="bg-white !border-0 h-4"></td></tr>`;
            html += `<tr><td colspan="2" class="font-bold bg-slate-100">حقوق الملكية</td></tr>`;
            equity.forEach(acc => { html += `<tr><td class="pl-8">${sanitizeHTML(acc.acc.name)}</td><td class="font-mono">${formatCurrency(acc.balance)}</td></tr>`; });
            html += `<tr class="font-bold bg-slate-100"><td>إجمالي حقوق الملكية</td><td class="font-mono">${formatCurrency(totalEquity)}</td></tr>`;
            html += `</tbody><tfoot><tr class="font-bold bg-slate-200 text-base"><td>إجمالي الالتزامات وحقوق الملكية</td><td class="font-mono">${formatCurrency(totalLiabilitiesAndEquity)}</td></tr></tfoot></table></div>`;
            html += `</div>`;

            const balanceDifference = totalAssets - totalLiabilitiesAndEquity;
            if (Math.abs(balanceDifference) > 0.01) {
                html += `<div class="mt-4 p-4 bg-red-100 border-l-4 border-red-500 text-red-700"><p class="font-bold">تحذير: الميزانية غير متوازنة!</p><p>الفرق: ${formatCurrency(balanceDifference)}</p></div>`;
            }

            renderReportWithHeader(container, 'الميزانية العمومية', html, null, asOfDate);
        }

        function renderStatementOfCashFlows(container, fromDate, toDate) {
            const cashAccounts = db.chart.filter(a => a.type === 'cash').map(a => a.no);
            if (cashAccounts.length === 0) {
                renderReportWithHeader(container, 'قائمة التدفقات النقدية', `<p class="text-center text-red-500 p-10">الرجاء تحديد حساب واحد على الأقل من نوع "صندوق/نقدية" في الدليل المحاسبي.</p>`, fromDate, toDate);
                return;
            }

            const beginningDate = new Date(fromDate);
            beginningDate.setDate(beginningDate.getDate() - 1);
            const beginningBalances = getBalancesAsOf(beginningDate);
            const cashAtBeginning = cashAccounts.reduce((sum, accNo) => sum + (beginningBalances[accNo]?.balance || 0), 0);

            let cashFromCustomers = 0;
            let cashToSuppliers = 0;
            let cashForExpenses = 0;
            let cashFromEquity = 0;
            let otherInflows = 0;
            let otherOutflows = 0;

            const periodJournal = db.journal.filter(j => {
                const d = new Date(j.date);
                return d >= fromDate && d <= toDate;
            });

            periodJournal.forEach(entry => {
                const debitAcc = db.chart.find(a => a.no === entry.debit);
                const creditAcc = db.chart.find(a => a.no === entry.credit);

                if (cashAccounts.includes(entry.debit)) { // Cash In
                    if (creditAcc?.type === 'receivable') cashFromCustomers += entry.amount;
                    else if (creditAcc?.type === 'equity') cashFromEquity += entry.amount;
                    else otherInflows += entry.amount;
                } else if (cashAccounts.includes(entry.credit)) { // Cash Out
                    if (debitAcc?.type === 'payable') cashToSuppliers += entry.amount;
                    else if (debitAcc?.type === 'expense') cashForExpenses += entry.amount;
                    else otherOutflows += entry.amount;
                }
            });

            const netOperating = cashFromCustomers - cashToSuppliers - cashForExpenses;
            const netFinancing = cashFromEquity;
            const netOther = otherInflows - otherOutflows;

            const netChangeInCash = netOperating + netFinancing + netOther;
            const cashAtEnd = cashAtBeginning + netChangeInCash;

            let html = `<table class="w-full text-sm table-bordered">`;
            html += `<thead><tr><th colspan="2" class="text-lg !text-right">التدفقات النقدية من الأنشطة التشغيلية</th></tr></thead><tbody>`;
            html += `<tr><td class="pl-8">المقبوضات النقدية من العملاء</td><td class="font-mono">${formatCurrency(cashFromCustomers)}</td></tr>`;
            html += `<tr><td class="pl-8">المدفوعات النقدية للموردين</td><td class="font-mono text-red-600">(${formatCurrency(cashToSuppliers)})</td></tr>`;
            html += `<tr><td class="pl-8">المدفوعات النقدية للمصروفات</td><td class="font-mono text-red-600">(${formatCurrency(cashForExpenses)})</td></tr>`;
            html += `<tr class="font-bold bg-slate-100"><td>صافي النقدية من الأنشطة التشغيلية</td><td class="font-mono">${formatCurrency(netOperating)}</td></tr>`;
            html += `<tr><td colspan="2" class="bg-white !border-0 h-4"></td></tr>`;
            html += `<thead><tr><th colspan="2" class="text-lg !text-right">التدفقات النقدية من الأنشطة التمويلية</th></tr></thead><tbody>`;
            html += `<tr><td class="pl-8">مساهمات رأس المال</td><td class="font-mono">${formatCurrency(cashFromEquity)}</td></tr>`;
            html += `<tr class="font-bold bg-slate-100"><td>صافي النقدية من الأنشطة التمويلية</td><td class="font-mono">${formatCurrency(netFinancing)}</td></tr>`;
            html += `<tr><td colspan="2" class="bg-white !border-0 h-4"></td></tr>`;
            if (Math.abs(netOther) > 0.01) {
                html += `<thead><tr><th colspan="2" class="text-lg !text-right">التدفقات النقدية الأخرى</th></tr></thead><tbody>`;
                html += `<tr><td class="pl-8">تدفقات نقدية أخرى</td><td class="font-mono">${formatCurrency(netOther)}</td></tr>`;
                html += `<tr><td colspan="2" class="bg-white !border-0 h-4"></td></tr>`;
            }
            html += `<tr class="font-bold bg-slate-200 text-base"><td>صافي الزيادة / (النقص) في النقدية</td><td class="font-mono">${formatCurrency(netChangeInCash)}</td></tr>`;
            html += `<tr class="font-bold bg-slate-100 text-base"><td>النقدية في بداية الفترة</td><td class="font-mono">${formatCurrency(cashAtBeginning)}</td></tr>`;
            const cashAtEndClass = cashAtEnd >= 0 ? 'text-green-600' : 'text-red-600';
            html += `<tr class="font-bold bg-blue-100 text-lg"><td class="!border-t-2 !border-slate-400">النقدية في نهاية الفترة</td><td class="font-mono !border-t-2 !border-slate-400 ${cashAtEndClass}">${formatCurrency(cashAtEnd)}</td></tr>`;
            html += `</tbody></table>`;
            renderReportWithHeader(container, 'قائمة التدفقات النقدية', html, fromDate, toDate);
        }

        function resetSystem() {
            if (confirm('هل أنت متأكد؟ سيتم مسح جميع البيانات واستبدالها ببيانات افتراضية.')) {
                db = JSON.parse(JSON.stringify(emptyDB));
                db.chart = [...presetChart];
                db.settings.accountingLinks = {...presetLinks};
                saveDB();
                renderAll();
                showAlert('تم تهيئة النظام بنجاح');
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadDB();
            $('#settingCompanyLogo').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    db.settings.companyLogo = event.target.result;
                    $('#logoPreview').src = db.settings.companyLogo;
                    $('#logoPreview').classList.remove('hidden');
                    saveDB();
                    showAlert('تم حفظ الشعار بنجاح.');
                };
                reader.readAsDataURL(file);
            });

            renderAll(); // Renders everything on initial load
            initializeReports();
            setupEventListeners();
            // Trigger the first main tab to show content on load
            $('#main-nav .nav-tab').click();
        });
    </script>
</body>
</html>
